<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEHSA Interactive Hazard Map - Development</title>
    
    <!-- Load CesiumJS from CDN -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <!-- Load html3pdf for PDF export (fixes blank page issues) -->
    <script src="https://cdn.jsdelivr.net/npm/html3pdf@latest/dist/html3pdf.bundle.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            display: none;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .main-content {
            position: relative;
            flex: 1;
            height: calc(100vh - 80px - 25vh);
        }


        .sidebar-section {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25vh;
            background-color: #f8f9fa;
            border-top: 3px solid black;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            width: 100%;
            height: 50px;
            background: linear-gradient(to right, 
                #ff6600 0%,     /* Orange */
                #ffcc00 25%,    /* Yellow */
                #90ee90 50%,    /* Light Green */
                #32cd32 75%,    /* Green */
                #20b2aa 100%    /* Teal */
            );
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-bottom: 2px solid #333;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: bold;
            color: black;
        }

        .sidebar-content {
            flex: 1;
            padding: 1rem;
            overflow-x: auto;
            overflow-y: auto;
            color: #333;
            font-size: 1rem;
        }

        /* CSM Form Styles */
        .csm-form-table-wrapper {
            max-height: calc(50vh - 100px);
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
            cursor: pointer;
        }

        .csm-form-table-wrapper:hover {
            border-color: #007bff;
        }

        .csm-form-table-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .csm-form-table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .csm-form-table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .csm-form-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Allow more height when there are only 2 rows */
        .csm-form-table-wrapper.show-all {
            max-height: calc(50vh - 80px);
        }

        .csm-form-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            margin-bottom: 0;
            font-size: 14px;
        }

        .csm-form-table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px 6px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            color: #495057;
        }

        .csm-form-table td {
            border: 1px solid #dee2e6;
            padding: 6px;
            vertical-align: top;
            position: relative;
            z-index: 50;
        }

        .csm-form-table select {
            width: 100%;
            min-width: 80px;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 3px;
            outline: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            z-index: 1000;
        }

        .csm-form-table select:focus {
            background-color: #e3f2fd;
        }

        .csm-form-table td:last-child select {
            min-width: 100px;
        }

        /* Ensure dropdown options appear above everything */
        .csm-form-table select option {
            z-index: 9999 !important;
            position: relative;
        }

        .csm-form-actions {
            padding: 1rem;
            background-color: #e9ecef;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .csm-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .csm-btn-primary {
            background-color: #007bff;
            color: white;
        }

        .csm-btn-primary:hover {
            background-color: #0056b3;
        }

        .csm-btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .csm-btn-secondary:hover {
            background-color: #545b62;
        }

        .csm-btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .csm-btn-danger:hover {
            background-color: #c82333;
        }

        .csm-btn-success {
            background-color: #28a745;
            color: white;
        }

        .csm-btn-success:hover {
            background-color: #218838;
        }

        .control-panel {
            display: none;
        }

        .panel-section {
            margin-bottom: 2rem;
        }

        .panel-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group h4 {
            color: #34495e;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.1);
        }

        .filter-controls {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .hazard-count {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }

        .map-container {
            flex: 1;
            position: relative;
            background-color: #2c3e50;
            height: 100%;
        }

        .cesium-container {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            display: none;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-btn:hover {
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e74c3c;
        }

        .error-message button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .info-panel.hidden {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }

        /* Hover Information Bubble */
        .info-bubble {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-bubble.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        .bubble-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .bubble-type {
            font-weight: bold;
            color: #4CAF50;
        }

        .bubble-severity {
            color: #FFC107;
            font-size: 11px;
        }

        /* Click Info Box Styles */
        .click-info-box {
            position: absolute;
            background: white;
            border: 4px solid black;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 400px;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
        }

        /* Severity Gradient Bar - Now the title bar */
        .severity-gradient-bar {
            width: 100%;
            height: 50px;
            background: linear-gradient(to right, 
                #ff6600 0%,     /* Orange */
                #ffcc00 25%,    /* Yellow */
                #90ee90 50%,    /* Light Green */
                #32cd32 75%,    /* Green */
                #20b2aa 100%    /* Teal */
            );
            border-radius: 6px 6px 0 0;
            border: 1px solid #333;
            border-bottom: 2px solid white;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-sizing: border-box;
        }

        .gradient-title {
            color: black;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .gradient-close-btn {
            background: none;
            border: none;
            color: black;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .gradient-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Navigation Controls */
        .info-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            width: 35px;
            height: 35px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background: #0056b3;
        }

        .nav-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .hazard-counter {
            font-weight: bold;
            color: #495057;
            font-size: 14px;
        }

        /* Help Icon Styles */
        .help-icon {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .help-icon:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        .help-symbol {
            color: white;
            font-size: 24px;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }

        .help-tooltip {
            position: absolute;
            bottom: 60px;
            left: 0;
            background-color: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .help-icon:hover .help-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .help-tooltip h4 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 16px;
            font-weight: bold;
        }

        .help-tooltip ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
        }

        .help-tooltip li {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .help-tooltip li strong {
            color: #007bff;
        }

        .severity-gradient-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: #333;
        }


        .click-info-box.hidden {
            display: none;
        }


        .info-box-content {
            padding: 16px;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .info-label {
            font-weight: bold;
            color: #333;
            min-width: 120px;
            margin-right: 8px;
        }

        .info-row span:last-child {
            color: #666;
            flex: 1;
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #3498db;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .info-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .info-content {
            padding: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-item label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 120px;
        }

        .info-item span {
            color: #7f8c8d;
            text-align: right;
        }

        .info-bubble {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1500;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .info-bubble.hidden {
            display: none;
        }

        .bubble-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .legend {
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
            border-radius: 2px;
            border: 1px solid #ddd;
        }

        .legend-text {
            flex: 1;
        }

        .hidden {
            display: none !important;
        }

        /* Cesium Overrides */
        .cesium-widget-credits {
            display: none !important;
        }

        .cesium-viewer-bottom {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <h1>OEHSA Interactive Hazard Map</h1>
            <p>Environmental Hazard Analysis Training Module with Google Photorealistic 3D Tiles via Cesium Ion</p>
        </header>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel" id="controlPanel">
                <div class="panel-section">
                    <h3>Hazard Filters</h3>
                    
                    <!-- Hazard Type Filter -->
                    <div class="filter-group">
                        <h4>Hazard Type</h4>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="chemical" data-filter="hazard-type" checked> Chemical</label>
                            <label><input type="checkbox" value="biological" data-filter="hazard-type" checked> Biological</label>
                            <label><input type="checkbox" value="radiological" data-filter="hazard-type" checked> Radiological</label>
                            <label><input type="checkbox" value="nuclear" data-filter="hazard-type" checked> Nuclear</label>
                            <label><input type="checkbox" value="environmental" data-filter="hazard-type" checked> Environmental</label>
                            <label><input type="checkbox" value="physical" data-filter="hazard-type" checked> Physical</label>
                        </div>
                    </div>

                    <!-- Environmental Medium Filter -->
                    <div class="filter-group">
                        <h4>Environmental Medium</h4>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="air" data-filter="environmental-medium" checked> Air</label>
                            <label><input type="checkbox" value="water" data-filter="environmental-medium" checked> Water</label>
                            <label><input type="checkbox" value="soil" data-filter="environmental-medium" checked> Soil</label>
                            <label><input type="checkbox" value="groundwater" data-filter="environmental-medium" checked> Groundwater</label>
                        </div>
                    </div>

                    <!-- Severity Filter -->
                    <div class="filter-group">
                        <h4>Severity Level</h4>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="1" data-filter="severity-level" checked> Level 1</label>
                            <label><input type="checkbox" value="2" data-filter="severity-level" checked> Level 2</label>
                            <label><input type="checkbox" value="3" data-filter="severity-level" checked> Level 3</label>
                            <label><input type="checkbox" value="4" data-filter="severity-level" checked> Level 4</label>
                            <label><input type="checkbox" value="5" data-filter="severity-level" checked> Level 5</label>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <button id="clearFilters" class="btn btn-secondary">Clear All Filters</button>
                        <button id="selectAll" class="btn btn-secondary">Select All</button>
                        <div class="hazard-count">
                            <span id="hazardCount">0</span> hazards visible
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="panel-section">
                    <h3>Legend</h3>
                    <div id="legend" class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FFD700;"></div>
                            <div class="legend-text">Chemical</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #32CD32;"></div>
                            <div class="legend-text">Biological</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF8C00;"></div>
                            <div class="legend-text">Radiological</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF0000;"></div>
                            <div class="legend-text">Nuclear</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #4169E1;"></div>
                            <div class="legend-text">Environmental</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #8A2BE2;"></div>
                            <div class="legend-text">Physical</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="cesiumContainer" class="cesium-container"></div>
                
                <!-- Map Controls -->
                <div class="map-controls">
                    <button id="zoomIn" class="control-btn" title="Zoom In">+</button>
                    <button id="zoomOut" class="control-btn" title="Zoom Out">-</button>
                    <button id="resetView" class="control-btn" title="Reset View">‚åÇ</button>
                    <button id="flyToDenver" class="control-btn" title="Fly to Denver">üèîÔ∏è</button>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Loading Google Photorealistic 3D Tiles...</p>
                    <p>This may take a moment...</p>
                </div>
            </div>

        </div>

        <!-- Sidebar Section -->
        <div class="sidebar-section">
            <div class="sidebar-header">
                <h2>CSM Spreadsheet</h2>
            </div>
            <div class="sidebar-content">
                <div class="csm-form-table-wrapper">
                    <table class="csm-form-table">
                    <thead>
                        <tr>
                            <th style="width: 6%;">Hazard ID</th>
                            <th style="width: 10%;">Source</th>
                            <th style="width: 10%;">Environmental Medium</th>
                            <th style="width: 8%;">Health Threat</th>
                            <th style="width: 8%;">Exposure Route</th>
                            <th style="width: 10%;">Population Affected</th>
                            <th style="width: 10%;">Existing Controls</th>
                            <th style="width: 10%;">Frequency/Duration</th>
                            <th style="width: 6%;">Severity</th>
                            <th style="width: 6%;">Probability</th>
                            <th style="width: 16%;">Risk</th>
                        </tr>
                    </thead>
                    <tbody id="csmFormBody">
                        <!-- Rows will be dynamically added here -->
                    </tbody>
                </table>
                </div>
            </div>
            <div class="csm-form-actions">
                <button class="csm-btn csm-btn-primary" id="addHazardRow">Add Hazard</button>
                <button class="csm-btn csm-btn-secondary" id="clearForm">Clear All</button>
                <button class="csm-btn csm-btn-primary" id="riskLevelOrder">Risk Level Order</button>
                <button class="csm-btn csm-btn-danger" id="riskMatrix">Risk Matrix</button>
            </div>
        </div>

        <!-- Information Panel -->
        <div id="infoPanel" class="info-panel hidden">
            <div class="info-header">
                <h3 id="infoTitle">Hazard Information</h3>
                <button id="closeInfo" class="close-btn">&times;</button>
            </div>
            <div class="info-content">
                <div class="info-item">
                    <label>Type:</label>
                    <span id="infoType">-</span>
                </div>
                <div class="info-item">
                    <label>Location:</label>
                    <span id="infoLocation">-</span>
                </div>
                <div class="info-item">
                    <label>Severity:</label>
                    <span id="infoSeverity">-</span>
                </div>
                <div class="info-item">
                    <label>Environmental Medium:</label>
                    <span id="infoMedium">-</span>
                </div>
            </div>
        </div>

        <!-- Information Bubble (for hover) -->
        <!-- Hover Information Bubble -->
        <div id="infoBubble" class="info-bubble hidden">
            <div class="bubble-content">
                <div class="bubble-type" id="bubbleType">Hazard Type</div>
                <div class="bubble-severity" id="bubbleSeverity">Level 0</div>
            </div>
        </div>

        <!-- Help Icon -->
        <div id="helpIcon" class="help-icon" title="Hover for navigation instructions">
            <span class="help-symbol">?</span>
            <div class="help-tooltip">
                <h4>Map Navigation</h4>
                <ul>
                    <li><strong>Left Click + Drag:</strong> Rotate view</li>
                    <li><strong>Right Click + Drag:</strong> Pan map</li>
                    <li><strong>Mouse Wheel:</strong> Zoom in/out</li>
                    <li><strong>Middle Click + Drag:</strong> Tilt view</li>
                    <li><strong>Click Pins/Polygons:</strong> View hazard info</li>
                    <li><strong>Use Arrow Keys:</strong> Navigate between hazards</li>
                </ul>
            </div>
        </div>

        <!-- Click Information Box -->
        <div id="clickInfoBox" class="click-info-box hidden">
            <div class="severity-gradient-bar">
                <h3 id="infoBoxTitle" class="gradient-title">Hazard Information</h3>
                <button id="closeInfoBox" class="gradient-close-btn">&times;</button>
            </div>
            
            <div class="info-box-content">
                <div class="info-row">
                    <span class="info-label">Environmental Medium:</span>
                    <span id="infoBoxMedium">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Health Threat:</span>
                    <span id="infoBoxHealthThreat">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Exposure Route:</span>
                    <span id="infoBoxExposureRoute">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Population Affected:</span>
                    <span id="infoBoxPopulation">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Existing Controls:</span>
                    <span id="infoBoxControls">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Frequency/Duration:</span>
                    <span id="infoBoxFreqDuration">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Severity:</span>
                    <span id="infoBoxSeverity">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Probability:</span>
                    <span id="infoBoxProbability">-</span>
                </div>
            </div>
            
            <!-- Navigation Controls -->
            <div class="info-navigation">
                <button id="prevHazard" class="nav-btn" title="Previous Hazard">‚Üê</button>
                <span id="hazardCounter" class="hazard-counter">1 of 10</span>
                <button id="nextHazard" class="nav-btn" title="Next Hazard">‚Üí</button>
            </div>
        </div>

        <script>
        // DataLoader class for handling GeoJSON data
        class DataLoader {
            constructor() {
                this.hazardData = null;
                this.loading = false;
                this.error = null;
            }

            async loadCSV(filePath) {
                this.loading = true;
                this.error = null;

                try {
                    console.log(`Loading CSV data from: ${filePath}`);
                    
                    const response = await fetch(filePath);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const csvText = await response.text();
                    
                    // Parse CSV (simple parser - handles quoted fields)
                    const lines = csvText.split('\n').filter(line => line.trim());
                    if (lines.length < 2) {
                        throw new Error('CSV file must have at least a header and one data row');
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim());
                    const sourceIndex = headers.indexOf('Source');
                    
                    if (sourceIndex === -1) {
                        throw new Error('CSV file must contain a "Source" column');
                    }
                    
                    // Extract source names (skip header row)
                    const sources = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Simple CSV parsing - split by comma, but handle quoted fields
                        const values = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());
                        
                        const source = values[sourceIndex]?.trim();
                        if (source && source.length > 0) {
                            sources.push(source);
                        }
                    }
                    
                    console.log(`Loaded ${sources.length} sources from CSV:`, sources);
                    
                    this.loading = false;
                    return sources;

                } catch (error) {
                    this.error = error.message;
                    this.loading = false;
                    console.error('Failed to load CSV data:', error);
                    throw error;
                }
            }

            normalizeHazardName(name) {
                if (!name) return '';
                // Remove leading/trailing apostrophes and quotes, then normalize
                // Replace hyphens with spaces before removing non-alphanumeric to preserve word separation
                return name.toLowerCase()
                    .replace(/^['"]+|['"]+$/g, '') // Remove leading/trailing quotes/apostrophes
                    .replace(/-/g, ' ') // Replace hyphens with spaces first
                    .replace(/[^a-z0-9\s]/g, '') // Remove other non-alphanumeric
                    .replace(/\s+/g, ' ') // Normalize multiple spaces to single space
                    .trim();
            }

            matchesCSVSource(geoJSONName, csvSources) {
                const normalizedGeoJSON = this.normalizeHazardName(geoJSONName);
                
                return csvSources.some(csvSource => {
                    const normalizedCSV = this.normalizeHazardName(csvSource);
                    
                    // Direct match
                    if (normalizedGeoJSON === normalizedCSV) {
                        return true;
                    }
                    
                    // Known mapping variations - check both directions
                    const mappings = [
                        { csv: 'jet engine testing pad', geo: ['engine testing pad', 'engine testing pad1'] },
                        { csv: 'legacy burn pit', geo: ['legacy burn pit'] },
                        { csv: 'base catm range', geo: ['catm range'] },
                        { csv: 'historic landfill', geo: ['histoic landfill', 'historic landfill'] },
                        { csv: 'satellite comms dish', geo: ['satellite comms dish'] },
                        { csv: 'mechanical shop', geo: ['mechanical shop'] },
                        { csv: 'gate area', geo: ['gate area'] },
                        { csv: 'field training area', geo: ['feild training area', 'field training area'] },
                        { csv: 'medical x ray', geo: ['medical x ray', 'medical xray', 'medical x ray'] },
                        { csv: 'arthropod vectors', geo: ['arthropod vectors'] }
                    ];
                    
                    for (const mapping of mappings) {
                        // Check if CSV matches this mapping
                        const csvMatches = normalizedCSV === mapping.csv || 
                                         normalizedCSV.includes(mapping.csv) || 
                                         mapping.csv.includes(normalizedCSV);
                        
                        if (csvMatches) {
                            // Check if GeoJSON matches any variant in this mapping
                            for (const geoVariant of mapping.geo) {
                                if (normalizedGeoJSON === geoVariant || 
                                    normalizedGeoJSON.includes(geoVariant) || 
                                    geoVariant.includes(normalizedGeoJSON)) {
                                    return true;
                                }
                            }
                        }
                    }
                    
                    // Fallback: Check if CSV source is contained in GeoJSON name or vice versa (after normalization)
                    // This handles cases like "'arthropod Vectors" matching "Arthropod Vectors"
                    if (normalizedGeoJSON.includes(normalizedCSV) || normalizedCSV.includes(normalizedGeoJSON)) {
                        return true;
                    }
                    
                    return false;
                });
            }

            async loadGeoJSON(filePath, csvSources = null) {
                this.loading = true;
                this.error = null;

                try {
                    console.log(`Loading GeoJSON data from: ${filePath}`);
                    
                    const response = await fetch(filePath);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    // Validate GeoJSON structure
                    this.validateGeoJSON(data);
                    
                    // Process and store the data with CSV filtering
                    this.hazardData = this.processHazardData(data, csvSources);
                    
                    console.log(`Successfully loaded ${this.hazardData.features.length} hazard features`);
                    
                    this.loading = false;
                    return this.hazardData;

                } catch (error) {
                    this.error = error.message;
                    this.loading = false;
                    console.error('Failed to load GeoJSON data:', error);
                    throw error;
                }
            }

            validateGeoJSON(data) {
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid GeoJSON: Data is not an object');
                }

                if (data.type !== 'FeatureCollection') {
                    throw new Error('Invalid GeoJSON: Must be a FeatureCollection');
                }

                if (!Array.isArray(data.features)) {
                    throw new Error('Invalid GeoJSON: Features must be an array');
                }

                data.features.forEach((feature, index) => {
                    const isValid = this.validateFeature(feature, index);
                    if (isValid === false) {
                        console.log(`Skipping feature at index ${index}: null geometry`);
                    }
                });
            }

            validateFeature(feature, index) {
                if (!feature || typeof feature !== 'object') {
                    throw new Error(`Invalid feature at index ${index}: Not an object`);
                }

                if (feature.type !== 'Feature') {
                    throw new Error(`Invalid feature at index ${index}: Type must be 'Feature'`);
                }

                if (!feature.geometry || feature.geometry === null) {
                    // Skip features with null geometry (some points files have these)
                    return false;
                }

                if (!feature.properties) {
                    throw new Error(`Invalid feature at index ${index}: Missing properties`);
                }

                // Check for HillAFBVector format (id, Name, Code) or standard format (hazard_id, etc.)
                const hasStandardFormat = feature.properties.hazard_id && feature.properties.hazard_type;
                const hasHillAFBFormat = feature.properties.id && feature.properties.Name;

                if (!hasStandardFormat && !hasHillAFBFormat) {
                    throw new Error(`Invalid feature at index ${index}: Missing required properties (need either hazard_id/hazard_type or id/Name)`);
                }

                if (feature.geometry.type !== 'Polygon' && feature.geometry.type !== 'MultiPolygon' && feature.geometry.type !== 'Point') {
                    throw new Error(`Invalid feature at index ${index}: Geometry type must be 'Polygon', 'MultiPolygon', or 'Point'`);
                }

                if (!Array.isArray(feature.geometry.coordinates)) {
                    throw new Error(`Invalid feature at index ${index}: Coordinates must be an array`);
                }

                return true; // Feature is valid
            }

            processHazardData(geoJSONData, csvSources = null) {
                console.log('Processing hazard data from polygon file...');
                
                const features = geoJSONData.features || [];
                console.log(`Found ${features.length} polygon features`);
                
                if (csvSources) {
                    console.log(`Filtering hazards to match ${csvSources.length} CSV sources:`, csvSources);
                }
                
                const matchedHazards = [];
                const filteredOutHazards = [];
                
                // Process polygon features directly
                const processedFeatures = features.map((feature, index) => {
                    if (feature.geometry && (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') && feature.properties) {
                        const id = feature.properties.id;
                        const name = feature.properties.Name;
                        
                        if (id !== null && id !== undefined && name) {
                            // Filter by CSV sources if provided
                            if (csvSources && !this.matchesCSVSource(name, csvSources)) {
                                filteredOutHazards.push({ id, name });
                                console.log(`Filtering out hazard: ${name} (ID: ${id}) - not in CSV`);
                                return null;
                            }
                            
                            matchedHazards.push({ id, name });
                            
                            // Transform to hazard feature format
                            const hazardFeature = {
                                type: 'Feature',
                                properties: {
                                    hazard_id: `H${id}`,
                                    original_id: id, // Store original ID for sorting
                                    hazard_type: name,
                                    display_name: name,
                                    severity: this.getSeverityLevel(name),
                                    environmental_medium: this.getEnvironmentalMedium(name),
                                    contaminant: this.getContaminant(name),
                                    color: this.getHazardColor(name),
                                    icon: this.getHazardIcon(name)
                                },
                                geometry: feature.geometry
                            };
                            
                            console.log(`‚úì Processed hazard ${name} (ID: ${id})`);
                            return hazardFeature;
                        }
                    }
                    return null;
                }).filter(feature => feature !== null);
                
                console.log(`\n=== HAZARD FILTERING SUMMARY ===`);
                console.log(`Matched hazards: ${matchedHazards.length}`, matchedHazards.map(h => `${h.name} (H${h.id})`));
                if (filteredOutHazards.length > 0) {
                    console.log(`Filtered out hazards: ${filteredOutHazards.length}`, filteredOutHazards.map(h => `${h.name} (H${h.id})`));
                }
                console.log(`Total processed: ${processedFeatures.length} hazards\n`);

                    // Remove duplicates based on hazard_id, preferring features with valid coordinates
                    const uniqueFeatures = [];
                    const seenIds = new Map(); // Use Map to store both ID and feature
                    
                    processedFeatures.forEach(feature => {
                        const hazardId = feature.properties.hazard_id;
                        
                        if (!seenIds.has(hazardId)) {
                            seenIds.set(hazardId, feature);
                            uniqueFeatures.push(feature);
                            } else {
                            const existingFeature = seenIds.get(hazardId);
                            // Check if current feature has valid coordinates and existing doesn't
                            const currentHasCoords = feature.geometry && feature.geometry.coordinates && 
                                                   feature.geometry.coordinates.length > 0 && 
                                                   feature.geometry.coordinates[0] && 
                                                   feature.geometry.coordinates[0].length > 0;
                            
                            const existingHasCoords = existingFeature.geometry && existingFeature.geometry.coordinates && 
                                                     existingFeature.geometry.coordinates.length > 0 && 
                                                     existingFeature.geometry.coordinates[0] && 
                                                     existingFeature.geometry.coordinates[0].length > 0;
                            
                            if (currentHasCoords && !existingHasCoords) {
                                // Replace existing with current (current has coords, existing doesn't)
                                console.log(`Replacing ${feature.properties.display_name} with coordinates for ${hazardId}`);
                                const index = uniqueFeatures.indexOf(existingFeature);
                                uniqueFeatures[index] = feature;
                                seenIds.set(hazardId, feature);
                            } else {
                                console.log(`Removing duplicate hazard: ${feature.properties.display_name} (ID: ${hazardId})`);
                        }
                    }
                });
                
                console.log(`Created ${uniqueFeatures.length} unique hazard features (removed ${processedFeatures.length - uniqueFeatures.length} duplicates)`);
                
                // Sort by original ID to maintain consistent order, then renumber sequentially from 1 to N
                uniqueFeatures.sort((a, b) => {
                    // Use stored original_id for sorting
                    const aId = a.properties.original_id || parseInt(a.properties.hazard_id.replace('H', '')) || 0;
                    const bId = b.properties.original_id || parseInt(b.properties.hazard_id.replace('H', '')) || 0;
                    return aId - bId;
                });
                
                // Renumber hazards sequentially from 1 to N
                uniqueFeatures.forEach((feature, index) => {
                    const newId = index + 1;
                    feature.properties.hazard_id = `H${newId}`;
                    console.log(`Renumbered ${feature.properties.display_name} to H${newId}`);
                });
                
                return {
                    type: 'FeatureCollection',
                    features: uniqueFeatures
                };
            }

            // Helper methods for hazard classification
            getEnvironmentalMedium(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('water') || nameLower.includes('fuel') || nameLower.includes('municipal')) {
                    return 'Water';
                } else if (nameLower.includes('burn') || nameLower.includes('landfill') || nameLower.includes('soil')) {
                    return 'Soil';
                } else if (nameLower.includes('air') || nameLower.includes('x ray') || nameLower.includes('radar')) {
                    return 'Air';
                } else if (nameLower.includes('groundwater') || nameLower.includes('underground')) {
                    return 'Groundwater';
                }
                return 'Soil'; // Default
            }

            getSeverityLevel(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('nuclear') || nameLower.includes('radiological') || nameLower.includes('hazmat')) {
                    return 5;
                } else if (nameLower.includes('fuel') || nameLower.includes('chemical') || nameLower.includes('burn') || nameLower.includes('welding')) {
                    return 4;
                } else if (nameLower.includes('x ray') || nameLower.includes('battery') || nameLower.includes('paint')) {
                    return 3;
                } else if (nameLower.includes('water') || nameLower.includes('gym') || nameLower.includes('warehouse')) {
                    return 2;
                }
                return 1; // Default
            }

            getContaminant(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('fuel')) return 'Petroleum Hydrocarbons';
                if (nameLower.includes('chemical')) return 'Chemical Contaminants';
                if (nameLower.includes('burn')) return 'Combustion Byproducts';
                if (nameLower.includes('x ray')) return 'Radiation';
                if (nameLower.includes('battery')) return 'Heavy Metals';
                if (nameLower.includes('paint')) return 'Volatile Organic Compounds';
                return 'Unknown Contaminant';
            }

            getHazardColor(name) {
                const severity = this.getSeverityLevel(name);
                switch(severity) {
                    case 5: return '#FF0000'; // Red
                    case 4: return '#FF6600'; // Orange
                    case 3: return '#FFCC00'; // Yellow
                    case 2: return '#00CC00'; // Green
                    case 1: return '#0066CC'; // Blue
                    default: return '#666666'; // Gray
                }
            }

            getHazardIcon(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('fuel')) return '‚õΩ';
                if (nameLower.includes('chemical')) return 'üß™';
                if (nameLower.includes('burn')) return 'üî•';
                if (nameLower.includes('x ray')) return '‚ò¢Ô∏è';
                if (nameLower.includes('battery')) return 'üîã';
                if (nameLower.includes('water')) return 'üíß';
                return '‚ö†Ô∏è'; // Default warning
            }

            transformHillAFBFeature(feature) {
                // Transform HillAFBVector format to our expected format
                const props = feature.properties;
                const name = props.Name || `Area ${props.id}`;
                
                // Map HillAFB names to hazard types
                const hazardTypeMap = {
                    'Gate Area': 'Physical',
                    'Gym Sauna': 'Physical',
                    'Engine Testing Pad1': 'Environmental',
                    'Aircraft Fuel Tanks': 'Chemical',
                    'Legacy burn Pit': 'Environmental',
                    'Welding Shop': 'Chemical',
                    'Municipal Water Supply': 'Environmental',
                    'Fuel truck refueling': 'Chemical',
                    'Forest Fire': 'Environmental',
                    'CATM Range': 'Physical',
                    'Feild Water System': 'Environmental',
                    'Warehouse': 'Physical',
                    'Histoic Landfill': 'Environmental',
                    'Cryogenics Shop': 'Chemical',
                    'Medical X ray': 'Radiological',
                    'Feild Training Area': 'Physical',
                    'Battery Storage': 'Chemical',
                    'Satellite Comms Dish': 'Radiological',
                    'Pest Control': 'Chemical',
                    'Paint Shop': 'Chemical',
                    'Chemical Lab': 'Chemical',
                    'Mechanical Shop': 'Physical',
                    'HazMat Storage Area': 'Chemical',
                    'Municipal Water System': 'Environmental'
                };

                const hazardType = hazardTypeMap[name] || 'Environmental';
                
                // Map to environmental medium based on hazard type
                const mediumMap = {
                    'Chemical': 'Soil',
                    'Biological': 'Water',
                    'Radiological': 'Air',
                    'Nuclear': 'Air',
                    'Environmental': 'Groundwater',
                    'Physical': 'Soil'
                };

                // Generate severity level based on hazard type
                const severityMap = {
                    'Chemical': 4,
                    'Biological': 2,
                    'Radiological': 5,
                    'Nuclear': 5,
                    'Environmental': 3,
                    'Physical': 1
                };

                // Convert coordinates from Web Mercator (EPSG:3857) to WGS84
                console.log(`Converting coordinates for ${name} (ID: ${props.id}):`, feature.geometry.coordinates);
                const coords = this.convertWebMercatorToWGS84(feature.geometry.coordinates);
                console.log(`Converted coordinates for ${name}:`, coords);
                
                // Flatten the coordinates if they're nested (MultiPolygon case)
                let flatCoords = coords;
                if (coords.length > 0 && Array.isArray(coords[0]) && Array.isArray(coords[0][0])) {
                    // MultiPolygon - take the first polygon
                    flatCoords = coords[0];
                    console.log(`Flattened MultiPolygon coordinates for ${name}:`, flatCoords);
                }
                
                // If we still have nested arrays, flatten one more level
                if (flatCoords.length > 0 && Array.isArray(flatCoords[0]) && Array.isArray(flatCoords[0][0])) {
                    flatCoords = flatCoords[0];
                    console.log(`Double-flattened coordinates for ${name}:`, flatCoords);
                }
                
                // Skip features with empty coordinates
                if (!flatCoords || flatCoords.length === 0) {
                    console.warn(`Skipping feature ${props.id} (${name}) - empty coordinates`);
                    return null;
                }
                
                return {
                    ...feature,
                    properties: {
                        hazard_id: `H${props.id}`,
                        hazard_type: hazardType,
                        environmental_medium: mediumMap[hazardType],
                        severity_level: severityMap[hazardType],
                        location_description: name,
                        contaminant: this.getContaminantForType(hazardType),
                        area_estimate: this.calculateArea({ type: 'Polygon', coordinates: [flatCoords] }),
                        last_updated: '2024-01-15',
                        display_name: name,
                        color: this.getHazardColor(hazardType),
                        icon: this.getHazardIcon(hazardType),
                        centroid: this.calculateCentroid({ type: 'Polygon', coordinates: [flatCoords] })
                    },
                    geometry: {
                        ...feature.geometry,
                        coordinates: [flatCoords]
                    }
                };
            }

            convertWebMercatorToWGS84(coordinates) {
                // Convert from Web Mercator (EPSG:3857) to WGS84 (EPSG:4326)
                
                // Check if coordinates are empty or invalid
                if (!coordinates || !Array.isArray(coordinates) || coordinates.length === 0) {
                    console.warn('Empty or invalid coordinates, returning empty array');
                    return [];
                }

                try {
                    // Check if it's a MultiPolygon (nested array structure)
                    if (coordinates[0] && coordinates[0][0] && coordinates[0][0][0] && Array.isArray(coordinates[0][0][0])) {
                        // MultiPolygon
                        return coordinates.map(polygon => 
                            polygon.map(ring => 
                                ring.map(coord => {
                                    if (!Array.isArray(coord) || coord.length < 2) {
                                        console.warn('Invalid coordinate:', coord);
                                        return [0, 0]; // Default coordinate
                                    }
                                    const lon = (coord[0] * 180) / 20037508.34;
                                    const lat = Math.atan(Math.sinh((coord[1] * Math.PI) / 20037508.34)) * 180 / Math.PI;
                                    
                                    // Validate coordinate ranges
                                    if (isNaN(lon) || isNaN(lat) || lon < -180 || lon > 180 || lat < -90 || lat > 90) {
                                        console.warn('Invalid converted coordinate:', { lon, lat, original: coord });
                                        return [0, 0]; // Default coordinate
                                    }
                                    
                                    return [lon, lat];
                                })
                            )
                        );
                    } else if (coordinates[0] && coordinates[0][0] && Array.isArray(coordinates[0][0])) {
                        // Polygon
                        return coordinates.map(ring => 
                            ring.map(coord => {
                                if (!Array.isArray(coord) || coord.length < 2) {
                                    console.warn('Invalid coordinate:', coord);
                                    return [0, 0]; // Default coordinate
                                }
                                const lon = (coord[0] * 180) / 20037508.34;
                                const lat = Math.atan(Math.sinh((coord[1] * Math.PI) / 20037508.34)) * 180 / Math.PI;
                                
                                // Validate coordinate ranges
                                if (isNaN(lon) || isNaN(lat) || lon < -180 || lon > 180 || lat < -90 || lat > 90) {
                                    console.warn('Invalid converted coordinate:', { lon, lat, original: coord });
                                    return [0, 0]; // Default coordinate
                                }
                                
                                return [lon, lat];
                            })
                        );
                    } else if (coordinates[0] && Array.isArray(coordinates[0]) && coordinates[0].length === 2) {
                        // Single coordinate pair (for points)
                        const coord = coordinates[0];
                        if (!Array.isArray(coord) || coord.length < 2) {
                            console.warn('Invalid coordinate:', coord);
                            return [];
                        }
                        const lon = (coord[0] * 180) / 20037508.34;
                        const lat = Math.atan(Math.sinh((coord[1] * Math.PI) / 20037508.34)) * 180 / Math.PI;
                        
                        // Validate coordinate ranges
                        if (isNaN(lon) || isNaN(lat) || lon < -180 || lon > 180 || lat < -90 || lat > 90) {
                            console.warn('Invalid converted coordinate:', { lon, lat, original: coord });
                            return [];
                        }
                        
                        return [[lon, lat]]; // Return as array containing the coordinate pair
                    } else {
                        console.warn('Unknown coordinate structure:', coordinates);
                        return []; // Return empty array for unknown structures
                    }
                } catch (error) {
                    console.error('Error converting coordinates:', error);
                    return [];
                }
            }

            getContaminantForType(hazardType) {
                const contaminantMap = {
                    'Chemical': 'Various chemicals and solvents',
                    'Biological': 'Bacterial contamination',
                    'Radiological': 'Radioactive materials',
                    'Nuclear': 'Nuclear materials',
                    'Environmental': 'Environmental contaminants',
                    'Physical': 'Physical hazards'
                };
                return contaminantMap[hazardType] || 'Unknown contaminants';
            }

            calculateCentroid(geometry) {
                if (geometry.type !== 'Polygon' || !geometry.coordinates[0]) {
                    return [0, 0];
                }

                const coords = geometry.coordinates[0];
                let x = 0, y = 0;
                
                coords.forEach(coord => {
                    x += coord[0];
                    y += coord[1];
                });

                return [x / coords.length, y / coords.length];
            }

            calculateArea(geometry) {
                if (geometry.type !== 'Polygon' || !geometry.coordinates[0]) {
                    return 0;
                }

                const coords = geometry.coordinates[0];
                let area = 0;
                
                for (let i = 0; i < coords.length - 1; i++) {
                    area += coords[i][0] * coords[i + 1][1];
                    area -= coords[i + 1][0] * coords[i][1];
                }
                
                return Math.abs(area) * 111000 * 111000;
            }

            generateDisplayName(properties) {
                return `${properties.hazard_type} Hazard - ${properties.location_description}`;
            }

            getHazardColor(hazardType) {
                const colors = {
                    'Chemical': '#3498db',
                    'Biological': '#2ecc71',
                    'Radiological': '#f1c40f',
                    'Nuclear': '#e74c3c',
                    'Environmental': '#e67e22',
                    'Physical': '#9b59b6'
                };
                return colors[hazardType] || '#95a5a6';
            }

            getHazardIcon(hazardType) {
                const icons = {
                    'Chemical': '‚ö†Ô∏è',
                    'Biological': 'ü¶†',
                    'Radiological': '‚ò¢Ô∏è',
                    'Nuclear': '‚ò¢Ô∏è',
                    'Environmental': 'üåç',
                    'Physical': '‚ö†Ô∏è'
                };
                return icons[hazardType] || '‚ö†Ô∏è';
            }

            getFilteredHazards(filters = {}) {
                if (!this.hazardData || !this.hazardData.features) {
                    return [];
                }

                return this.hazardData.features.filter(feature => {
                    const props = feature.properties;

                    if (filters.hazardTypes && filters.hazardTypes.length > 0) {
                        if (!filters.hazardTypes.includes(props.hazard_type)) {
                            return false;
                        }
                    }

                    if (filters.environmentalMediums && filters.environmentalMediums.length > 0) {
                        if (!filters.environmentalMediums.includes(props.environmental_medium)) {
                            return false;
                        }
                    }

                    if (filters.severityLevels && filters.severityLevels.length > 0) {
                        if (!filters.severityLevels.includes(props.severity_level)) {
                            return false;
                        }
                    }

                    return true;
                });
            }

            getStatistics() {
                if (!this.hazardData || !this.hazardData.features) {
                    return {
                        totalHazards: 0,
                        byType: {},
                        byMedium: {},
                        bySeverity: {}
                    };
                }

                const stats = {
                    totalHazards: this.hazardData.features.length,
                    byType: {},
                    byMedium: {},
                    bySeverity: {}
                };

                this.hazardData.features.forEach(feature => {
                    const props = feature.properties;
                    stats.byType[props.hazard_type] = (stats.byType[props.hazard_type] || 0) + 1;
                    stats.byMedium[props.environmental_medium] = (stats.byMedium[props.environmental_medium] || 0) + 1;
                    stats.bySeverity[props.severity_level] = (stats.bySeverity[props.severity_level] || 0) + 1;
                });

                return stats;
            }

            isLoading() {
                return this.loading;
            }

            getError() {
                return this.error;
            }

            getData() {
                return this.hazardData;
            }
        }

        // OEHSA Interactive Hazard Map - Main Application
        class OEHSAHazardMap {
            constructor() {
                this.viewer = null;
                this.tileset = null;
                
                // Configuration
                this.config = {
                    // Cesium token
                    cesiumToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhMzg4YjBkOC0wMGUwLTRjMzMtODZjMy05NDA0NGYyMzIzZGEiLCJpZCI6MzI0MzMxLCJpYXQiOjE3NTc5NjQxMDh9.OSWvv6a8r1wlWVgCf9QvHSIhNIBTMqWukie1hvCEpJ8',
                    // Initial camera position (Hill Air Force Base area)
                    initialPosition: {
                        longitude: -111.9731,
                        latitude: 41.1250,
                        height: 20000
                    },
                        // Data file path
                        dataFile: './Hill Air Force Vectors.geojson'
                };

                // Initialize data loader
                this.dataLoader = new DataLoader();
                
                // Proximity fade properties
                this.currentHazardEntity = null;
                this.proximityCheckInterval = null;
                this.fadeDistance = 5000; // Distance in meters for fade effect
                this.hazardFeatures = [];
                
                // Navigation state
                this.currentHazardIndex = 0;
                this.hazardEntities = [];
                this.hazardData = [];
            }

            async init() {
                try {
                    console.log('Initializing OEHSA Hazard Map...');
                    
                    // Show loading indicator
                    this.showLoading(true);
                    
                    // Initialize Cesium viewer and load Google 3D Tiles first
                    await this.initializeCesium();
                    
                    // Hide loading indicator after Google 3D Tiles are loaded
                    this.showLoading(false);
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    this.setupInfoBoxListeners();
                    
                    // Try to load hazard data (but don't let it block the main app)
                    try {
                        await this.loadHazardData();
                    } catch (hazardError) {
                        console.warn('Hazard data failed to load, but map is still functional:', hazardError);
                    }
                    
                    console.log('OEHSA Hazard Map initialized successfully');
                    
                } catch (error) {
                    console.error('Failed to initialize OEHSA Hazard Map:', error);
                    this.showError('Failed to initialize the hazard map. Please refresh the page.');
                }
            }

            // Web Mercator projection for coordinate conversion
            get webMercatorProjection() {
                if (!this._webMercatorProjection) {
                    this._webMercatorProjection = new Cesium.WebMercatorProjection();
                }
                return this._webMercatorProjection;
            }

            // Convert EPSG:3857 (Web Mercator) coordinates to WGS84 degrees
            convertWebMercatorToWGS84(x, y) {
                const cartesian = new Cesium.Cartesian3(x, y, 0);
                const cartographic = this.webMercatorProjection.unproject(cartesian);
                return [
                    Cesium.Math.toDegrees(cartographic.longitude),
                    Cesium.Math.toDegrees(cartographic.latitude)
                ];
            }

            // Convert coordinate array from Web Mercator to WGS84
            convertCoordinateArray(webMercatorCoords) {
                return webMercatorCoords.map(coord => {
                    const [lon, lat] = this.convertWebMercatorToWGS84(coord[0], coord[1]);
                    return [lon, lat];
                });
            }

            // Process hazard data with coordinate conversion
            processHazardDataWithCoordinateConversion(features) {
                console.log('[HazardGeom] Processing hazard data with coordinate conversion...');
                
                const processedFeatures = features.map(feature => {
                    const processedFeature = { ...feature };
                    
                    // Convert coordinates for different geometry types
                    if (feature.geometry.type === 'Polygon') {
                        processedFeature.geometry.coordinates = feature.geometry.coordinates.map(ring => 
                            this.convertCoordinateArray(ring)
                        );
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        processedFeature.geometry.coordinates = feature.geometry.coordinates.map(polygon => 
                            polygon.map(ring => this.convertCoordinateArray(ring))
                        );
                    }
                    
                    return processedFeature;
                });
                
                console.log('[HazardGeom] Coordinate conversion complete');
                return processedFeatures;
            }

            showLoading(show) {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    if (show) {
                        loadingIndicator.style.display = 'flex';
                    } else {
                        loadingIndicator.style.display = 'none';
                    }
                }
            }

            showError(message) {
                console.error(message);
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `
                        <div class="spinner" style="border-color: #e74c3c;"></div>
                        <p style="color: #e74c3c;">Error: ${message}</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
                    `;
                }
            }

            async initializeCesium() {
                // Check if Cesium is loaded
                if (typeof Cesium === 'undefined') {
                    throw new Error('CesiumJS library not loaded. Please check your internet connection.');
                }
                
                // Set Cesium base URL for CDN
                window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/';
                
                // Configure Cesium
                Cesium.Ion.defaultAccessToken = this.config.cesiumToken;
                
                // Initialize viewer with minimal configuration (like our working test)
                this.viewer = new Cesium.Viewer('cesiumContainer', {
                    // Disable default UI elements we don't need
                    homeButton: false,
                    sceneModePicker: false,
                    baseLayerPicker: false,
                    navigationHelpButton: false,
                    geocoder: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: false,
                    vrButton: false,
                    // Enable selection
                    selectionIndicator: false
                });

                // Set up camera constraints to keep view within Hill AFB boundaries
                this.setupCameraConstraints();

                // Set camera directly to Hill Air Force Base area (no animation)
                this.viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(
                        this.config.initialPosition.longitude,
                        this.config.initialPosition.latitude,
                        this.config.initialPosition.height
                    ),
                    orientation: {
                        heading: 0.0,
                        pitch: Cesium.Math.toRadians(-90), // Looking straight down
                        roll: 0.0
                    }
                });

                // Configure basic scene settings (simplified for Google 3D Tiles)
                this.viewer.scene.globe.enableLighting = true;
                this.viewer.scene.skyAtmosphere.show = true;
                
                // Configure camera controls
                this.viewer.scene.screenSpaceCameraController.minimumZoomDistance = 10.0;
                this.viewer.scene.screenSpaceCameraController.maximumZoomDistance = 20000000.0;
                
                // Load imagery provider (fallback to standard imagery)
                await this.loadImageryProvider();
            }

            setupCameraConstraints() {
                // Define Hill Air Force Base boundaries (hard limits)
                const hillAFBBounds = {
                    west: -112.15,   // Western boundary
                    south: 41.05,    // Southern boundary  
                    east: -111.95,   // Eastern boundary
                    north: 41.20     // Northern boundary
                };

                // Normal zoom behavior - no constraints
                this.viewer.scene.screenSpaceCameraController.enableZoom = true;

                // Hard boundary enforcement - blocks movement at the edge
                this.viewer.camera.moveEnd.addEventListener(() => {
                    const position = this.viewer.camera.position;
                    const cartographic = Cesium.Cartographic.fromCartesian(position);
                    const longitude = Cesium.Math.toDegrees(cartographic.longitude);
                    const latitude = Cesium.Math.toDegrees(cartographic.latitude);
                    
                    let needsCorrection = false;
                    let correctedLon = longitude;
                    let correctedLat = latitude;
                    
                    // Hard clamp to boundaries
                    if (longitude < hillAFBBounds.west) {
                        correctedLon = hillAFBBounds.west;
                        needsCorrection = true;
                    } else if (longitude > hillAFBBounds.east) {
                        correctedLon = hillAFBBounds.east;
                        needsCorrection = true;
                    }
                    
                    if (latitude < hillAFBBounds.south) {
                        correctedLat = hillAFBBounds.south;
                        needsCorrection = true;
                    } else if (latitude > hillAFBBounds.north) {
                        correctedLat = hillAFBBounds.north;
                        needsCorrection = true;
                    }
                    
                    // Immediately snap back to boundary if outside
                    if (needsCorrection) {
                        this.viewer.camera.setView({
                            destination: Cesium.Cartesian3.fromDegrees(
                                correctedLon,
                                correctedLat,
                                cartographic.height
                            ),
                            orientation: {
                                heading: this.viewer.camera.heading,
                                pitch: this.viewer.camera.pitch,
                                roll: this.viewer.camera.roll
                            }
                        });
                    }
                });

                // Real-time boundary enforcement during movement
                this.viewer.camera.changed.addEventListener(() => {
                    const position = this.viewer.camera.position;
                    const cartographic = Cesium.Cartographic.fromCartesian(position);
                    const longitude = Cesium.Math.toDegrees(cartographic.longitude);
                    const latitude = Cesium.Math.toDegrees(cartographic.latitude);
                    
                    // Hard clamp coordinates to boundaries
                    let correctedLon = Math.max(hillAFBBounds.west, Math.min(hillAFBBounds.east, longitude));
                    let correctedLat = Math.max(hillAFBBounds.south, Math.min(hillAFBBounds.north, latitude));
                    
                    // If position was clamped, immediately correct it
                    if (correctedLon !== longitude || correctedLat !== latitude) {
                        this.viewer.camera.setView({
                            destination: Cesium.Cartesian3.fromDegrees(
                                correctedLon,
                                correctedLat,
                                cartographic.height
                            ),
                            orientation: {
                                heading: this.viewer.camera.heading,
                                pitch: this.viewer.camera.pitch,
                                roll: this.viewer.camera.roll
                            }
                        });
                    }
                });

                // Override camera controller to prevent boundary crossing
                const originalMove = this.viewer.scene.screenSpaceCameraController.move;
                this.viewer.scene.screenSpaceCameraController.move = (direction, amount) => {
                    const currentPosition = this.viewer.camera.position;
                    const currentCartographic = Cesium.Cartographic.fromCartesian(currentPosition);
                    const currentLon = Cesium.Math.toDegrees(currentCartographic.longitude);
                    const currentLat = Cesium.Math.toDegrees(currentCartographic.latitude);
                    
                    // Calculate potential new position
                    const moveAmount = amount * 0.0005; // Reduced sensitivity for tighter control
                    let newLon = currentLon + (direction.x * moveAmount);
                    let newLat = currentLat + (direction.y * moveAmount);
                    
                    // Check if new position would be within bounds
                    if (newLon >= hillAFBBounds.west && newLon <= hillAFBBounds.east &&
                        newLat >= hillAFBBounds.south && newLat <= hillAFBBounds.north) {
                        // Allow the move
                        originalMove.call(this.viewer.scene.screenSpaceCameraController, direction, amount);
                    }
                    // If move would go outside bounds, block it completely
                };

                // Zoom constraints removed - normal zoom behavior restored

                console.log('Hard camera constraints set for Hill Air Force Base - movement clamped to boundaries');
            }

            // Load Google Photorealistic 3D Tiles via Cesium Ion
            async loadImageryProvider() {
                try {
                    console.log('=== DEBUG: Starting Google 3D Tiles load ===');
                    console.log('Cesium object:', typeof Cesium);
                    console.log('createGooglePhotorealistic3DTileset function:', typeof Cesium.createGooglePhotorealistic3DTileset);
                    
                    // Load Google Photorealistic 3D Tiles through Cesium Ion
                    console.log('Calling Cesium.createGooglePhotorealistic3DTileset()...');
                this.tileset = await Cesium.createGooglePhotorealistic3DTileset();
                    console.log('Tileset created:', this.tileset);
                    
                    console.log('Adding tileset to scene...');
                this.viewer.scene.primitives.add(this.tileset);
                    console.log('Google Photorealistic 3D Tiles added to scene successfully');
                    
                    // Add error handling for the tileset (check if readyPromise exists)
                    if (this.tileset.readyPromise) {
                        this.tileset.readyPromise.then(function(tileset) {
                            console.log('=== TILESET READY ===', tileset);
                        }).otherwise(function(error) {
                            console.error('=== TILESET READY ERROR ===', error);
                        });
                    } else {
                        console.log('Tileset readyPromise not available, but tileset loaded');
                    }
                    
                    // Check if tileset is visible
                    setTimeout(() => {
                        console.log('Tileset visibility check:');
                        console.log('- Tileset show:', this.tileset.show);
                        console.log('- Tileset ready:', this.tileset.ready);
                        console.log('- Scene primitives count:', this.viewer.scene.primitives.length);
                    }, 2000);
                    
                } catch (error) {
                    console.error('=== FAILED TO LOAD GOOGLE 3D TILES ===', error);
                    console.log('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    console.log('Falling back to Cesium World Imagery...');
                    
                    // Fallback to Cesium World Imagery (more reliable)
                    try {
                        console.log('Using Cesium World Imagery as fallback...');
                        const worldImageryProvider = new Cesium.IonImageryProvider({ assetId: 1 });
                        this.viewer.imageryLayers.removeAll();
                        this.viewer.imageryLayers.addImageryProvider(worldImageryProvider);
                        console.log('Cesium World Imagery loaded as fallback');
                    } catch (fallbackError) {
                        console.error('Cesium World Imagery failed, trying OpenStreetMap:', fallbackError);
                        
                        // Final fallback to OpenStreetMap
                        try {
                            const osmProvider = new Cesium.OpenStreetMapImageryProvider({
                                url: 'https://a.tile.openstreetmap.org/'
                            });
                            this.viewer.imageryLayers.removeAll();
                            this.viewer.imageryLayers.addImageryProvider(osmProvider);
                            console.log('OpenStreetMap loaded as final fallback');
                        } catch (osmError) {
                            console.error('All imagery providers failed:', osmError);
                        }
                    }
                }
            }

            async loadHazardData() {
                try {
                    console.log('=== DEBUG: Loading hazard data ===');
                    
                    // Load CSV first to get allowed sources
                    const csvPath = './Documents/BEO OEHSA CSM Injects copy.csv';
                    console.log('Loading CSV from:', csvPath);
                    let csvSources = null;
                    try {
                        csvSources = await this.dataLoader.loadCSV(csvPath);
                        console.log('CSV sources loaded:', csvSources);
                    } catch (csvError) {
                        console.warn('Failed to load CSV file, proceeding without filtering:', csvError);
                        // Continue without CSV filtering if file not found
                    }
                    
                    console.log('Data file path:', this.config.dataFile);
                    console.log('DataLoader object:', this.dataLoader);
                    
                    // Test if we can fetch the file directly first
                    console.log('Testing direct fetch...');
                    const response = await fetch(this.config.dataFile);
                    console.log('Fetch response status:', response.status);
                    console.log('Fetch response ok:', response.ok);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const rawData = await response.json();
                    console.log('Direct fetch successful, raw data:', rawData);
                    
                    // Load GeoJSON data using DataLoader with CSV filtering
                    console.log('Loading with DataLoader...');
                    const hazardData = await this.dataLoader.loadGeoJSON(this.config.dataFile, csvSources);
                    console.log('DataLoader result:', hazardData);
                    
                    // Process hazard data with coordinate conversion
                    const processedFeatures = this.processHazardDataWithCoordinateConversion(hazardData.features);
                    
                    // Store the processed data
                    this.hazardFeatures = processedFeatures;
                    // Store for navigation, sorted by hazard ID (H1, H2, H3, etc.)
                    this.hazardData = processedFeatures.sort((a, b) => {
                        // Extract number from hazard_id (e.g., "H1" -> 1, "H2" -> 2)
                        const aNum = parseInt(a.properties.hazard_id.replace('H', ''));
                        const bNum = parseInt(b.properties.hazard_id.replace('H', ''));
                        return aNum - bNum;
                    });
                    console.log('Hazard features stored:', this.hazardFeatures);
                    console.log('Number of features:', this.hazardFeatures ? this.hazardFeatures.length : 'undefined');
                    
                    // Log statistics
                    const stats = this.dataLoader.getStatistics();
                    console.log('Hazard data loaded successfully:', stats);
                    console.log('Hazard features array:', this.hazardFeatures);
                    console.log('Number of hazard features:', this.hazardFeatures.length);
                    
                    // Update UI with hazard count
                    this.updateHazardCount(stats.totalHazards);
                    
                    // Render hazards on the map
                    console.log('=== DEBUG: Rendering hazards ===');
                    this.renderHazards();
                    
                } catch (error) {
                    console.error('=== FAILED TO LOAD HAZARD DATA ===', error);
                    console.log('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    // Don't throw error - allow map to load without data
                    this.updateHazardCount(0);
                }
            }

            updateHazardCount(count) {
                const countElement = document.getElementById('hazardCount');
                if (countElement) {
                    countElement.textContent = `${count} hazards visible`;
                }
            }

            setupEventListeners() {
                console.log('Setting up event listeners...');
                
                // Add navigation event listeners
                const prevHazardBtn = document.getElementById('prevHazard');
                const nextHazardBtn = document.getElementById('nextHazard');
                
                if (prevHazardBtn) {
                    prevHazardBtn.addEventListener('click', () => {
                        this.navigateToHazard(-1);
                    });
                }
                
                if (nextHazardBtn) {
                    nextHazardBtn.addEventListener('click', () => {
                        this.navigateToHazard(1);
                    });
                }
                
                // Add event listeners for map controls
                const zoomInBtn = document.getElementById('zoomIn');
                const zoomOutBtn = document.getElementById('zoomOut');
                const resetViewBtn = document.getElementById('resetView');
                
                if (zoomInBtn) {
                    zoomInBtn.addEventListener('click', () => {
                        this.viewer.camera.zoomIn(this.viewer.camera.positionCartographic.height * 0.5);
                    });
                }
                
                if (zoomOutBtn) {
                    zoomOutBtn.addEventListener('click', () => {
                        this.viewer.camera.zoomOut(this.viewer.camera.positionCartographic.height * 2);
                    });
                }
                
                if (resetViewBtn) {
                    resetViewBtn.addEventListener('click', () => {
                        this.viewer.camera.setView({
                            destination: Cesium.Cartesian3.fromDegrees(
                                this.config.initialPosition.longitude,
                                this.config.initialPosition.latitude,
                                this.config.initialPosition.height
                            ),
                            orientation: {
                                heading: 0.0,
                                pitch: Cesium.Math.toRadians(-90),
                                roll: 0.0
                            }
                        });
                    });
                }
            }

            setupInfoBoxListeners() {
                console.log('Setting up info box listeners...');
                // Add event listeners for info boxes
                const closeInfoBox = document.getElementById('closeInfoBox');
                if (closeInfoBox) {
                    closeInfoBox.addEventListener('click', () => {
                        const clickInfoBox = document.getElementById('clickInfoBox');
                        if (clickInfoBox) {
                            clickInfoBox.classList.add('hidden');
                        }
                        // Stop proximity checking when info panel is closed
                        this.stopProximityCheck();
                        this.currentHazardEntity = null;
                    });
                }

                // Add Cesium click handler for entities
                this.viewer.cesiumWidget.screenSpaceEventHandler.setInputAction((click) => {
                    const pickedObject = this.viewer.scene.pick(click.position);
                    console.log('[ClickDebug] Click detected, picked object:', pickedObject);
                    
                    if (pickedObject && pickedObject.id) {
                        console.log('[ClickDebug] Picked entity ID:', pickedObject.id.id);
                        console.log('[ClickDebug] Has clickHandler:', !!pickedObject.id.clickHandler);
                        
                        if (pickedObject.id.clickHandler) {
                            console.log('[ClickDebug] Calling click handler for:', pickedObject.id.id);
                        pickedObject.id.clickHandler(pickedObject.id);
                        } else {
                            console.log('[ClickDebug] No click handler found for:', pickedObject.id.id);
                        }
                    } else {
                        console.log('[ClickDebug] No entity picked or no ID found');
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
            }

            clearHazards() {
                console.log('Clearing existing hazards...');
                // Remove all entities that start with 'hazard-'
                const entities = this.viewer.entities.values;
                for (let i = entities.length - 1; i >= 0; i--) {
                    const entity = entities[i];
                    if (entity.id && entity.id.startsWith('hazard-')) {
                        this.viewer.entities.remove(entity);
                    }
                }
                console.log('Existing hazards cleared');
            }

            renderHazards() {
                console.log('=== DEBUG: renderHazards called ===');
                console.log('Hazard features:', this.hazardFeatures);
                console.log('Hazard features length:', this.hazardFeatures ? this.hazardFeatures.length : 'undefined');
                
                if (!this.hazardFeatures || this.hazardFeatures.length === 0) {
                    console.log('No hazard features to render');
                    return;
                }

                console.log(`Rendering ${this.hazardFeatures.length} hazard features...`);
                console.log('Hazard features:', this.hazardFeatures);

                // Clear existing hazards
                this.clearHazards();

                // Render each hazard
                this.hazardFeatures.forEach((feature, index) => {
                    console.log(`Rendering hazard ${index}:`, feature.properties);
                    this.renderHazardFeature(feature, index);
                });

                console.log('Hazard rendering complete');
                
                // Log all pin coordinates
                this.logAllPinCoordinates();
                
                // Force zoom to hazards to make sure they're visible
                console.log('Zooming to hazard area...');
                this.zoomToAllHazards();
            }

            renderHazardFeature(feature, index) {
                let pinEntity = null;
                    const props = feature.properties;
                
                try {
                    
                    // Get coordinates (already converted to WGS84)
                    const coordsRoot = feature && feature.geometry && feature.geometry.coordinates;
                    let coordinates = null;
                    if (Array.isArray(coordsRoot) && coordsRoot.length > 0) {
                        // For Polygon: [ring]
                        // For MultiPolygon: [[ring], [ring], ...] => take first polygon's first ring
                        coordinates = coordsRoot[0];
                        if (Array.isArray(coordinates) && coordinates.length > 0 && Array.isArray(coordinates[0]) && Array.isArray(coordinates[0][0])) {
                            coordinates = coordinates[0];
                        }
                    }
                    
                    // Handle empty coordinates (like Gym Sauna) - use a fallback coordinate
                    if (!Array.isArray(coordinates) || coordinates.length < 3) {
                        console.warn(`[HazardGeom] Invalid or empty coordinates for hazard ${index}:`, coordinates);
                        console.log(`[HazardGeom] Using fallback coordinate for ${props.display_name}`);
                        // Use a fallback coordinate near Hill Air Force Base
                        coordinates = [
                            [-111.9731, 41.1234], // Base coordinates
                            [-111.9721, 41.1234], // Slightly offset
                            [-111.9721, 41.1224], // Create a small triangle
                            [-111.9731, 41.1234]  // Close the polygon
                        ];
                    }
                    
                    // Filter out invalid coordinates
                    const validCoords = coordinates.filter(coord => {
                        return Array.isArray(coord) && 
                            coord.length >= 2 && 
                            !isNaN(coord[0]) && 
                            !isNaN(coord[1]) &&
                            coord[0] >= -180 && coord[0] <= 180 &&
                            coord[1] >= -90 && coord[1] <= 90;
                    });
                    
                    if (validCoords.length < 3) {
                        console.warn(`[HazardGeom] Not enough valid coordinates for hazard ${index}:`, validCoords.length);
                        return;
                    }

                            // Calculate centroid from polygon coordinates
                            const lons = validCoords.map(coord => coord[0]);
                            const lats = validCoords.map(coord => coord[1]);
                            const avgLon = lons.reduce((sum, lon) => sum + lon, 0) / lons.length;
                            const avgLat = lats.reduce((sum, lat) => sum + lat, 0) / lats.length;
                    const centroid = [avgLon, avgLat];
                    
                    // Store centroid for navigation
                    props.centroid = centroid;
                    props.coordinates = validCoords;

                    console.log(`[HazardGeom] Rendering hazard ${props.hazard_id}: ${props.display_name}`);
                    console.log(`[HazardGeom] Centroid: ${avgLat.toFixed(6)}, ${avgLon.toFixed(6)}`);

                    // Create elevated pin marker - NO POLYGONS, PINS ONLY
                    pinEntity = this.viewer.entities.add({
                            id: `hazard-pin-${props.hazard_id}`,
                            name: `${props.display_name} - Pin`,
                            position: Cesium.Cartesian3.fromDegrees(
                                centroid[0], 
                                centroid[1], 
                            1000 // 1000 meters above ground - high enough to be visible above 3D tiles
                            ),
                            billboard: {
                                image: './src/assets/icons/MapPin02.png',
                            scale: 0.5,
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.ABSOLUTE,
                            disableDepthTestDistance: Number.POSITIVE_INFINITY,
                            scaleByDistance: new Cesium.NearFarScalar(1000, 0.5, 10000, 0.3),
                            distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, Number.MAX_VALUE)
                            },
                            properties: {
                                hazardData: props
                            }
                        });

                    // Create elevated label
                        const labelEntity = this.viewer.entities.add({
                            id: `hazard-label-${props.hazard_id}`,
                            name: `${props.display_name} - Label`,
                            position: Cesium.Cartesian3.fromDegrees(
                            centroid[0] + 0.0003, // Further to the right (about 30m)
                            centroid[1] + 0.0002, // Further up (about 20m north)
                            1020 // Higher than the pin - 1000m + 20m offset
                            ),
                            label: {
                    text: (() => {
                        let labelText = props.display_name || props.hazard_type;
                        // Special case for Legacy burn Pit to display as Legacy Burn Pit
                        if (labelText === 'Legacy burn Pit') {
                            labelText = 'Legacy Burn Pit';
                        }
                                // Special case for Municipal water system to display as Municipal Water System
                                if (labelText === 'Municipal water system') {
                            labelText = 'Municipal Water System';
                        }
                        // Special case for 'arthropod Vectors to display as Arthropod Vectors
                        if (labelText === "'arthropod Vectors") {
                            labelText = 'Arthropod Vectors';
                        }
                        // Special case for Engine Testing Pad1 to display as Jet Engine Testing Pad
                        if (labelText === 'Engine Testing Pad1') {
                            labelText = 'Jet Engine Testing Pad';
                        }
                        // Special case for Histoic Landfill to display as Historic Landfill
                        if (labelText === 'Histoic Landfill') {
                            labelText = 'Historic Landfill';
                        }
                        // Special case for Feild Training Area to display as Field Training Area
                        if (labelText === 'Feild Training Area') {
                            labelText = 'Field Training Area';
                        }
                        // Special case for Feild Water System to display as Field Water System
                        if (labelText === 'Feild Water System') {
                            labelText = 'Field Water System';
                        }
                        return labelText;
                    })(),
                                font: '16pt sans-serif',
                                fillColor: Cesium.Color.BLACK,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 3,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                scale: 1.0,
                                disableDepthTestDistance: Number.POSITIVE_INFINITY,
                                backgroundColor: Cesium.Color.WHITE.withAlpha(0.95),
                                backgroundPadding: new Cesium.Cartesian2(12, 6),
                                showBackground: true,
                                horizontalOrigin: Cesium.HorizontalOrigin.LEFT,
                                verticalOrigin: Cesium.VerticalOrigin.CENTER,
                            heightReference: Cesium.HeightReference.ABSOLUTE,
                            distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, Number.MAX_VALUE)
                            },
                            properties: {
                                hazardData: props
                            }
                        });

                    // Removed obsolete polygon debug logs

                    console.log(`Successfully created hazard ${index}: ${props.hazard_id}`);

                } catch (error) {
                    console.error(`Error rendering hazard feature ${index}:`, error);
                    console.error(`Error details:`, error.message, error.stack);
                }
                
                // Add click handlers for pin only (no polygon) - OUTSIDE try-catch
                if (pinEntity) {
                    try {
                        this.addHazardClickHandlers(null, pinEntity, props);
                        console.log(`Click handler attached for hazard ${index}: ${props.hazard_id}`);
                    } catch (error) {
                        console.error(`Error attaching click handler for hazard ${index}:`, error);
                    }
                } else {
                    console.error(`No pin entity created for hazard ${index}: ${props.hazard_id}`);
                }
            }

            createHazardIcon(props) {
                // Create a simple colored circle icon
                const canvas = document.createElement('canvas');
                canvas.width = 64; // Larger canvas
                canvas.height = 64;
                const ctx = canvas.getContext('2d');

                // Draw circle
                ctx.beginPath();
                ctx.arc(32, 32, 28, 0, 2 * Math.PI); // Larger circle
                ctx.fillStyle = props.color;
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 6; // Thicker border
                ctx.stroke();

                // Add severity indicator (inner circle)
                ctx.beginPath();
                ctx.arc(32, 32, 16, 0, 2 * Math.PI); // Larger inner circle
                ctx.fillStyle = this.getSeverityColor(props.severity_level);
                ctx.fill();

                return canvas.toDataURL();
            }

            getSeverityColor(severity) {
                const colors = {
                    1: '#2ecc71', // Green
                    2: '#f1c40f', // Yellow
                    3: '#e67e22', // Orange
                    4: '#e74c3c', // Red
                    5: '#8e44ad'  // Purple
                };
                return colors[severity] || '#95a5a6';
            }

            addHazardClickHandlers(polygonEntity, pinEntity, props) {
                // Add click handler for pin only (polygons removed)
                const clickHandler = (clickedEntity) => {
                    console.log(`[HazardNav] Clicked on hazard: ${props.hazard_id}`);
                    
                    // Stop proximity checking during zoom to prevent flashing
                    this.stopProximityCheck();
                    
                    this.showHazardInfo(props, clickedEntity, false);
                    
                    // Zoom to the clicked hazard
                    this.zoomToHazard(clickedEntity, props);
                };

                // Store click handler for polygon (if exists)
                if (polygonEntity) {
                polygonEntity.clickHandler = clickHandler;
                }
                
                // Store click handler for pin (always exists)
                if (pinEntity) {
                    pinEntity.clickHandler = clickHandler;
                }
            }

            zoomToHazard(entity, props) {
                console.log('=== ZOOM TO HAZARD CALLED ===');
                console.log('Entity ID:', entity.id);
                console.log('Entity type:', entity.id ? entity.id.split('-')[1] : 'unknown');
                console.log('Entity name:', entity.name);
                console.log('Props:', props);
                
                try {
                    let entityPosition = null;
                    
                    // Try to get position from entity.position (for pins)
                    if (entity.position && typeof entity.position.getValue === 'function') {
                        entityPosition = entity.position.getValue(Cesium.JulianDate.now());
                        console.log('Got position from entity.position:', entityPosition);
                    }
                    
                    // If no position from entity.position, try to get from polygon hierarchy (for polygons)
                    if (!entityPosition && entity.polygon && entity.polygon.hierarchy) {
                        const hierarchy = entity.polygon.hierarchy.getValue(Cesium.JulianDate.now());
                        if (hierarchy && hierarchy.positions && hierarchy.positions.length > 0) {
                            // Calculate center of polygon
                            let centerX = 0, centerY = 0, centerZ = 0;
                            hierarchy.positions.forEach(pos => {
                                centerX += pos.x;
                                centerY += pos.y;
                                centerZ += pos.z;
                            });
                            centerX /= hierarchy.positions.length;
                            centerY /= hierarchy.positions.length;
                            centerZ /= hierarchy.positions.length;
                            
                            entityPosition = new Cesium.Cartesian3(centerX, centerY, centerZ);
                            console.log('Calculated center from polygon hierarchy:', entityPosition);
                        }
                    }
                    
                    // If still no position, try bounding sphere center
                    if (!entityPosition && entity.boundingSphere) {
                        entityPosition = entity.boundingSphere.center;
                        console.log('Using bounding sphere center:', entityPosition);
                    }
                    
                    if (entityPosition) {
                        console.log('=== ENTITY POSITION DEBUG ===');
                        console.log('Entity position (Cartesian3):', entityPosition);
                        console.log('Entity position x:', entityPosition.x);
                        console.log('Entity position y:', entityPosition.y);
                        console.log('Entity position z:', entityPosition.z);
                        
                        // Convert to lat/lon for verification
                        const cartographic = Cesium.Cartographic.fromCartesian(entityPosition);
                        const lat = Cesium.Math.toDegrees(cartographic.latitude);
                        const lon = Cesium.Math.toDegrees(cartographic.longitude);
                        console.log('Entity location (lat/lon):', lat.toFixed(6) + '¬∞N, ' + lon.toFixed(6) + '¬∞W');
                        
                        // Use lat/lon coordinates with overhead view - adjusted for elevated pins
                        const height = Math.max(1500, 2500); // Minimum 1500m for elevated pins
                        console.log('Creating target position with lat/lon:', lat.toFixed(6), lon.toFixed(6), `height: ${height}m`);
                        const targetPosition = Cesium.Cartesian3.fromDegrees(lon, lat, height);
                        console.log('Target position created:', targetPosition);
                        
                        console.log('=== TARGET CAMERA POSITION DEBUG ===');
                        console.log('Target position (Cartesian3):', targetPosition);
                        console.log('Target position x:', targetPosition.x);
                        console.log('Target position y:', targetPosition.y);
                        console.log('Target position z:', targetPosition.z);
                        
                        // Convert target position to lat/lon for verification
                        const targetCartographic = Cesium.Cartographic.fromCartesian(targetPosition);
                        const targetLat = Cesium.Math.toDegrees(targetCartographic.latitude);
                        const targetLon = Cesium.Math.toDegrees(targetCartographic.longitude);
                        console.log('Target camera location (lat/lon):', targetLat.toFixed(6) + '¬∞N, ' + targetLon.toFixed(6) + '¬∞W');
                        console.log('Target camera height:', targetCartographic.height.toFixed(2) + 'm');
                        
                        // Log current camera position for comparison
                        const currentPosition = this.viewer.camera.position;
                        const currentCartographic = Cesium.Cartographic.fromCartesian(currentPosition);
                        const currentLat = Cesium.Math.toDegrees(currentCartographic.latitude);
                        const currentLon = Cesium.Math.toDegrees(currentCartographic.longitude);
                        console.log('Current camera location:', currentLat.toFixed(6) + '¬∞N, ' + currentLon.toFixed(6) + '¬∞W');
                        console.log('Current camera height:', currentCartographic.height.toFixed(2) + 'm');
                        
                        // Fly directly to the Cartesian3 position with overhead view
                        this.viewer.camera.flyTo({
                            destination: targetPosition,
                            orientation: {
                                heading: 0.0,
                                pitch: Cesium.Math.toRadians(-90), // Straight down overhead view
                                roll: 0.0
                            },
                            duration: 2.5
                        });
                        
                        // Use a timeout to check final position after animation
                        setTimeout(() => {
                            console.log('=== CAMERA FLYTO COMPLETED (after 2.5s) ===');
                            const finalPosition = this.viewer.camera.position;
                            const finalCartographic = Cesium.Cartographic.fromCartesian(finalPosition);
                            const finalLat = Cesium.Math.toDegrees(finalCartographic.latitude);
                            const finalLon = Cesium.Math.toDegrees(finalCartographic.longitude);
                            console.log('Final camera location:', finalLat.toFixed(6) + '¬∞N, ' + finalLon.toFixed(6) + '¬∞W');
                            console.log('Final camera height:', finalCartographic.height.toFixed(2) + 'm');
                            
                            // Restart proximity checking after zoom completes
                            this.startProximityCheck();
                        }, 2500);
                        
                        console.log('Camera flyTo initiated to target position');
                        return;
                    }
                    
                    // Final fallback: use bounding sphere if available
                    const boundingSphere = entity.boundingSphere;
                    if (boundingSphere) {
                        console.log('=== BOUNDING SPHERE DEBUG ===');
                        console.log('Using bounding sphere for zoom');
                        console.log('Bounding sphere center:', boundingSphere.center);
                        console.log('Bounding sphere radius:', boundingSphere.radius);
                        
                        this.viewer.camera.viewBoundingSphere(
                            boundingSphere, 
                            new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 2000)
                        );
                        return;
                    }
                    
                    console.log('No position or bounding sphere available');
                    
                } catch (error) {
                    console.error('Error zooming to hazard:', error);
                }
            }

            calculatePolygonBounds(coordinates) {
                if (!coordinates || coordinates.length < 2) {
                    return { width: 1000, height: 1000 }; // Default size
                }
                
                let minLon = coordinates[0][0];
                let maxLon = coordinates[0][0];
                let minLat = coordinates[0][1];
                let maxLat = coordinates[0][1];
                
                // Find bounds
                for (let i = 1; i < coordinates.length; i++) {
                    const [lon, lat] = coordinates[i];
                    minLon = Math.min(minLon, lon);
                    maxLon = Math.max(maxLon, lon);
                    minLat = Math.min(minLat, lat);
                    maxLat = Math.max(maxLat, lat);
                }
                
                // Convert to meters (approximate)
                const centerLat = (minLat + maxLat) / 2;
                const latToMeters = 111320; // meters per degree latitude
                const lonToMeters = 111320 * Math.cos(centerLat * Math.PI / 180); // meters per degree longitude
                
                const width = (maxLon - minLon) * lonToMeters;
                const height = (maxLat - minLat) * latToMeters;
                
                return { width, height };
            }

            zoomToAllHazards() {
                try {
                    // Get all hazard entities
                    const hazardEntities = this.viewer.entities.values.filter(entity => 
                        entity.id && entity.id.startsWith('H')
                    );
                    
                    if (hazardEntities.length > 0) {
                        // Create a bounding sphere that encompasses all hazards
                        const boundingSpheres = hazardEntities
                            .map(entity => entity.boundingSphere)
                            .filter(bs => bs !== undefined);
                        
                        if (boundingSpheres.length > 0) {
                            // Calculate combined bounding sphere
                            const combinedBoundingSphere = Cesium.BoundingSphere.fromBoundingSpheres(boundingSpheres);
                            
                            // Set camera to view all hazards with proper distance
                            const distance = Math.max(combinedBoundingSphere.radius * 2, 5000); // At least 5km
                            
                            this.viewer.camera.viewBoundingSphere(combinedBoundingSphere, new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-45), distance));
                            
                            console.log(`Zoomed to all hazards at distance: ${distance}m`);
                        } else {
                            // Fallback to initial position
                            this.viewer.camera.setView({
                                destination: Cesium.Cartesian3.fromDegrees(
                                    this.config.initialPosition.longitude,
                                    this.config.initialPosition.latitude,
                                    this.config.initialPosition.height
                                ),
                                orientation: {
                                    heading: 0.0,
                                    pitch: Cesium.Math.toRadians(-90),
                                    roll: 0.0
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error zooming to all hazards:', error);
                    // Fallback to initial position
                    this.viewer.camera.setView({
                        destination: Cesium.Cartesian3.fromDegrees(
                            this.config.initialPosition.longitude,
                            this.config.initialPosition.latitude,
                            this.config.initialPosition.height
                        ),
                        orientation: {
                            heading: 0.0,
                            pitch: Cesium.Math.toRadians(-90),
                            roll: 0.0
                        }
                    });
                }
            }

            logAllPinCoordinates() {
                console.log('=== ALL PIN COORDINATES ===');
                const entities = this.viewer.entities.values;
                const pinEntities = entities.filter(entity => 
                    entity.id && entity.id.includes('hazard-pin')
                );
                
                pinEntities.forEach((pinEntity, index) => {
                    const pinPosition = pinEntity.position.getValue(Cesium.JulianDate.now());
                    if (pinPosition) {
                        const cartographic = Cesium.Cartographic.fromCartesian(pinPosition);
                        const lat = Cesium.Math.toDegrees(cartographic.latitude);
                        const lon = Cesium.Math.toDegrees(cartographic.longitude);
                        
                        console.log(`${index + 1}. ${pinEntity.name}:`);
                        console.log(`   Latitude: ${lat.toFixed(6)}¬∞N`);
                        console.log(`   Longitude: ${lon.toFixed(6)}¬∞W`);
                        console.log(`   Hazard ID: ${pinEntity.id}`);
                        console.log('');
                    }
                });
                
                console.log('=== END PIN COORDINATES ===');
            }

            // Navigation methods
            navigateToHazard(direction) {
                console.log('=== NAVIGATION DEBUG ===');
                console.log('Direction:', direction);
                console.log('Current index:', this.currentHazardIndex);
                console.log('Hazard data length:', this.hazardData ? this.hazardData.length : 'undefined');
                console.log('Hazard data:', this.hazardData);
                
                if (!this.hazardData || this.hazardData.length === 0) {
                    console.error('No hazard data available for navigation');
                    return;
                }
                
                // Stop proximity checking during navigation to prevent interference
                this.stopProximityCheck();
                
                // Ensure currentHazardIndex is valid
                if (this.currentHazardIndex < 0 || this.currentHazardIndex >= this.hazardData.length) {
                    console.log('Invalid currentHazardIndex, resetting to 0');
                    this.currentHazardIndex = 0;
                }
                
                // Update current index
                const oldIndex = this.currentHazardIndex;
                this.currentHazardIndex += direction;
                
                // Wrap around
                if (this.currentHazardIndex < 0) {
                    this.currentHazardIndex = this.hazardData.length - 1;
                } else if (this.currentHazardIndex >= this.hazardData.length) {
                    this.currentHazardIndex = 0;
                }
                
                console.log('Navigation: Index changed from', oldIndex, 'to', this.currentHazardIndex);
                
                // Get current hazard data
                const currentHazard = this.hazardData[this.currentHazardIndex];
                console.log('Current hazard:', currentHazard);
                
                if (!currentHazard) {
                    console.error('No hazard found at index:', this.currentHazardIndex);
                    return;
                }
                
                // Update counter - use actual hazard ID number instead of index
                const counterElement = document.getElementById('hazardCounter');
                if (counterElement && currentHazard) {
                    // Extract number from hazard_id (e.g., "H3" -> 3)
                    const hazardIdNum = parseInt(currentHazard.properties.hazard_id.replace('H', '')) || (this.currentHazardIndex + 1);
                    counterElement.textContent = `${hazardIdNum} of ${this.hazardData.length}`;
                }
                
                // Find and zoom to the hazard entity (pins only now)
                const hazardId = currentHazard.properties.hazard_id;
                console.log('Looking for entity with ID:', `hazard-pin-${hazardId}`);
                
                // Look for pin entity instead of polygon
                let pinEntity = this.viewer.entities.getById(`hazard-pin-${hazardId}`);
                
                if (!pinEntity) {
                    // Try alternative ID format
                    pinEntity = this.viewer.entities.getById(`hazard-pin-H${hazardId.replace('H', '')}`);
                }
                
                if (!pinEntity) {
                    // Search through all entities to find matching pin
                    const allEntities = this.viewer.entities.values;
                    pinEntity = allEntities.find(entity => 
                        entity.id && entity.id.includes('pin') && entity.id.includes(hazardId)
                    );
                }
                
                console.log('Found pin entity:', pinEntity);
                
                // Update info box and set current entity
                this.showHazardInfo(currentHazard.properties, pinEntity, false);
                    this.currentHazardEntity = pinEntity;
                
                // Zoom to the current hazard
                if (pinEntity) {
                    this.zoomToHazard(pinEntity, currentHazard.properties);
                } else {
                    console.log('No pin entity found, using coordinate fallback');
                    // Fallback: zoom to coordinates if entity not found
                    const coordinates = currentHazard.geometry.coordinates[0];
                    if (coordinates && coordinates.length > 0) {
                        this.zoomToHazardCoordinates(coordinates, currentHazard.properties);
                    } else {
                        console.error('No coordinates available for hazard:', currentHazard.properties.display_name);
                    }
                }
            }

            // Alternative zoom method using coordinates directly
            zoomToHazardCoordinates(coordinates, props) {
                console.log('=== ZOOM TO HAZARD COORDINATES ===');
                console.log('Coordinates:', coordinates);
                console.log('Props:', props);
                
                try {
                    // Calculate center of polygon (coordinates are already in WGS84)
                    let centerLat = 0;
                    let centerLon = 0;
                    let validCoords = 0;
                    
                    coordinates.forEach(coord => {
                        if (Array.isArray(coord) && coord.length >= 2 && !isNaN(coord[0]) && !isNaN(coord[1])) {
                        centerLon += coord[0];
                        centerLat += coord[1];
                            validCoords++;
                        }
                    });
                    
                    if (validCoords > 0) {
                        centerLon /= validCoords;
                        centerLat /= validCoords;
                    console.log('Calculated center:', centerLat.toFixed(6), centerLon.toFixed(6));
                    } else {
                        console.error('No valid coordinates found for fallback zoom');
                        return;
                    }
                    
                    // Create target position
                    const height = 2500;
                    const targetPosition = Cesium.Cartesian3.fromDegrees(centerLon, centerLat, height);
                    
                    console.log('Flying to coordinates:', centerLat.toFixed(6), centerLon.toFixed(6), `height: ${height}m`);
                    
                    // Fly to the calculated position
                    this.viewer.camera.flyTo({
                        destination: targetPosition,
                        orientation: {
                            heading: 0.0,
                            pitch: Cesium.Math.toRadians(-90), // Straight down overhead view
                            roll: 0.0
                        },
                        duration: 2.5
                    });
                    
                    console.log('Camera flyTo initiated to coordinates');
                    
                } catch (error) {
                    console.error('Error zooming to hazard coordinates:', error);
                }
            }

            updateNavigationButtons() {
                const prevBtn = document.getElementById('prevHazard');
                const nextBtn = document.getElementById('nextHazard');
                
                if (prevBtn && nextBtn) {
                    // Enable/disable buttons based on current position
                    prevBtn.disabled = this.hazardData.length <= 1;
                    nextBtn.disabled = this.hazardData.length <= 1;
                }
            }

            // Start proximity checking for info panel fade
            startProximityCheck() {
                if (this.proximityCheckInterval) {
                    clearInterval(this.proximityCheckInterval);
                }
                
                // Debounce proximity check to prevent infinite loops
                this.lastProximityCheck = 0;
                this.proximityCheckTimeout = null;
                const PROXIMITY_CHECK_DELAY = 1000; // 1 second delay between checks
                
                this.proximityCheckInterval = setInterval(() => {
                    const now = Date.now();
                    if (now - this.lastProximityCheck > PROXIMITY_CHECK_DELAY) {
                        if (this.proximityCheckTimeout) {
                            clearTimeout(this.proximityCheckTimeout);
                        }
                        this.proximityCheckTimeout = setTimeout(() => {
                            this.checkProximityToHazard();
                            this.lastProximityCheck = Date.now();
                        }, PROXIMITY_CHECK_DELAY);
                    }
                }, 2000); // Check every 2 seconds instead of 100ms
                
                // Also listen for camera movement to ensure proximity check continues
                this.viewer.camera.moveEnd.addEventListener(() => {
                    const now = Date.now();
                    if (now - this.lastProximityCheck > PROXIMITY_CHECK_DELAY) {
                        if (this.proximityCheckTimeout) {
                            clearTimeout(this.proximityCheckTimeout);
                        }
                        this.proximityCheckTimeout = setTimeout(() => {
                            this.checkProximityToHazard();
                            this.lastProximityCheck = Date.now();
                        }, PROXIMITY_CHECK_DELAY);
                    }
                });
            }

            // Stop proximity checking
            stopProximityCheck() {
                if (this.proximityCheckInterval) {
                    clearInterval(this.proximityCheckInterval);
                    this.proximityCheckInterval = null;
                }
                if (this.proximityCheckTimeout) {
                    clearTimeout(this.proximityCheckTimeout);
                    this.proximityCheckTimeout = null;
                }
                this.currentHazardEntity = null;
            }
            
            // Reset proximity check - useful for debugging
            resetProximityCheck() {
                console.log('Resetting proximity check...');
                this.stopProximityCheck();
                const infoBox = document.getElementById('clickInfoBox');
                if (infoBox) {
                    infoBox.style.opacity = '1';
                    infoBox.style.visibility = 'visible';
                }
            }

            // Check proximity to any hazard polygon
            checkProximityToHazard() {
                if (!this.viewer) {
                    return;
                }
                
                // Check if info box exists
                const infoBox = document.getElementById('clickInfoBox');
                if (!infoBox) {
                    console.log('Proximity check: Info box not found, stopping');
                    return;
                }
                
                // Don't stop if panel is hidden - we want to be able to make it visible again
                if (infoBox.style.display === 'none') {
                    console.log('Proximity check: Info box display is none, stopping');
                    return;
                }

                const cameraPosition = this.viewer.camera.position;
                let closestHazard = null;
                let closestDistance = Infinity;

                // Check all hazard entities to find the closest one (pins only now)
                this.viewer.entities.values.forEach(entity => {
                    if (entity.id && entity.id.startsWith('hazard-pin-')) {
                        // Get hazard position from pin
                        if (entity.position && typeof entity.position.getValue === 'function') {
                            const hazardPosition = entity.position.getValue(Cesium.JulianDate.now());
                        if (hazardPosition) {
                            const distance = Cesium.Cartesian3.distance(cameraPosition, hazardPosition);
                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestHazard = entity;
                                }
                            }
                        }
                    }
                });

                // If we found a hazard within range, show its info
                if (closestHazard && closestDistance <= this.fadeDistance) {
                    // Extract hazard ID from entity ID
                    const hazardId = closestHazard.id.replace('hazard-pin-', '');
                    
                    // Find the corresponding hazard data
                    const hazardData = this.hazardData.find(h => h.properties.hazard_id === hazardId);
                    if (hazardData) {
                        // Update current hazard index
                        this.currentHazardIndex = this.hazardData.indexOf(hazardData);
                        
                        // Show info for this hazard
                        this.showHazardInfo(hazardData.properties, closestHazard);
                        
                        // Keep at full opacity (no fade)
                        this.updateInfoPanelOpacity(1.0);
                        
                        console.log('Proximity check - Showing hazard:', hazardId, 'Distance:', closestDistance.toFixed(2), 'm');
                    }
                } else {
                    // No hazard in range, hide the panel
                    this.updateInfoPanelOpacity(0.0);
                    console.log('Proximity check - No hazard in range, hiding panel. Closest distance:', closestDistance.toFixed(2), 'm');
                }
            }

            // Update info panel opacity
            updateInfoPanelOpacity(opacity) {
                const infoBox = document.getElementById('clickInfoBox');
                if (infoBox) {
                    console.log('Updating info panel opacity to:', opacity);
                    infoBox.style.opacity = opacity;
                    infoBox.style.transition = 'opacity 0.3s ease-in-out';
                    
                    // If opacity is 0, hide the panel completely
                    if (opacity <= 0) {
                        infoBox.style.visibility = 'hidden';
                    } else {
                        infoBox.style.visibility = 'visible';
                    }
                    
                    console.log('Info panel visibility set to:', infoBox.style.visibility);
                }
            }

                showHazardInfo(props, entity, startProximityCheck = true) {
                    console.log('Showing hazard info:', props);
                    
                    // Set current hazard entity for proximity checking
                    this.currentHazardEntity = entity;
                    
                    // Start proximity checking only if requested (not during zoom)
                    if (startProximityCheck) {
                        this.startProximityCheck();
                    }
                    
                    // Update current hazard index if this is from a click
                    if (entity) {
                        const hazardId = props.hazard_id;
                        const hazardIndex = this.hazardData.findIndex(hazard => hazard.properties.hazard_id === hazardId);
                        if (hazardIndex !== -1) {
                            this.currentHazardIndex = hazardIndex;
                        }
                    }
                    
                    // Update counter - use actual hazard ID number instead of index
                    const counterElement = document.getElementById('hazardCounter');
                    if (counterElement && this.hazardData && this.hazardData.length > 0) {
                        // Extract number from hazard_id (e.g., "H3" -> 3)
                        const hazardIdNum = parseInt(props.hazard_id.replace('H', '')) || (this.currentHazardIndex + 1);
                        counterElement.textContent = `${hazardIdNum} of ${this.hazardData.length}`;
                    }
                    
                    // Update click info box
                    const clickInfoBox = document.getElementById('clickInfoBox');
                    if (clickInfoBox) {
                        // Get detailed information based on hazard ID/type
                        const detailedInfo = this.getDetailedHazardInfo(props);
                        
                        // Update all the info fields with actual data from GeoJSON
                        // Apply special case corrections BEFORE setting the title to prevent flashing
                        let displayTitle = props.display_name || props.hazard_type || 'Unknown Hazard';
                        
                        // Apply all special case corrections
                        if (displayTitle === 'Engine Testing Pad1') {
                            displayTitle = 'Jet Engine Testing Pad';
                        } else if (displayTitle === 'Histoic Landfill') {
                            displayTitle = 'Historic Landfill';
                        } else if (displayTitle === 'Feild Training Area') {
                            displayTitle = 'Field Training Area';
                        } else if (displayTitle === 'Feild Water System') {
                            displayTitle = 'Field Water System';
                        } else if (displayTitle === 'Legacy burn Pit') {
                            displayTitle = 'Legacy Burn Pit';
                        } else if (displayTitle === 'Municipal water system') {
                            displayTitle = 'Municipal Water System';
                        } else if (displayTitle === "'arthropod Vectors") {
                            displayTitle = 'Arthropod Vectors';
                        }
                        document.getElementById('infoBoxTitle').textContent = displayTitle;
                        document.getElementById('infoBoxMedium').textContent = detailedInfo.environmentalMedium || 'Not specified';
                        document.getElementById('infoBoxHealthThreat').textContent = detailedInfo.healthThreat;
                        document.getElementById('infoBoxExposureRoute').textContent = detailedInfo.exposureRoute;
                        document.getElementById('infoBoxPopulation').textContent = detailedInfo.populationAffected;
                        document.getElementById('infoBoxControls').textContent = detailedInfo.existingControls;
                        document.getElementById('infoBoxFreqDuration').textContent = detailedInfo.freqDuration;
                        document.getElementById('infoBoxSeverity').textContent = detailedInfo.severity || 'Unknown';
                        document.getElementById('infoBoxProbability').textContent = detailedInfo.probability;
                        
                        // Position the info box 250px to the right of the clicked entity
                        if (entity && entity.position) {
                            const entityPosition = entity.position.getValue(Cesium.JulianDate.now());
                            if (entityPosition) {
                                // Convert 3D position to screen coordinates using camera projection
                                let screenPosition = null;
                                try {
                                    screenPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(this.viewer.scene, entityPosition);
                                } catch (error) {
                                    console.log('wgs84ToWindowCoordinates not available, using fallback');
                                    screenPosition = null; // Will trigger fallback positioning
                                }
                                if (screenPosition) {
                                    // Position info box 250px to the left of the entity
                                    clickInfoBox.style.left = (screenPosition.x - 250) + 'px';
                                    clickInfoBox.style.top = (screenPosition.y - 50) + 'px'; // Center vertically
                                    clickInfoBox.style.right = 'auto'; // Remove right positioning
                                } else {
                                    // Fallback: position in top-left corner below title bar area
                                    clickInfoBox.style.left = '20px';
                                    clickInfoBox.style.top = '120px';
                                    clickInfoBox.style.right = 'auto';
                                }
                            } else {
                                // Fallback: position in top-left corner below title bar area
                                clickInfoBox.style.left = '20px';
                                clickInfoBox.style.top = '120px';
                                clickInfoBox.style.right = 'auto';
                            }
                        } else {
                            // Fallback: position in top-left corner below title bar area
                            clickInfoBox.style.left = '20px';
                            clickInfoBox.style.top = '120px';
                            clickInfoBox.style.right = 'auto';
                        }
                        
                        // Show the info box
                        clickInfoBox.classList.remove('hidden');
                    }
                    
                    // CSM form population removed - only happens when "Add Hazard" button is clicked
                }


                getDetailedHazardInfo(props) {
                    // Map hazard names to detailed BEO CSM information from Excel data
                    // Note: Detailed data comes from BEO OEHSA CSM Injects.xlsx file
                    const hazardDetails = {
                        1: {
                            source: "Engine Testing Pad1",
                            environmentalMedium: "Auditory",
                            healthThreat: "Noise-Induced Hearing Loss",
                            exposureRoute: "Auditory",
                            populationAffected: "Flightline Maintainers",
                            existingControls: "HPDs, duty limits",
                            freqDuration: "Daily/8hrs",
                            severity: "Critical (II)",
                            probability: "Frequent (A)",
                            risk: "Extremely High"
                        },
                        2: {
                            source: "Aircraft Fuel Tanks",
                            environmentalMedium: "Soil/Groundwater",
                            healthThreat: "Benzene exposure",
                            exposureRoute: "Inhalation, Dermal",
                            populationAffected: "Firefighters, POL",
                            existingControls: "Secondary containment",
                            freqDuration: "Daily/8 hrs",
                            severity: "Marginal (III)",
                            probability: "Occasional (C)",
                            risk: "Moderate"
                        },
                        3: {
                            source: "Legacy burn Pit",
                            environmentalMedium: "Soil/Air",
                            healthThreat: "Dioxins/PM",
                            exposureRoute: "Inhalation, Dermal",
                            populationAffected: "Nearby Housing",
                            existingControls: "Fence, ash cap",
                            freqDuration: "Legacy source",
                            severity: "Critical (II)",
                            probability: "Likely (B)",
                            risk: "High"
                        },
                        4: {
                            source: "Welding Shop",
                            environmentalMedium: "Air",
                            healthThreat: "Manganese/Cr6+",
                            exposureRoute: "Inhalation",
                            populationAffected: "Fabricators",
                            existingControls: "LEV, PPE, IH surveys",
                            freqDuration: "Weekly",
                            severity: "Critical (II)",
                            probability: "Frequent (A)",
                            risk: "Extremely High"
                        },
                        5: {
                            source: "Municipal water system",
                            environmentalMedium: "Surface Water",
                            healthThreat: "Pathogens, nutrients",
                            exposureRoute: "Ingestion, Dermal",
                            populationAffected: "Downstream community",
                            existingControls: "Chlorination, signage",
                            freqDuration: "Continuous",
                            severity: "Critical (II)",
                            probability: "Seldom (D)",
                            risk: "Moderate"
                        },
                        6: {
                            source: "Forest Fire",
                            environmentalMedium: "Air",
                            healthThreat: "PM2.5",
                            exposureRoute: "Inhalation",
                            populationAffected: "All base population",
                            existingControls: "AQI alerts",
                            freqDuration: "Annual",
                            severity: "Critical (II)",
                            probability: "Occasional (C)",
                            risk: "High"
                        },
                        7: {
                            source: "CATM Range",
                            environmentalMedium: "Soil",
                            healthThreat: "Lead, noise",
                            exposureRoute: "Inhalation, Ingestion",
                            populationAffected: "Instructors, trainees",
                            existingControls: "PPE, HEPA vacs",
                            freqDuration: "Daily",
                            severity: "Critical (II)",
                            probability: "Frequent (A)",
                            risk: "Extremely High"
                        },
                        8:                         {
                            source: "Fuel truck refueling",
                            environmentalMedium: "Air",
                            healthThreat: "VOC vapor, spills",
                            exposureRoute: "Inhalation, Dermal",
                            populationAffected: "POL, Drivers",
                            existingControls: "SOPs, spill kits",
                            freqDuration: "Daily/8 hrs",
                            severity: "Critical (II)",
                            probability: "Likely (B)",
                            risk: "High"
                        },
                        9: {
                            source: "Feild Water System",
                            environmentalMedium: "Surface Water",
                            healthThreat: "Propylene glycol",
                            exposureRoute: "Ingestion",
                            populationAffected: "Aquatic life, public",
                            existingControls: "Stormwater BMPs",
                            freqDuration: "Daily/8hrs",
                            severity: "Marginal (III)",
                            probability: "Occasional (C)",
                            risk: "Moderate"
                        },
                        10: {
                            source: "Warehouse",
                            environmentalMedium: "Indoor Air",
                            healthThreat: "Mold, dust",
                            exposureRoute: "Inhalation",
                            populationAffected: "Logistics workers",
                            existingControls: "Dehumidifiers, filters",
                            freqDuration: "Variable",
                            severity: "Marginal (III)",
                            probability: "Occasional (C)",
                            risk: "Moderate"
                        },
                        11: {
                            source: "Cryogenics Shop",
                            environmentalMedium: "Indoor Air",
                            healthThreat: "Asphyxiation",
                            exposureRoute: "Inhalation",
                            populationAffected: "Cryo techs",
                            existingControls: "Monitors, ventilation",
                            freqDuration: "Weekly tasks",
                            severity: "Catastrophic (I)",
                            probability: "Seldom (D)",
                            risk: "High"
                        },
                        12: {
                            source: "Histoic Landfill",
                            environmentalMedium: "Groundwater",
                            healthThreat: "Leachate (VOCs, metals)",
                            exposureRoute: "Ingestion",
                            populationAffected: "Community well users",
                            existingControls: "Monitoring wells",
                            freqDuration: "Dry Season",
                            severity: "Critical (II)",
                            probability: "Seldom (D)",
                            risk: "Moderate"
                        },
                        13: {
                            source: "Battery Storage",
                            environmentalMedium: "Air/Surface",
                            healthThreat: "Acid mist, Pb dust",
                            exposureRoute: "Dermal, Inhalation",
                            populationAffected: "Civil Engineers",
                            existingControls: "PPE, vent hoods",
                            freqDuration: "Daily/8hrs",
                            severity: "Marginal (III)",
                            probability: "Occasional (C)",
                            risk: "Moderate"
                        },
                        14: {
                            source: "Satellite Comms Dish",
                            environmentalMedium: "Radiation",
                            healthThreat: "RF hazard",
                            exposureRoute: "External",
                            populationAffected: "Comm technicians",
                            existingControls: "Time-distance-shielding",
                            freqDuration: "Weekly",
                            severity: "Marginal (III)",
                            probability: "Seldom (D)",
                            risk: "Low"
                        },
                        15:                         {
                            source: "Pest Control",
                            environmentalMedium: "Surfaces",
                            healthThreat: "Pesticide residues",
                            exposureRoute: "Dermal, Inhalation",
                            populationAffected: "Shoppers, workers",
                            existingControls: "SOPs, notifications",
                            freqDuration: "Monthly",
                            severity: "Marginal (III)",
                            probability: "Seldom (D)",
                            risk: "Low"
                        },
                        16: {
                            source: "Gym Sauna",
                            environmentalMedium: "Air",
                            healthThreat: "Mold spores, heat stress",
                            exposureRoute: "Inhalation",
                            populationAffected: "Athletes",
                            existingControls: "Time limits, cleaning",
                            freqDuration: "Daily",
                            severity: "Negligible (IV)",
                            probability: "Frequent (A)",
                            risk: "Moderate"
                        },
                        17:                         {
                            source: "Paint Shop",
                            environmentalMedium: "Air",
                            healthThreat: "Toluene, xylene",
                            exposureRoute: "Inhalation",
                            populationAffected: "Painters",
                            existingControls: "LEV, cartridge masks",
                            freqDuration: "Weekly",
                            severity: "Critical (II)",
                            probability: "Likely (B)",
                            risk: "High"
                        },
                        18:                         {
                            source: "Chemical Lab",
                            environmentalMedium: "Surfaces",
                            healthThreat: "Corrosives, toxics",
                            exposureRoute: "Dermal, Inhalation",
                            populationAffected: "Lab staff",
                            existingControls: "SOPs, eyewash",
                            freqDuration: "Weekly",
                            severity: "Critical (II)",
                            probability: "Occasional (C)",
                            risk: "High"
                        },
                        19: {
                            source: "Mechanical Shop",
                            environmentalMedium: "Air/Surfaces",
                            healthThreat: "Solvent vapors",
                            exposureRoute: "Inhalation",
                            populationAffected: "Maintainers",
                            existingControls: "LEV, respirators",
                            freqDuration: "Daily",
                            severity: "Marginal (III)",
                            probability: "Occasional (C)",
                            risk: "Moderate"
                        },
                        20: {
                            source: "Gate Area",
                            environmentalMedium: "Air",
                            healthThreat: "CO, particulates",
                            exposureRoute: "Inhalation",
                            populationAffected: "Commuters, gate guards",
                            existingControls: "Vehicle standards",
                            freqDuration: "Constant",
                            severity: "Marginal (III)",
                            probability: "Frequent (A)",
                            risk: "High"
                        },
                        21: {
                            source: "Feild Training Area",
                            environmentalMedium: "Soil/Dust",
                            healthThreat: "Valley fever (fungal spores)",
                            exposureRoute: "Inhalation",
                            populationAffected: "Trainees",
                            existingControls: "Watering, timing",
                            freqDuration: "Dry season",
                            severity: "Critical (II)",
                            probability: "Seldom (D)",
                            risk: "Moderate"
                        },
                        22: {
                            source: "Medical X ray",
                            environmentalMedium: "Radiation",
                            healthThreat: "Ionizing radiation",
                            exposureRoute: "External",
                            populationAffected: "Staff, patients",
                            existingControls: "Shielding, badges",
                            freqDuration: "Daily",
                            severity: "Critical (II)",
                            probability: "Unlikely (E)",
                            risk: "Low"
                        },
                        23: {
                            source: "HazMat Storage Area",
                            environmentalMedium: "Soil/Surfaces",
                            healthThreat: "Drip leaks",
                            exposureRoute: "Dermal",
                            populationAffected: "CE, HAZWASTE",
                            existingControls: "Spill pallets",
                            freqDuration: "Daily/8 hrs",
                            severity: "Marginal (III)",
                            probability: "Seldom (D)",
                            risk: "Low"
                        },
                        24: {
                            source: "Municipal Water Supply",
                            environmentalMedium: "Surface Water",
                            healthThreat: "Pathogens, nutrients",
                            exposureRoute: "Ingestion, Dermal",
                            populationAffected: "Downstream community",
                            existingControls: "Chlorination, signage",
                            freqDuration: "Continuous",
                            severity: "Critical (II)",
                            probability: "Seldom (D)",
                            risk: "Moderate"
                        },
                        25: {
                            source: "'arthropod Vectors",
                            environmentalMedium: "Air/Biological",
                            healthThreat: "Vector-borne disease",
                            exposureRoute: "Insect bites",
                            populationAffected: "Outdoor personnel",
                            existingControls: "Repellent, Bti spray",
                            freqDuration: "Summer",
                            severity: "Critical (II)",
                            probability: "Occasional (C)",
                            risk: "High"
                        }
                    };

                    // Get the hazard name from props (this comes from the GeoJSON Name field)
                    const hazardName = props.display_name || props.hazard_type || props.Name;
                    
                    // Map hazard names to detailed info
                    const nameToDetails = {
                        'Gate Area': hazardDetails[20],
                        'Gym Sauna': hazardDetails[16],
                        'Engine Testing Pad1': hazardDetails[1],
                        'Aircraft Fuel Tanks': hazardDetails[2],
                        'Legacy burn Pit': hazardDetails[3],
                        'Welding Shop': hazardDetails[4],
                        'Municipal water system': hazardDetails[5],
                        'Fuel truck refueling': hazardDetails[8],
                        'Forest Fire': hazardDetails[6],
                        'CATM Range': hazardDetails[7],
                        'Feild Water System': hazardDetails[9],
                        'Warehouse': hazardDetails[10],
                        'Histoic Landfill': hazardDetails[12],
                        'Cryogenics Shop': hazardDetails[11],
                        'Medical X ray': hazardDetails[22],
                        'Feild Training Area': hazardDetails[21],
                        'Battery Storage': hazardDetails[13],
                        'Satellite Comms Dish': hazardDetails[14],
                        'Pest Control': hazardDetails[15],
                        'Paint Shop': hazardDetails[17],
                        'Chemical Lab': hazardDetails[18],
                        'Mechanical Shop': hazardDetails[19],
                        'HazMat Storage Area': hazardDetails[23],
                        'Municipal Water Supply': hazardDetails[24],
                        "'arthropod Vectors": hazardDetails[25]
                    };
                    
                    // Return detailed info if available, otherwise use props
                    if (nameToDetails[hazardName]) {
                        return nameToDetails[hazardName];
                    } else {
                        // Fallback to original props with new structure
                        return {
                            source: props.display_name || props.hazard_type || 'Unknown Hazard',
                            environmentalMedium: props.environmental_medium || 'Unknown',
                            healthThreat: 'Assessment required',
                            exposureRoute: 'To be determined',
                            populationAffected: 'Base personnel',
                            existingControls: 'Under review',
                            freqDuration: 'Ongoing',
                            severity: props.severity_level || 'Unknown',
                            probability: 'To be assessed',
                            risk: 'Under evaluation'
                        };
                    }
                }
            }

        // CSM Form Manager
        class CSMFormManager {
            constructor() {
                this.hazardRows = [];
                this.formFields = [
                    'source',
                    'environmentalMedium',
                    'healthThreat',
                    'exposureRoute',
                    'populationAffected',
                    'existingControls',
                    'frequencyDuration',
                    'severity',
                    'probability',
                    'risk'
                ];
                this.initEventListeners();
                this.addInitialRow();
                this.setupScrollListener();
                this.lastComparisonResults = null;
            }

            getDetailedHazardInfo(props) {
                // Map hazard names to detailed BEO CSM information from Excel data
                // Note: Detailed data comes from BEO OEHSA CSM Injects.xlsx file
                const hazardDetails = {
                    1: {
                        source: "Engine Testing Pad1",
                        environmentalMedium: "Auditory",
                        healthThreat: "Noise-Induced Hearing Loss",
                        exposureRoute: "Auditory",
                        populationAffected: "Flightline Maintainers",
                        existingControls: "HPDs, duty limits",
                        freqDuration: "Daily/8hrs",
                        severity: "Critical (II)",
                        probability: "Frequent (A)",
                        risk: "Extremely High"
                    },
                    2: {
                        source: "Aircraft Fuel Tanks",
                        environmentalMedium: "Soil/Groundwater",
                        healthThreat: "Benzene exposure",
                        exposureRoute: "Inhalation, Dermal",
                        populationAffected: "Firefighters, POL",
                        existingControls: "Secondary containment",
                        freqDuration: "Daily/8 hrs",
                        severity: "Marginal (III)",
                        probability: "Occasional (C)",
                        risk: "Moderate"
                    },
                    3: {
                        source: "Legacy burn Pit",
                        environmentalMedium: "Soil/Air",
                        healthThreat: "Dioxins/PM",
                        exposureRoute: "Inhalation, Dermal",
                        populationAffected: "Nearby Housing",
                        existingControls: "Fence, ash cap",
                        freqDuration: "Seasonal wind",
                        severity: "Critical (II)",
                        probability: "Likely (B)",
                        risk: "High"
                    },
                    4: {
                        source: "Welding Shop",
                        environmentalMedium: "Air",
                        healthThreat: "Manganese/Cr6+",
                        exposureRoute: "Inhalation",
                        populationAffected: "Fabricators",
                        existingControls: "LEV, PPE, IH surveys",
                        freqDuration: "Weekly",
                        severity: "Critical (II)",
                        probability: "Frequent (A)",
                        risk: "Extremely High"
                    },
                    5: {
                        source: "Municipal water system",
                        environmentalMedium: "Surface Water",
                        healthThreat: "Pathogens, nutrients",
                        exposureRoute: "Ingestion, Dermal",
                        populationAffected: "Downstream community",
                        existingControls: "Chlorination, signage",
                        freqDuration: "Continuous",
                        severity: "Critical (II)",
                        probability: "Seldom (D)",
                        risk: "Moderate"
                    },
                    6: {
                        source: "Forest Fire",
                        environmentalMedium: "Air",
                        healthThreat: "PM2.5",
                        exposureRoute: "Inhalation",
                        populationAffected: "All base population",
                        existingControls: "AQI alerts",
                        freqDuration: "Annual",
                        severity: "Critical (II)",
                        probability: "Occasional (C)",
                        risk: "High"
                    },
                    7: {
                        source: "CATM Range",
                        environmentalMedium: "Soil",
                        healthThreat: "Lead, noise",
                        exposureRoute: "Inhalation, Ingestion",
                        populationAffected: "Instructors, trainees",
                        existingControls: "PPE, HEPA vacs",
                        freqDuration: "Daily",
                        severity: "Critical (II)",
                        probability: "Frequent (A)",
                        risk: "Extremely High"
                    },
                    8: {
                        source: "Fuel truck refueling",
                        environmentalMedium: "Air",
                        healthThreat: "VOC vapor, spills",
                        exposureRoute: "Inhalation, Dermal",
                        populationAffected: "POL, Drivers",
                        existingControls: "SOPs, spill kits",
                        freqDuration: "Daily/8 hrs",
                        severity: "Critical (II)",
                        probability: "Likely (B)",
                        risk: "High"
                    },
                    9: {
                        source: "Feild Water System",
                        environmentalMedium: "Surface Water",
                        healthThreat: "Propylene glycol",
                        exposureRoute: "Ingestion",
                        populationAffected: "Aquatic life, public",
                        existingControls: "Stormwater BMPs",
                        freqDuration: "Winter season",
                        severity: "Marginal (III)",
                        probability: "Occasional (C)",
                        risk: "Moderate"
                    },
                    10: {
                        source: "Warehouse",
                        environmentalMedium: "Indoor Air",
                        healthThreat: "Mold, dust",
                        exposureRoute: "Inhalation",
                        populationAffected: "Logistics workers",
                        existingControls: "Dehumidifiers, filters",
                        freqDuration: "Variable",
                        severity: "Marginal (III)",
                        probability: "Occasional (C)",
                        risk: "Moderate"
                    },
                    11: {
                        source: "Cryogenics Shop",
                        environmentalMedium: "Indoor Air",
                        healthThreat: "Asphyxiation",
                        exposureRoute: "Inhalation",
                        populationAffected: "Cryo techs",
                        existingControls: "Monitors, ventilation",
                        freqDuration: "Weekly tasks",
                        severity: "Catastrophic (I)",
                        probability: "Seldom (D)",
                        risk: "High"
                    },
                    12: {
                        source: "Histoic Landfill",
                        environmentalMedium: "Groundwater",
                        healthThreat: "Leachate (VOCs, metals)",
                        exposureRoute: "Ingestion",
                        populationAffected: "Community well users",
                        existingControls: "Monitoring wells",
                        freqDuration: "Dry Season",
                        severity: "Critical (II)",
                        probability: "Seldom (D)",
                        risk: "Moderate"
                    },
                    13: {
                        source: "Battery Storage",
                        environmentalMedium: "Air/Surface",
                        healthThreat: "Acid mist, Pb dust",
                        exposureRoute: "Dermal, Inhalation",
                        populationAffected: "Civil Engineers",
                        existingControls: "PPE, vent hoods",
                        freqDuration: "Daily/8hrs",
                        severity: "Marginal (III)",
                        probability: "Occasional (C)",
                        risk: "Moderate"
                    },
                    14: {
                        source: "Satellite Comms Dish",
                        environmentalMedium: "Radiation",
                        healthThreat: "RF hazard",
                        exposureRoute: "External",
                        populationAffected: "Comm technicians",
                        existingControls: "Time-distance-shielding",
                        freqDuration: "Weekly",
                        severity: "Marginal (III)",
                        probability: "Seldom (D)",
                        risk: "Low"
                    },
                    15: {
                        source: "Pest Control",
                        environmentalMedium: "Surfaces",
                        healthThreat: "Pesticide residues",
                        exposureRoute: "Dermal, Inhalation",
                        populationAffected: "Shoppers, workers",
                        existingControls: "SOPs, notifications",
                        freqDuration: "Monthly",
                        severity: "Marginal (III)",
                        probability: "Seldom (D)",
                        risk: "Low"
                    },
                    16: {
                        source: "Gym Sauna",
                        environmentalMedium: "Air",
                        healthThreat: "Mold spores, heat stress",
                        exposureRoute: "Inhalation",
                        populationAffected: "Athletes",
                        existingControls: "Time limits, cleaning",
                        freqDuration: "Daily",
                        severity: "Negligible (IV)",
                        probability: "Frequent (A)",
                        risk: "Moderate"
                    },
                    17: {
                        source: "Paint Shop",
                        environmentalMedium: "Air",
                        healthThreat: "Toluene, xylene",
                        exposureRoute: "Inhalation",
                        populationAffected: "Painters",
                        existingControls: "LEV, cartridge masks",
                        freqDuration: "Weekly",
                        severity: "Critical (II)",
                        probability: "Likely (B)",
                        risk: "High"
                    },
                    18: {
                        source: "Chemical Lab",
                        environmentalMedium: "Surfaces",
                        healthThreat: "Corrosives, toxics",
                        exposureRoute: "Dermal, Inhalation",
                        populationAffected: "Lab staff",
                        existingControls: "SOPs, eyewash",
                        freqDuration: "Daily/8 hrs",
                        severity: "Critical (II)",
                        probability: "Occasional (C)",
                        risk: "High"
                    },
                    19: {
                        source: "Mechanical Shop",
                        environmentalMedium: "Air/Surfaces",
                        healthThreat: "Solvent vapors",
                        exposureRoute: "Inhalation",
                        populationAffected: "Maintainers",
                        existingControls: "LEV, respirators",
                        freqDuration: "Daily",
                        severity: "Marginal (III)",
                        probability: "Occasional (C)",
                        risk: "Moderate"
                    },
                    20: {
                        source: "Gate Area",
                        environmentalMedium: "Air",
                        healthThreat: "CO, particulates",
                        exposureRoute: "Inhalation",
                        populationAffected: "Commuters, gate guards",
                        existingControls: "Vehicle standards",
                        freqDuration: "Constant",
                        severity: "Marginal (III)",
                        probability: "Frequent (A)",
                        risk: "High"
                    },
                    21: {
                        source: "Feild Training Area",
                        environmentalMedium: "Soil/Dust",
                        healthThreat: "Valley fever (fungal spores)",
                        exposureRoute: "Inhalation",
                        populationAffected: "Trainees",
                        existingControls: "Watering, timing",
                        freqDuration: "Dry season",
                        severity: "Critical (II)",
                        probability: "Seldom (D)",
                        risk: "Moderate"
                    },
                    22: {
                        source: "Medical X ray",
                        environmentalMedium: "Radiation",
                        healthThreat: "Ionizing radiation",
                        exposureRoute: "External",
                        populationAffected: "Staff, patients",
                        existingControls: "Shielding, badges",
                        freqDuration: "Daily",
                        severity: "Critical (II)",
                        probability: "Unlikely (E)",
                        risk: "Low"
                    },
                    23: {
                        source: "HazMat Storage Area",
                        environmentalMedium: "Soil/Surfaces",
                        healthThreat: "Drip leaks",
                        exposureRoute: "Dermal",
                        populationAffected: "CE, HAZWASTE",
                        existingControls: "Spill pallets",
                        freqDuration: "Daily/8 hrs",
                        severity: "Marginal (III)",
                        probability: "Seldom (D)",
                        risk: "Low"
                    },
                    24: {
                        source: "Municipal Water Supply",
                        environmentalMedium: "Surface Water",
                        healthThreat: "Pathogens, nutrients",
                        exposureRoute: "Ingestion, Dermal",
                        populationAffected: "Downstream community",
                        existingControls: "Chlorination, signage",
                        freqDuration: "Continuous",
                        severity: "Critical (II)",
                        probability: "Seldom (D)",
                        risk: "Moderate"
                    },
                    25: {
                        source: "'arthropod Vectors",
                        environmentalMedium: "Air/Biological",
                        healthThreat: "Vector-borne disease",
                        exposureRoute: "Insect bites",
                        populationAffected: "Outdoor personnel",
                        existingControls: "Repellent, Bti spray",
                        freqDuration: "Summer",
                        severity: "Critical (II)",
                        probability: "Occasional (C)",
                        risk: "High"
                    }
                };

                // Get the hazard name from props (this comes from the GeoJSON Name field)
                const hazardName = props.display_name || props.hazard_type || props.Name;
                
                // Map hazard names to detailed info
                const nameToDetails = {
                    'Gate Area': hazardDetails[20],
                    'Gym Sauna': hazardDetails[16],
                    'Engine Testing Pad1': hazardDetails[1],
                    'Aircraft Fuel Tanks': hazardDetails[2],
                    'Legacy burn Pit': hazardDetails[3],
                    'Welding Shop': hazardDetails[4],
                    'Municipal water system': hazardDetails[5],
                    'Fuel truck refueling': hazardDetails[8],
                    'Forest Fire': hazardDetails[6],
                    'CATM Range': hazardDetails[7],
                    'Feild Water System': hazardDetails[9],
                    'Warehouse': hazardDetails[10],
                    'Histoic Landfill': hazardDetails[12],
                    'Cryogenics Shop': hazardDetails[11],
                    'Medical X ray': hazardDetails[22],
                    'Feild Training Area': hazardDetails[21],
                    'Battery Storage': hazardDetails[13],
                    'Satellite Comms Dish': hazardDetails[14],
                    'Pest Control': hazardDetails[15],
                    'Paint Shop': hazardDetails[17],
                    'Chemical Lab': hazardDetails[18],
                    'Mechanical Shop': hazardDetails[19],
                    'HazMat Storage Area': hazardDetails[23],
                    'Municipal Water Supply': hazardDetails[24],
                    "'arthropod Vectors": hazardDetails[25]
                };
                
                // Return detailed info if available, otherwise use props
                if (nameToDetails[hazardName]) {
                    return nameToDetails[hazardName];
                } else {
                    // Fallback to original props with new structure
                    return {
                        source: props.display_name || props.hazard_type || 'Unknown Hazard',
                        environmentalMedium: props.environmental_medium || 'Unknown',
                        healthThreat: 'Assessment required',
                        exposureRoute: 'Assessment required',
                        populationAffected: 'Assessment required',
                        existingControls: 'Assessment required',
                        freqDuration: 'Assessment required',
                        severity: 'Assessment required',
                        probability: 'Assessment required',
                        risk: 'Assessment required'
                    };
                }
            }

            normalizeValue(value) {
                if (value === undefined || value === null) return '';
                return String(value).trim().replace(/\s+/g, ' ').toLowerCase();
            }

            formatFieldLabel(field) {
                const labels = {
                    source: 'Source',
                    environmentalMedium: 'Environmental Medium',
                    healthThreat: 'Health Threat',
                    exposureRoute: 'Exposure Route',
                    populationAffected: 'Population Affected',
                    existingControls: 'Existing Controls',
                    frequencyDuration: 'Frequency/Duration',
                    severity: 'Severity',
                    probability: 'Probability',
                    risk: 'Risk'
                };
                return labels[field] || field;
            }

            getReferenceCSMData() {
                if (!this.referenceDataCache) {
                    this.referenceDataCache = [
                        {
                            hazardId: 1,
                            source: 'Jet engine testing pad',
                            environmentalMedium: 'Auditory',
                            healthThreat: 'Noise-Induced Hearing Loss',
                            exposureRoute: 'Auditory',
                            populationAffected: 'Flightline Maintainers',
                            existingControls: 'HPDs, duty limits',
                            frequencyDuration: 'Daily/8 hrs',
                            severity: 'Critical (II)',
                            probability: 'Frequent (A)',
                            risk: 'Extremely High'
                        },
                        {
                            hazardId: 2,
                            source: 'Aircraft fuel tanks',
                            environmentalMedium: 'Soil/Groundwater',
                            healthThreat: 'Benzene exposure',
                            exposureRoute: 'Inhalation, Dermal',
                            populationAffected: 'Firefighters, POL',
                            existingControls: 'Secondary containment',
                            frequencyDuration: 'Daily/8 hrs',
                            severity: 'Marginal (III)',
                            probability: 'Occasional (C)',
                            risk: 'High'
                        },
                        {
                            hazardId: 3,
                            source: 'Chemical Lab',
                            environmentalMedium: 'Surfaces',
                            healthThreat: 'Corrosives, toxics',
                            exposureRoute: 'Dermal, Inhalation',
                            populationAffected: 'Lab staff',
                            existingControls: 'SOPs, eyewash',
                            frequencyDuration: 'Weekly',
                            severity: 'Critical (II)',
                            probability: 'Occasional (C)',
                            risk: 'High'
                        },
                        {
                            hazardId: 4,
                            source: 'HazMat Storage Area',
                            environmentalMedium: 'Soil/Surfaces',
                            healthThreat: 'Drip leaks',
                            exposureRoute: 'Dermal',
                            populationAffected: 'CE, HAZWASTE',
                            existingControls: 'Spill pallets',
                            frequencyDuration: 'Daily/8 hrs',
                            severity: 'Marginal (III)',
                            probability: 'Seldom (D)',
                            risk: 'High'
                        },
                        {
                            hazardId: 5,
                            source: 'Paint Shop',
                            environmentalMedium: 'Air',
                            healthThreat: 'Toluene, xylene',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Painters',
                            existingControls: 'LEV, cartridge masks',
                            frequencyDuration: 'Weekly',
                            severity: 'Critical (II)',
                            probability: 'Likely (B)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 6,
                            source: 'Welding shop',
                            environmentalMedium: 'Air',
                            healthThreat: 'Manganese/Cr6+',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Fabricators',
                            existingControls: 'LEV, PPE, IH surveys',
                            frequencyDuration: 'Weekly',
                            severity: 'Critical (II)',
                            probability: 'Frequent (A)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 7,
                            source: 'Municipal Water Supply',
                            environmentalMedium: 'Surface Water',
                            healthThreat: 'Pathogens, nutrients',
                            exposureRoute: 'Ingestion, Dermal',
                            populationAffected: 'Downstream community',
                            existingControls: 'Chlorination, signage',
                            frequencyDuration: 'Continuous',
                            severity: 'Critical (II)',
                            probability: 'Seldom (D)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 8,
                            source: 'Battery Storage',
                            environmentalMedium: 'Air/Surface',
                            healthThreat: 'Acid mist, Pb dust',
                            exposureRoute: 'Dermal, Inhalation',
                            populationAffected: 'Civil Engineers',
                            existingControls: 'PPE, vent hoods',
                            frequencyDuration: 'Daily/8 hrs',
                            severity: 'Marginal (III)',
                            probability: 'Occasional (C)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 9,
                            source: 'Cryogenics Shop',
                            environmentalMedium: 'Indoor Air',
                            healthThreat: 'Asphyxiation',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Cryo techs',
                            existingControls: 'Monitors, ventilation',
                            frequencyDuration: 'Weekly tasks',
                            severity: 'Catastrophic (I)',
                            probability: 'Seldom (D)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 10,
                            source: 'Fuel truck refueling',
                            environmentalMedium: 'Air',
                            healthThreat: 'VOC vapor, spills',
                            exposureRoute: 'Inhalation, Dermal',
                            populationAffected: 'POL, Drivers',
                            existingControls: 'SOPs, spill kits',
                            frequencyDuration: 'Daily/8 hrs',
                            severity: 'Critical (II)',
                            probability: 'Likely (B)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 11,
                            source: 'Satellite comms dish',
                            environmentalMedium: 'Radiation',
                            healthThreat: 'RF hazard',
                            exposureRoute: 'External',
                            populationAffected: 'Comm technicians',
                            existingControls: 'Time-distance-shielding',
                            frequencyDuration: 'Weekly',
                            severity: 'Marginal (III)',
                            probability: 'Seldom (D)',
                            risk: 'Moderate'
                        },
                        {
                            hazardId: 12,
                            source: 'Pest Control',
                            environmentalMedium: 'Surfaces',
                            healthThreat: 'Pesticide residues',
                            exposureRoute: 'Dermal, Inhalation',
                            populationAffected: 'Shoppers, workers',
                            existingControls: 'SOPs, notifications',
                            frequencyDuration: 'Monthly',
                            severity: 'Marginal (III)',
                            probability: 'Seldom (D)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 13,
                            source: 'Arthropod Vectors',
                            environmentalMedium: 'Air/Biological',
                            healthThreat: 'Vector-borne disease',
                            exposureRoute: 'Insect bites',
                            populationAffected: 'Outdoor personnel',
                            existingControls: 'Repellent, Bti spray',
                            frequencyDuration: 'Summer',
                            severity: 'Critical (II)',
                            probability: 'Occasional (C)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 14,
                            source: 'Gym Sauna',
                            environmentalMedium: 'Air',
                            healthThreat: 'Mold spores, heat stress',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Athletes',
                            existingControls: 'Time limits, cleaning',
                            frequencyDuration: 'Daily',
                            severity: 'Negligible (IV)',
                            probability: 'Frequent (A)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 15,
                            source: 'Medical X-ray',
                            environmentalMedium: 'Radiation',
                            healthThreat: 'Ionizing radiation',
                            exposureRoute: 'External',
                            populationAffected: 'Staff, patients',
                            existingControls: 'Shielding, badges',
                            frequencyDuration: 'Daily',
                            severity: 'Critical (II)',
                            probability: 'Unlikely (E)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 16,
                            source: 'Mechanical Shop',
                            environmentalMedium: 'Air/Surfaces',
                            healthThreat: 'Solvent vapors',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Maintainers',
                            existingControls: 'LEV, respirators',
                            frequencyDuration: 'Daily',
                            severity: 'Marginal (III)',
                            probability: 'Occasional (C)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 17,
                            source: 'Historic Landfill',
                            environmentalMedium: 'Groundwater',
                            healthThreat: 'Leachate (VOCs, metals)',
                            exposureRoute: 'Ingestion',
                            populationAffected: 'Community well users',
                            existingControls: 'Monitoring wells',
                            frequencyDuration: 'Dry season',
                            severity: 'Critical (II)',
                            probability: 'Seldom (D)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 18,
                            source: 'Field Training Area',
                            environmentalMedium: 'Soil/Dust',
                            healthThreat: 'Valley fever (fungal spores)',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Trainees',
                            existingControls: 'Watering, timing',
                            frequencyDuration: 'Dry season',
                            severity: 'Critical (II)',
                            probability: 'Seldom (D)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 19,
                            source: 'Field Water System',
                            environmentalMedium: 'Surface Water',
                            healthThreat: 'Propylene glycol',
                            exposureRoute: 'Ingestion',
                            populationAffected: 'Aquatic life, public',
                            existingControls: 'Stormwater BMPs',
                            frequencyDuration: 'Daily/8 hrs',
                            severity: 'Marginal (III)',
                            probability: 'Occasional (C)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 20,
                            source: 'CATM Range',
                            environmentalMedium: 'Soil',
                            healthThreat: 'Lead, noise',
                            exposureRoute: 'Inhalation, Ingestion',
                            populationAffected: 'Instructors, trainees',
                            existingControls: 'PPE, HEPA vacs',
                            frequencyDuration: 'Daily',
                            severity: 'Critical (II)',
                            probability: 'Frequent (A)',
                            risk: 'Extremely High'
                        },
                        {
                            hazardId: 21,
                            source: 'Forest Fire',
                            environmentalMedium: 'Air',
                            healthThreat: 'PM2.5',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'All base population',
                            existingControls: 'AQI alerts',
                            frequencyDuration: 'Annual',
                            severity: 'Critical (II)',
                            probability: 'Occasional (C)',
                            risk: 'High'
                        },
                        {
                            hazardId: 22,
                            source: 'Warehouse',
                            environmentalMedium: 'Indoor Air',
                            healthThreat: 'Mold, dust',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Logistics workers',
                            existingControls: 'Dehumidifiers, filters',
                            frequencyDuration: 'Variable',
                            severity: 'Marginal (III)',
                            probability: 'Occasional (C)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 23,
                            source: 'Legacy burn pit',
                            environmentalMedium: 'Soil/Air',
                            healthThreat: 'Dioxins/PM',
                            exposureRoute: 'Inhalation, Dermal',
                            populationAffected: 'Nearby Housing',
                            existingControls: 'Fence, ash cap',
                            frequencyDuration: 'Legacy source',
                            severity: 'Critical (II)',
                            probability: 'Likely (B)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 24,
                            source: 'Gate Area',
                            environmentalMedium: 'Air',
                            healthThreat: 'CO, particulates',
                            exposureRoute: 'Inhalation',
                            populationAffected: 'Commuters, gate guards',
                            existingControls: 'Vehicle standards',
                            frequencyDuration: 'Constant',
                            severity: 'Marginal (III)',
                            probability: 'Frequent (A)',
                            risk: 'Low'
                        },
                        {
                            hazardId: 25,
                            source: 'Municipal Water System',
                            environmentalMedium: 'Surface Water',
                            healthThreat: 'Pathogens, nutrients',
                            exposureRoute: 'Ingestion, Dermal',
                            populationAffected: 'Downstream community',
                            existingControls: 'Chlorination, signage',
                            frequencyDuration: 'Continuous',
                            severity: 'Critical (II)',
                            probability: 'Seldom (D)',
                            risk: 'Moderate'
                        }
                    ];
                }
                return this.referenceDataCache.map(item => ({ ...item }));
            }

            calculateMaxVisibleRows() {
                const wrapper = document.querySelector('.csm-form-table-wrapper');
                if (!wrapper) return 2; // fallback
                
                // Get the available height for the table content
                const wrapperHeight = wrapper.clientHeight;
                const headerHeight = 40; // Approximate header height
                const rowHeight = 35; // Approximate row height
                const padding = 20; // Padding and margins
                
                // Calculate how many rows can fit
                const availableHeight = wrapperHeight - headerHeight - padding;
                const maxRows = Math.floor(availableHeight / rowHeight);
                
                // Ensure we show at least 2 rows, but not more than 8
                return Math.max(2, Math.min(maxRows, 8));
            }

            initEventListeners() {
                document.getElementById('addHazardRow').addEventListener('click', () => {
                    this.addHazardRow();
                });

                document.getElementById('clearForm').addEventListener('click', () => {
                    this.clearForm();
                });

                document.getElementById('riskLevelOrder').addEventListener('click', () => {
                    this.showRiskLevelOrder();
                });

                document.getElementById('riskMatrix').addEventListener('click', () => {
                    this.showRiskMatrix();
                });

            }

            addInitialRow() {
                this.addHazardRow();
            }

            addHazardRow() {
                const newRow = {
                    id: this.hazardRows.length + 1,
                    hazardId: this.hazardRows.length + 1, // Sequential numbering
                    source: '',
                    environmentalMedium: '',
                    healthThreat: '',
                    exposureRoute: '',
                    populationAffected: '',
                    existingControls: '',
                    frequencyDuration: '',
                    severity: '',
                    probability: '',
                    risk: ''
                };
                this.hazardRows.push(newRow);
                this.renderRows();
                this.scrollToBottom();

                // Auto-populate the new row with current hazard data if available
                this.autoPopulateNewRow(newRow);
            }

            autoPopulateNewRow(newRow) {
                // Get the current hazard from the map application
                if (window.app && window.app.currentHazardEntity) {
                    const currentHazardProps = window.app.currentHazardEntity.properties;
                    if (currentHazardProps && currentHazardProps.hazardData) {
                        console.log('[CSM] Auto-populating new row with current hazard data');
                        
                        // Only populate the source field if it's empty (new row should be empty)
                        if (!newRow.source || newRow.source.trim() === '') {
                            newRow.source = currentHazardProps.hazardData.display_name || currentHazardProps.hazardData.hazard_type || '';
                            
                            // Update the form fields immediately
                            this.updateFormFields(newRow);
                            
                            console.log('[CSM] New row auto-populated with hazard source:', newRow.source);
                        } else {
                            console.log('[CSM] New row already has source value, not overriding:', newRow.source);
                        }
                    }
                }
            }

            renderRows(showAll = false) {
                const tbody = document.getElementById('csmFormBody');
                const wrapper = document.querySelector('.csm-form-table-wrapper');
                tbody.innerHTML = '';

                // Calculate how many rows can fit in the available space
                const maxVisibleRows = this.calculateMaxVisibleRows();
                
                // Show all rows if we have fewer than the max visible, otherwise show sliding window
                let rowsToShow;
                if (this.hazardRows.length <= maxVisibleRows) {
                    // Show all rows if we can fit them all
                    rowsToShow = this.hazardRows;
                    wrapper.classList.add('show-all');
                } else if (showAll) {
                    // Show all rows when manually scrolling - KEEP the show-all class
                    rowsToShow = this.hazardRows;
                    wrapper.classList.add('show-all');
                } else {
                    // Show sliding window with the calculated number of rows
                    rowsToShow = this.hazardRows.slice(-maxVisibleRows);
                    wrapper.classList.remove('show-all');
                }
                
                rowsToShow.forEach((row, displayIndex) => {
                    // Calculate the original index in the full array
                    let index;
                    if (this.hazardRows.length <= 2) {
                        index = displayIndex;
                    } else if (showAll) {
                        index = displayIndex;
                    } else {
                        index = this.hazardRows.length - 2 + displayIndex;
                    }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" data-field="hazardId" data-index="${index}" value="${row.hazardId}" readonly style="width: 100%; border: none; background: #f8f9fa; font-size: 14px; padding: 3px; text-align: center; font-weight: bold;"></td>
                        <td><select data-field="source" data-index="${index}">
                            <option value="">Select Source</option>
                            <option value="Arthropod Vectors" ${row.source === 'Arthropod Vectors' ? 'selected' : ''}>Arthropod Vectors</option>
                            <option value="CATM Range" ${row.source === 'CATM Range' ? 'selected' : ''}>CATM Range</option>
                            <option value="Field Training Area" ${row.source === 'Field Training Area' ? 'selected' : ''}>Field Training Area</option>
                            <option value="Gate Area" ${row.source === 'Gate Area' ? 'selected' : ''}>Gate Area</option>
                            <option value="Historic Landfill" ${row.source === 'Historic Landfill' ? 'selected' : ''}>Historic Landfill</option>
                            <option value="Jet engine testing pad" ${row.source === 'Jet engine testing pad' ? 'selected' : ''}>Jet engine testing pad</option>
                            <option value="Legacy burn pit" ${row.source === 'Legacy burn pit' ? 'selected' : ''}>Legacy burn pit</option>
                            <option value="Mechanical Shop" ${row.source === 'Mechanical Shop' ? 'selected' : ''}>Mechanical Shop</option>
                            <option value="Medical X-ray" ${row.source === 'Medical X-ray' ? 'selected' : ''}>Medical X-ray</option>
                            <option value="Satellite comms dish" ${row.source === 'Satellite comms dish' ? 'selected' : ''}>Satellite comms dish</option>
                        </select></td>
                        <td><select data-field="environmentalMedium" data-index="${index}">
                            <option value="">Select Medium</option>
                            <option value="Air" ${row.environmentalMedium === 'Air' ? 'selected' : ''}>Air</option>
                            <option value="Air/Biological" ${row.environmentalMedium === 'Air/Biological' ? 'selected' : ''}>Air/Biological</option>
                            <option value="Air/Surface" ${row.environmentalMedium === 'Air/Surface' ? 'selected' : ''}>Air/Surface</option>
                            <option value="Air/Surfaces" ${row.environmentalMedium === 'Air/Surfaces' ? 'selected' : ''}>Air/Surfaces</option>
                            <option value="Auditory" ${row.environmentalMedium === 'Auditory' ? 'selected' : ''}>Auditory</option>
                            <option value="Groundwater" ${row.environmentalMedium === 'Groundwater' ? 'selected' : ''}>Groundwater</option>
                            <option value="Indoor Air" ${row.environmentalMedium === 'Indoor Air' ? 'selected' : ''}>Indoor Air</option>
                            <option value="Radiation" ${row.environmentalMedium === 'Radiation' ? 'selected' : ''}>Radiation</option>
                            <option value="Soil" ${row.environmentalMedium === 'Soil' ? 'selected' : ''}>Soil</option>
                            <option value="Soil/Air" ${row.environmentalMedium === 'Soil/Air' ? 'selected' : ''}>Soil/Air</option>
                            <option value="Soil/Dust" ${row.environmentalMedium === 'Soil/Dust' ? 'selected' : ''}>Soil/Dust</option>
                            <option value="Soil/Groundwater" ${row.environmentalMedium === 'Soil/Groundwater' ? 'selected' : ''}>Soil/Groundwater</option>
                            <option value="Soil/Surfaces" ${row.environmentalMedium === 'Soil/Surfaces' ? 'selected' : ''}>Soil/Surfaces</option>
                            <option value="Surface Water" ${row.environmentalMedium === 'Surface Water' ? 'selected' : ''}>Surface Water</option>
                            <option value="Surfaces" ${row.environmentalMedium === 'Surfaces' ? 'selected' : ''}>Surfaces</option>
                            <option value="Water" ${row.environmentalMedium === 'Water' ? 'selected' : ''}>Water</option>
                        </select></td>
                        <td><select data-field="healthThreat" data-index="${index}">
                            <option value="">Select Threat</option>
                            <option value="Acid mist, Pb dust" ${row.healthThreat === 'Acid mist, Pb dust' ? 'selected' : ''}>Acid mist, Pb dust</option>
                            <option value="Asphyxiation" ${row.healthThreat === 'Asphyxiation' ? 'selected' : ''}>Asphyxiation</option>
                            <option value="Benzene exposure" ${row.healthThreat === 'Benzene exposure' ? 'selected' : ''}>Benzene exposure</option>
                            <option value="Chlorine residual" ${row.healthThreat === 'Chlorine residual' ? 'selected' : ''}>Chlorine residual</option>
                            <option value="CO, particulates" ${row.healthThreat === 'CO, particulates' ? 'selected' : ''}>CO, particulates</option>
                            <option value="Corrosives, toxics" ${row.healthThreat === 'Corrosives, toxics' ? 'selected' : ''}>Corrosives, toxics</option>
                            <option value="Dioxins/PM" ${row.healthThreat === 'Dioxins/PM' ? 'selected' : ''}>Dioxins/PM</option>
                            <option value="Drip leaks" ${row.healthThreat === 'Drip leaks' ? 'selected' : ''}>Drip leaks</option>
                            <option value="Ionizing radiation" ${row.healthThreat === 'Ionizing radiation' ? 'selected' : ''}>Ionizing radiation</option>
                            <option value="Leachate (VOCs, metals)" ${row.healthThreat === 'Leachate (VOCs, metals)' ? 'selected' : ''}>Leachate (VOCs, metals)</option>
                            <option value="Lead, noise" ${row.healthThreat === 'Lead, noise' ? 'selected' : ''}>Lead, noise</option>
                            <option value="Manganese/Cr6+" ${row.healthThreat === 'Manganese/Cr6+' ? 'selected' : ''}>Manganese/Cr6+</option>
                            <option value="Mold spores, heat stress" ${row.healthThreat === 'Mold spores, heat stress' ? 'selected' : ''}>Mold spores, heat stress</option>
                            <option value="Mold, dust" ${row.healthThreat === 'Mold, dust' ? 'selected' : ''}>Mold, dust</option>
                            <option value="Noise-Induced Hearing Loss" ${row.healthThreat === 'Noise-Induced Hearing Loss' ? 'selected' : ''}>Noise-Induced Hearing Loss</option>
                            <option value="Pathogens, nutrients" ${row.healthThreat === 'Pathogens, nutrients' ? 'selected' : ''}>Pathogens, nutrients</option>
                            <option value="Pesticide residues" ${row.healthThreat === 'Pesticide residues' ? 'selected' : ''}>Pesticide residues</option>
                            <option value="PM2.5" ${row.healthThreat === 'PM2.5' ? 'selected' : ''}>PM2.5</option>
                            <option value="Propylene glycol" ${row.healthThreat === 'Propylene glycol' ? 'selected' : ''}>Propylene glycol</option>
                            <option value="RF hazard" ${row.healthThreat === 'RF hazard' ? 'selected' : ''}>RF hazard</option>
                            <option value="Solvent vapors" ${row.healthThreat === 'Solvent vapors' ? 'selected' : ''}>Solvent vapors</option>
                            <option value="Toluene, xylene" ${row.healthThreat === 'Toluene, xylene' ? 'selected' : ''}>Toluene, xylene</option>
                            <option value="Valley fever (fungal spores)" ${row.healthThreat === 'Valley fever (fungal spores)' ? 'selected' : ''}>Valley fever (fungal spores)</option>
                            <option value="Vector-borne disease" ${row.healthThreat === 'Vector-borne disease' ? 'selected' : ''}>Vector-borne disease</option>
                            <option value="VOC vapor, spills" ${row.healthThreat === 'VOC vapor, spills' ? 'selected' : ''}>VOC vapor, spills</option>
                        </select></td>
                        <td><select data-field="exposureRoute" data-index="${index}">
                            <option value="">Select Route</option>
                            <option value="Auditory" ${row.exposureRoute === 'Auditory' ? 'selected' : ''}>Auditory</option>
                            <option value="Dermal" ${row.exposureRoute === 'Dermal' ? 'selected' : ''}>Dermal</option>
                            <option value="Dermal, Inhalation" ${row.exposureRoute === 'Dermal, Inhalation' ? 'selected' : ''}>Dermal, Inhalation</option>
                            <option value="External" ${row.exposureRoute === 'External' ? 'selected' : ''}>External</option>
                            <option value="Ingestion" ${row.exposureRoute === 'Ingestion' ? 'selected' : ''}>Ingestion</option>
                            <option value="Ingestion, Dermal" ${row.exposureRoute === 'Ingestion, Dermal' ? 'selected' : ''}>Ingestion, Dermal</option>
                            <option value="Inhalation" ${row.exposureRoute === 'Inhalation' ? 'selected' : ''}>Inhalation</option>
                            <option value="Inhalation, Dermal" ${row.exposureRoute === 'Inhalation, Dermal' ? 'selected' : ''}>Inhalation, Dermal</option>
                            <option value="Inhalation, Ingestion" ${row.exposureRoute === 'Inhalation, Ingestion' ? 'selected' : ''}>Inhalation, Ingestion</option>
                            <option value="Insect bites" ${row.exposureRoute === 'Insect bites' ? 'selected' : ''}>Insect bites</option>
                        </select></td>
                        <td><select data-field="populationAffected" data-index="${index}">
                            <option value="">Select Population</option>
                            <option value="All base" ${row.populationAffected === 'All base' ? 'selected' : ''}>All base</option>
                            <option value="All base population" ${row.populationAffected === 'All base population' ? 'selected' : ''}>All base population</option>
                            <option value="Aquatic life, public" ${row.populationAffected === 'Aquatic life, public' ? 'selected' : ''}>Aquatic life, public</option>
                            <option value="Athletes" ${row.populationAffected === 'Athletes' ? 'selected' : ''}>Athletes</option>
                            <option value="CE, HAZWASTE" ${row.populationAffected === 'CE, HAZWASTE' ? 'selected' : ''}>CE, HAZWASTE</option>
                            <option value="Civil Engineers" ${row.populationAffected === 'Civil Engineers' ? 'selected' : ''}>Civil Engineers</option>
                            <option value="Comm technicians" ${row.populationAffected === 'Comm technicians' ? 'selected' : ''}>Comm technicians</option>
                            <option value="Community well users" ${row.populationAffected === 'Community well users' ? 'selected' : ''}>Community well users</option>
                            <option value="Commuters, gate guards" ${row.populationAffected === 'Commuters, gate guards' ? 'selected' : ''}>Commuters, gate guards</option>
                            <option value="Cryo techs" ${row.populationAffected === 'Cryo techs' ? 'selected' : ''}>Cryo techs</option>
                            <option value="Downstream community" ${row.populationAffected === 'Downstream community' ? 'selected' : ''}>Downstream community</option>
                            <option value="Fabricators" ${row.populationAffected === 'Fabricators' ? 'selected' : ''}>Fabricators</option>
                            <option value="Firefighters, POL" ${row.populationAffected === 'Firefighters, POL' ? 'selected' : ''}>Firefighters, POL</option>
                            <option value="Flightline Maintainers" ${row.populationAffected === 'Flightline Maintainers' ? 'selected' : ''}>Flightline Maintainers</option>
                            <option value="Instructors, trainees" ${row.populationAffected === 'Instructors, trainees' ? 'selected' : ''}>Instructors, trainees</option>
                            <option value="Lab staff" ${row.populationAffected === 'Lab staff' ? 'selected' : ''}>Lab staff</option>
                            <option value="Logistics workers" ${row.populationAffected === 'Logistics workers' ? 'selected' : ''}>Logistics workers</option>
                            <option value="Maintainers" ${row.populationAffected === 'Maintainers' ? 'selected' : ''}>Maintainers</option>
                            <option value="Nearby Housing" ${row.populationAffected === 'Nearby Housing' ? 'selected' : ''}>Nearby Housing</option>
                            <option value="Outdoor personnel" ${row.populationAffected === 'Outdoor personnel' ? 'selected' : ''}>Outdoor personnel</option>
                            <option value="Painters" ${row.populationAffected === 'Painters' ? 'selected' : ''}>Painters</option>
                            <option value="POL, Drivers" ${row.populationAffected === 'POL, Drivers' ? 'selected' : ''}>POL, Drivers</option>
                            <option value="Shoppers, workers" ${row.populationAffected === 'Shoppers, workers' ? 'selected' : ''}>Shoppers, workers</option>
                            <option value="Staff, patients" ${row.populationAffected === 'Staff, patients' ? 'selected' : ''}>Staff, patients</option>
                            <option value="Trainees" ${row.populationAffected === 'Trainees' ? 'selected' : ''}>Trainees</option>
                        </select></td>
                        <td><select data-field="existingControls" data-index="${index}">
                            <option value="">Select Controls</option>
                            <option value="AQI alerts" ${row.existingControls === 'AQI alerts' ? 'selected' : ''}>AQI alerts</option>
                            <option value="Chlorination, signage" ${row.existingControls === 'Chlorination, signage' ? 'selected' : ''}>Chlorination, signage</option>
                            <option value="Dehumidifiers, filters" ${row.existingControls === 'Dehumidifiers, filters' ? 'selected' : ''}>Dehumidifiers, filters</option>
                            <option value="Fence, ash cap" ${row.existingControls === 'Fence, ash cap' ? 'selected' : ''}>Fence, ash cap</option>
                            <option value="HPDs, duty limits" ${row.existingControls === 'HPDs, duty limits' ? 'selected' : ''}>HPDs, duty limits</option>
                            <option value="Labeling, limited app" ${row.existingControls === 'Labeling, limited app' ? 'selected' : ''}>Labeling, limited app</option>
                            <option value="LEV, cartridge masks" ${row.existingControls === 'LEV, cartridge masks' ? 'selected' : ''}>LEV, cartridge masks</option>
                            <option value="LEV, PPE, IH surveys" ${row.existingControls === 'LEV, PPE, IH surveys' ? 'selected' : ''}>LEV, PPE, IH surveys</option>
                            <option value="LEV, respirators" ${row.existingControls === 'LEV, respirators' ? 'selected' : ''}>LEV, respirators</option>
                            <option value="Monitoring wells" ${row.existingControls === 'Monitoring wells' ? 'selected' : ''}>Monitoring wells</option>
                            <option value="Monitors, ventilation" ${row.existingControls === 'Monitors, ventilation' ? 'selected' : ''}>Monitors, ventilation</option>
                            <option value="Online monitors" ${row.existingControls === 'Online monitors' ? 'selected' : ''}>Online monitors</option>
                            <option value="PPE, HEPA vacs" ${row.existingControls === 'PPE, HEPA vacs' ? 'selected' : ''}>PPE, HEPA vacs</option>
                            <option value="PPE, vent hoods" ${row.existingControls === 'PPE, vent hoods' ? 'selected' : ''}>PPE, vent hoods</option>
                            <option value="Repellent, Bti spray" ${row.existingControls === 'Repellent, Bti spray' ? 'selected' : ''}>Repellent, Bti spray</option>
                            <option value="Secondary containment" ${row.existingControls === 'Secondary containment' ? 'selected' : ''}>Secondary containment</option>
                            <option value="Shielding, badges" ${row.existingControls === 'Shielding, badges' ? 'selected' : ''}>Shielding, badges</option>
                            <option value="SOPs, eyewash" ${row.existingControls === 'SOPs, eyewash' ? 'selected' : ''}>SOPs, eyewash</option>
                            <option value="SOPs, notifications" ${row.existingControls === 'SOPs, notifications' ? 'selected' : ''}>SOPs, notifications</option>
                            <option value="SOPs, spill kits" ${row.existingControls === 'SOPs, spill kits' ? 'selected' : ''}>SOPs, spill kits</option>
                            <option value="Spill pallets" ${row.existingControls === 'Spill pallets' ? 'selected' : ''}>Spill pallets</option>
                            <option value="Stormwater BMPs" ${row.existingControls === 'Stormwater BMPs' ? 'selected' : ''}>Stormwater BMPs</option>
                            <option value="Time limits, cleaning" ${row.existingControls === 'Time limits, cleaning' ? 'selected' : ''}>Time limits, cleaning</option>
                            <option value="Time-distance-shielding" ${row.existingControls === 'Time-distance-shielding' ? 'selected' : ''}>Time-distance-shielding</option>
                            <option value="Vehicle standards" ${row.existingControls === 'Vehicle standards' ? 'selected' : ''}>Vehicle standards</option>
                            <option value="Watering, timing" ${row.existingControls === 'Watering, timing' ? 'selected' : ''}>Watering, timing</option>
                        </select></td>
                        <td><select data-field="frequencyDuration" data-index="${index}">
                            <option value="">Select Frequency</option>
                            <option value="Annual" ${row.frequencyDuration === 'Annual' ? 'selected' : ''}>Annual</option>
                            <option value="Constant" ${row.frequencyDuration === 'Constant' ? 'selected' : ''}>Constant</option>
                            <option value="Continuous" ${row.frequencyDuration === 'Continuous' ? 'selected' : ''}>Continuous</option>
                            <option value="Daily" ${row.frequencyDuration === 'Daily' ? 'selected' : ''}>Daily</option>
                            <option value="Daily/8 hrs" ${row.frequencyDuration === 'Daily/8 hrs' ? 'selected' : ''}>Daily/8 hrs</option>
                            <option value="Dry season" ${row.frequencyDuration === 'Dry season' ? 'selected' : ''}>Dry season</option>
                            <option value="Legacy source" ${row.frequencyDuration === 'Legacy source' ? 'selected' : ''}>Legacy source</option>
                            <option value="Monthly" ${row.frequencyDuration === 'Monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="Monthly access" ${row.frequencyDuration === 'Monthly access' ? 'selected' : ''}>Monthly access</option>
                            <option value="Quarterly" ${row.frequencyDuration === 'Quarterly' ? 'selected' : ''}>Quarterly</option>
                            <option value="Rare spills" ${row.frequencyDuration === 'Rare spills' ? 'selected' : ''}>Rare spills</option>
                            <option value="Seasonal wind" ${row.frequencyDuration === 'Seasonal wind' ? 'selected' : ''}>Seasonal wind</option>
                            <option value="Summer" ${row.frequencyDuration === 'Summer' ? 'selected' : ''}>Summer</option>
                            <option value="Variable" ${row.frequencyDuration === 'Variable' ? 'selected' : ''}>Variable</option>
                            <option value="Weekly" ${row.frequencyDuration === 'Weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="Weekly tasks" ${row.frequencyDuration === 'Weekly tasks' ? 'selected' : ''}>Weekly tasks</option>
                            <option value="Winter season" ${row.frequencyDuration === 'Winter season' ? 'selected' : ''}>Winter season</option>
                        </select></td>
                        <td><select data-field="severity" data-index="${index}">
                            <option value="">Select Severity</option>
                            <option value="Catastrophic (I)" ${row.severity === 'Catastrophic (I)' ? 'selected' : ''}>Catastrophic (I)</option>
                            <option value="Critical (II)" ${row.severity === 'Critical (II)' ? 'selected' : ''}>Critical (II)</option>
                            <option value="Marginal (III)" ${row.severity === 'Marginal (III)' ? 'selected' : ''}>Marginal (III)</option>
                            <option value="Negligible (IV)" ${row.severity === 'Negligible (IV)' ? 'selected' : ''}>Negligible (IV)</option>
                        </select></td>
                        <td><select data-field="probability" data-index="${index}">
                            <option value="">Select Probability</option>
                            <option value="Frequent (A)" ${row.probability === 'Frequent (A)' ? 'selected' : ''}>Frequent (A)</option>
                            <option value="Likely (B)" ${row.probability === 'Likely (B)' ? 'selected' : ''}>Likely (B)</option>
                            <option value="Occasional (C)" ${row.probability === 'Occasional (C)' ? 'selected' : ''}>Occasional (C)</option>
                            <option value="Seldom (D)" ${row.probability === 'Seldom (D)' ? 'selected' : ''}>Seldom (D)</option>
                            <option value="Unlikely (E)" ${row.probability === 'Unlikely (E)' ? 'selected' : ''}>Unlikely (E)</option>
                        </select></td>
                        <td><select data-field="risk" data-index="${index}">
                            <option value="">Select Risk</option>
                            <option value="Extremely High" ${row.risk === 'Extremely High' ? 'selected' : ''}>Extremely High</option>
                            <option value="High" ${row.risk === 'High' ? 'selected' : ''}>High</option>
                            <option value="Moderate" ${row.risk === 'Moderate' ? 'selected' : ''}>Moderate</option>
                            <option value="Low" ${row.risk === 'Low' ? 'selected' : ''}>Low</option>
                        </select></td>
                    `;
                    tbody.appendChild(tr);
                });

                if (this.lastComparisonResults && Array.isArray(this.lastComparisonResults.details)) {
                    this.applyFormComparison(this.lastComparisonResults);
                }

                this.addInputEventListeners();
            }

            scrollToBottom() {
                const wrapper = document.querySelector('.csm-form-table-wrapper');
                if (wrapper) {
                    wrapper.scrollTop = wrapper.scrollHeight;
                }
            }

            setupScrollListener() {
                const wrapper = document.querySelector('.csm-form-table-wrapper');
                if (wrapper) {
                    let isScrolling = false;
                    let scrollTimeout;
                    let hasExpanded = false; // Track if we've already expanded
                    
                    // Handle wheel events more carefully
                    wrapper.addEventListener('wheel', (e) => {
                        if (this.hazardRows.length <= this.calculateMaxVisibleRows()) return;
                        
                        // If we're in sliding window mode and user scrolls, show all rows
                        if (!wrapper.classList.contains('show-all') && !hasExpanded) {
                            hasExpanded = true;
                            this.renderRows(true);
                        }
                    });
                    
                    // Handle scroll events more carefully to avoid jumping
                    wrapper.addEventListener('scroll', () => {
                        if (this.hazardRows.length <= this.calculateMaxVisibleRows()) return;
                        
                        // Clear existing timeout
                        clearTimeout(scrollTimeout);
                        
                        // Set a flag to indicate we're scrolling
                        isScrolling = true;
                        
                        // Clear the flag after scrolling stops
                        scrollTimeout = setTimeout(() => {
                            isScrolling = false;
                        }, 150);
                        
                        // Don't interfere with scrolling once we're in show-all mode
                        if (wrapper.classList.contains('show-all')) {
                            return;
                        }
                        
                        // Only expand to show all rows if user scrolls to very top
                        const currentScrollTop = wrapper.scrollTop;
                        
                        if (currentScrollTop <= 2 && !hasExpanded) {
                            hasExpanded = true;
                            this.renderRows(true);
                        }
                    });
                    
                    // Add a way to go back to sliding window mode
                    wrapper.addEventListener('dblclick', () => {
                        if (this.hazardRows.length > this.calculateMaxVisibleRows()) {
                            hasExpanded = false; // Reset the flag
                            this.renderRows(false); // Go back to sliding window
                        }
                    });
                    
                    // Reset expansion flag when new hazards are added
                    const originalAddHazardRow = this.addHazardRow.bind(this);
                    this.addHazardRow = () => {
                        hasExpanded = false; // Reset when adding new hazards
                        originalAddHazardRow();
                    };
                }
            }

            addInputEventListeners() {
                const selects = document.querySelectorAll('.csm-form-table select');
                const inputs = document.querySelectorAll('.csm-form-table input');

                selects.forEach(select => {
                    // Remove existing listeners to prevent duplicates
                    select.removeEventListener('change', this.handleSelectChange);
                    select.removeEventListener('mousedown', this.handleSelectMouseDown);
                    select.removeEventListener('click', this.handleSelectClick);
                    select.removeEventListener('blur', this.handleSelectBlur);
                    select.removeEventListener('mouseleave', this.handleSelectMouseLeave);
                    
                    // Add new listeners
                    select.addEventListener('change', this.handleSelectChange.bind(this));
                    select.addEventListener('mousedown', this.handleSelectMouseDown.bind(this));
                    select.addEventListener('click', this.handleSelectClick.bind(this));
                    select.addEventListener('blur', this.handleSelectBlur.bind(this));
                    select.addEventListener('mouseleave', this.handleSelectMouseLeave.bind(this));
                });

                inputs.forEach(input => {
                    // Remove existing listeners to prevent duplicates
                    input.removeEventListener('input', this.handleInputChange);
                    input.removeEventListener('mousedown', this.handleInputMouseDown);
                    input.removeEventListener('click', this.handleInputClick);
                    input.removeEventListener('blur', this.handleInputBlur);
                    input.removeEventListener('mouseleave', this.handleInputMouseLeave);
                    
                    // Add new listeners
                    input.addEventListener('input', this.handleInputChange.bind(this));
                    input.addEventListener('mousedown', this.handleInputMouseDown.bind(this));
                    input.addEventListener('click', this.handleInputClick.bind(this));
                    input.addEventListener('blur', this.handleInputBlur.bind(this));
                    input.addEventListener('mouseleave', this.handleInputMouseLeave.bind(this));
                });
            }

            handleSelectMouseDown(e) {
                e.stopPropagation(); // Prevent map from capturing the event
                this.disableMapControls();
            }

            handleSelectClick(e) {
                e.stopPropagation(); // Prevent map from capturing the event
                this.disableMapControls();
            }

            handleInputMouseDown(e) {
                e.stopPropagation(); // Prevent map from capturing the event
                this.disableMapControls();
            }

            handleInputClick(e) {
                e.stopPropagation(); // Prevent map from capturing the event
                this.disableMapControls();
            }

            handleSelectBlur(e) {
                e.stopPropagation();
                // Re-enable map controls after a short delay
                setTimeout(() => this.enableMapControls(), 100);
            }

            handleSelectMouseLeave(e) {
                e.stopPropagation();
                // Re-enable map controls after a short delay
                setTimeout(() => this.enableMapControls(), 100);
            }

            handleInputBlur(e) {
                e.stopPropagation();
                // Re-enable map controls after a short delay
                setTimeout(() => this.enableMapControls(), 100);
            }

            handleInputMouseLeave(e) {
                e.stopPropagation();
                // Re-enable map controls after a short delay
                setTimeout(() => this.enableMapControls(), 100);
            }

            disableMapControls() {
                // Temporarily disable Cesium camera controls
                if (window.hazardMap && window.hazardMap.mapManager && window.hazardMap.mapManager.viewer) {
                    const viewer = window.hazardMap.mapManager.viewer;
                    if (viewer.scene && viewer.scene.screenSpaceCameraController) {
                        viewer.scene.screenSpaceCameraController.enableRotate = false;
                        viewer.scene.screenSpaceCameraController.enableZoom = false;
                        viewer.scene.screenSpaceCameraController.enableTranslate = false;
                        viewer.scene.screenSpaceCameraController.enableTilt = false;
                        viewer.scene.screenSpaceCameraController.enableLook = false;
                    }
                }
            }

            enableMapControls() {
                // Re-enable Cesium camera controls
                if (window.hazardMap && window.hazardMap.mapManager && window.hazardMap.mapManager.viewer) {
                    const viewer = window.hazardMap.mapManager.viewer;
                    if (viewer.scene && viewer.scene.screenSpaceCameraController) {
                        viewer.scene.screenSpaceCameraController.enableRotate = true;
                        viewer.scene.screenSpaceCameraController.enableZoom = true;
                        viewer.scene.screenSpaceCameraController.enableTranslate = true;
                        viewer.scene.screenSpaceCameraController.enableTilt = true;
                        viewer.scene.screenSpaceCameraController.enableLook = true;
                    }
                }
            }

            handleSelectChange(e) {
                e.stopPropagation(); // Prevent map from capturing the event
                const field = e.target.dataset.field;
                const index = parseInt(e.target.dataset.index);
                this.hazardRows[index][field] = e.target.value;
                this.clearFormComparisonHighlights();
                // Don't re-render the table, just update the data
            }

            handleInputChange(e) {
                e.stopPropagation(); // Prevent map from capturing the event
                const field = e.target.dataset.field;
                const index = parseInt(e.target.dataset.index);
                this.hazardRows[index][field] = e.target.value;
                this.clearFormComparisonHighlights();
                // Don't re-render the table, just update the data
            }

            populateFromMapData(hazardData) {
                // Always add a new row at the bottom for each hazard
                this.addHazardRow();
                
                // Get the newly added row (last row)
                const newRow = this.hazardRows[this.hazardRows.length - 1];
                
                // Auto-populate the source field
                newRow.source = hazardData.display_name || hazardData.hazard_type || hazardData.name || hazardData.Name || '';
                console.log('[CSM] Auto-populated source field for hazard:', newRow.source);

                    // Update the specific form fields without re-rendering the entire table
                this.updateFormFields(newRow);
                
                this.clearFormComparisonHighlights();
            }

            updateFormFields(targetRow) {
                // Find the row index
                const rowIndex = this.hazardRows.indexOf(targetRow);
                if (rowIndex === -1) return;

                // Update only the source field as requested
                const sourceSelect = document.querySelector(`select[data-field="source"][data-index="${rowIndex}"]`);
                if (sourceSelect && targetRow.source && sourceSelect.value !== targetRow.source) {
                    sourceSelect.value = targetRow.source;
                    console.log(`[CSM] Updated source field to: ${targetRow.source}`);
                }
            }

            generateCorrectCSMTable() {
                // Use the complete hazardDetails from the main application
                const referenceData = [
                    {
                        hazardId: 1,
                        source: 'Engine Testing Pad1',
                        environmentalMedium: 'Auditory',
                        healthThreat: 'Noise-Induced Hearing Loss',
                        exposureRoute: 'Auditory',
                        populationAffected: 'Flightline Maintainers',
                        existingControls: 'HPDs, duty limits',
                        frequencyDuration: 'Daily/8hrs',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 2,
                        source: 'Aircraft Fuel Tanks',
                        environmentalMedium: 'Soil/Groundwater',
                        healthThreat: 'Benzene exposure',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'Firefighters, POL',
                        existingControls: 'Secondary containment',
                        frequencyDuration: 'Rare spills',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 3,
                        source: 'Legacy Burn Pit',
                        environmentalMedium: 'Soil/Air',
                        healthThreat: 'Dioxins/PM',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'Nearby Housing',
                        existingControls: 'Fence, ash cap',
                        frequencyDuration: 'Seasonal wind',
                        severity: 'Critical (II)',
                        probability: 'Likely (B)',
                        risk: 'High'
                    },
                    {
                        hazardId: 4,
                        source: 'Welding Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Manganese/Cr6+',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Fabricators',
                        existingControls: 'LEV, PPE, IH surveys',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 5,
                        source: 'Municipal water system',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Pathogens, nutrients',
                        exposureRoute: 'Ingestion, Dermal',
                        populationAffected: 'Downstream community',
                        existingControls: 'Chlorination, signage',
                        frequencyDuration: 'Continuous',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 6,
                        source: 'Forest Fire',
                        environmentalMedium: 'Air',
                        healthThreat: 'PM2.5',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'All base population',
                        existingControls: 'AQI alerts',
                        frequencyDuration: 'Annual',
                        severity: 'Critical (II)',
                        probability: 'Occasional (C)',
                        risk: 'High'
                    },
                    {
                        hazardId: 7,
                        source: 'CATM Range',
                        environmentalMedium: 'Soil',
                        healthThreat: 'Lead, noise',
                        exposureRoute: 'Inhalation, Ingestion',
                        populationAffected: 'Instructors, trainees',
                        existingControls: 'PPE, HEPA vacs',
                        frequencyDuration: 'Daily',
                        severity: 'Critical (II)',
                        probability: 'Frequent (A)',
                        risk: 'Extremely High'
                    },
                    {
                        hazardId: 8,
                        source: 'Fuel truck refueling',
                        environmentalMedium: 'Air',
                        healthThreat: 'VOC vapor, spills',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'POL, Drivers',
                        existingControls: 'PPE, cartridge masks',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 9,
                        source: 'Feild Water System',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Propylene glycol',
                        exposureRoute: 'Ingestion',
                        populationAffected: 'Aquatic life, public',
                        existingControls: 'Monitoring wells',
                        frequencyDuration: 'Continuous',
                        severity: 'Medium',
                        probability: 'Medium',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 10,
                        source: 'Warehouse',
                        environmentalMedium: 'Indoor Air',
                        healthThreat: 'Mold, dust',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Logistics workers',
                        existingControls: 'Ventilation',
                        frequencyDuration: 'Daily',
                        severity: 'Medium',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 11,
                        source: 'Cryogenics Shop',
                        environmentalMedium: 'Indoor Air',
                        healthThreat: 'Asphyxiation',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Cryo techs',
                        existingControls: 'Monitoring',
                        frequencyDuration: 'Daily',
                        severity: 'Critical',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 12,
                        source: 'Histoic Landfill',
                        environmentalMedium: 'Groundwater',
                        healthThreat: 'Leachate (VOCs, metals)',
                        exposureRoute: 'Ingestion',
                        populationAffected: 'Community well users',
                        existingControls: 'Monitoring wells',
                        frequencyDuration: 'Continuous',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 13,
                        source: 'Battery Storage',
                        environmentalMedium: 'Air/Surface',
                        healthThreat: 'Acid mist, Pb dust',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Civil Engineers',
                        existingControls: 'Containment',
                        frequencyDuration: 'Occasional',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 14,
                        source: 'Satellite Comms Dish',
                        environmentalMedium: 'Radiation',
                        healthThreat: 'RF hazard',
                        exposureRoute: 'External',
                        populationAffected: 'Comm technicians',
                        existingControls: 'Signage',
                        frequencyDuration: '24/7',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 15,
                        source: 'Pest Control',
                        environmentalMedium: 'Auditory',
                        healthThreat: 'Pesticide residues',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Shoppers, workers',
                        existingControls: 'Repellent, Bti spray',
                        frequencyDuration: 'Seasonal',
                        severity: 'Medium',
                        probability: 'Medium',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 16,
                        source: 'Gym Sauna',
                        environmentalMedium: 'Air',
                        healthThreat: 'Mold spores, heat stress',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Athletes',
                        existingControls: 'Ventilation',
                        frequencyDuration: 'Daily',
                        severity: 'Medium',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 17,
                        source: 'Paint Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Toluene, xylene',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Painters',
                        existingControls: 'LEV, PPE, IH surveys',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 18,
                        source: 'Chemical Lab',
                        environmentalMedium: 'Air',
                        healthThreat: 'Corrosives, toxics',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Lab staff',
                        existingControls: 'Fume hoods, PPE',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 19,
                        source: 'Mechanical Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Solvent vapors',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Maintainers',
                        existingControls: 'LEV, PPE',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 20,
                        source: 'Gate Area',
                        environmentalMedium: 'Air',
                        healthThreat: 'CO, particulates',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Commuters, gate guards',
                        existingControls: 'None',
                        frequencyDuration: '24/7',
                        severity: 'Medium',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 21,
                        source: 'Feild Training Area',
                        environmentalMedium: 'Soil',
                        healthThreat: 'Valley fever (fungal spores)',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Trainees',
                        existingControls: 'PPE, training',
                        frequencyDuration: 'Seasonal',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 22,
                        source: 'Medical X ray',
                        environmentalMedium: 'Radiation',
                        healthThreat: 'Ionizing radiation',
                        exposureRoute: 'External',
                        populationAffected: 'Staff, patients',
                        existingControls: 'Shielding, badges',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 23,
                        source: 'HazMat Storage Area',
                        environmentalMedium: 'Soil/Surfaces',
                        healthThreat: 'Drip leaks',
                        exposureRoute: 'Dermal',
                        populationAffected: 'CE, HAZWASTE',
                        existingControls: 'Secondary containment',
                        frequencyDuration: 'Continuous',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 24,
                        source: 'Municipal Water Supply',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Pathogens, nutrients',
                        exposureRoute: 'Ingestion, Dermal',
                        populationAffected: 'Downstream community',
                        existingControls: 'Chlorination, signage',
                        frequencyDuration: 'Continuous',
                        severity: 'Critical (II)',
                        probability: 'Seldom (D)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 25,
                        source: "'arthropod Vectors",
                        environmentalMedium: 'Air/Biological',
                        healthThreat: 'Vector-borne disease',
                        exposureRoute: 'Insect bites',
                        populationAffected: 'Outdoor personnel',
                        existingControls: 'Repellent, Bti spray',
                        frequencyDuration: 'Seasonal',
                        severity: 'Medium',
                        probability: 'Medium',
                        risk: 'Medium'
                    }
                ];

                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #28a745; color: white;">
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">ID</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Source</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Medium</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Threat</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Route</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Population</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Controls</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Frequency</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Severity</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Probability</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center;">Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${referenceData.map(row => `
                                <tr style="background: #f8fff8;">
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.hazardId}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.source}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.environmentalMedium}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.healthThreat}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.exposureRoute}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.populationAffected}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.existingControls}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.frequencyDuration}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.severity}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.probability}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.risk}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            generateStudentCSMTable(results) {
                // Use the same complete reference data as generateCorrectCSMTable
                const referenceData = [
                    {
                        hazardId: 1,
                        source: 'Engine Testing Pad1',
                        environmentalMedium: 'Auditory',
                        healthThreat: 'Noise-Induced Hearing Loss',
                        exposureRoute: 'Auditory',
                        populationAffected: 'Flightline Maintainers',
                        existingControls: 'HPDs, duty limits',
                        frequencyDuration: 'Daily/8hrs',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 2,
                        source: 'Aircraft Fuel Tanks',
                        environmentalMedium: 'Soil/Groundwater',
                        healthThreat: 'Benzene exposure',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'Firefighters, POL',
                        existingControls: 'Secondary containment',
                        frequencyDuration: 'Rare spills',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 3,
                        source: 'Legacy Burn Pit',
                        environmentalMedium: 'Soil/Air',
                        healthThreat: 'Dioxins/PM',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'Nearby Housing',
                        existingControls: 'Fence, ash cap',
                        frequencyDuration: 'Seasonal wind',
                        severity: 'Critical (II)',
                        probability: 'Likely (B)',
                        risk: 'High'
                    },
                    {
                        hazardId: 4,
                        source: 'Welding Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Manganese/Cr6+',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Fabricators',
                        existingControls: 'LEV, PPE, IH surveys',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 5,
                        source: 'Municipal water system',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Pathogens, nutrients',
                        exposureRoute: 'Ingestion, Dermal',
                        populationAffected: 'Downstream community',
                        existingControls: 'Chlorination, signage',
                        frequencyDuration: 'Continuous',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 6,
                        source: 'Forest Fire',
                        environmentalMedium: 'Air',
                        healthThreat: 'PM2.5',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'All base population',
                        existingControls: 'AQI alerts',
                        frequencyDuration: 'Annual',
                        severity: 'Critical (II)',
                        probability: 'Occasional (C)',
                        risk: 'High'
                    },
                    {
                        hazardId: 7,
                        source: 'CATM Range',
                        environmentalMedium: 'Soil',
                        healthThreat: 'Lead, noise',
                        exposureRoute: 'Inhalation, Ingestion',
                        populationAffected: 'Instructors, trainees',
                        existingControls: 'PPE, HEPA vacs',
                        frequencyDuration: 'Daily',
                        severity: 'Critical (II)',
                        probability: 'Frequent (A)',
                        risk: 'Extremely High'
                    },
                    {
                        hazardId: 8,
                        source: 'Fuel truck refueling',
                        environmentalMedium: 'Air',
                        healthThreat: 'VOC vapor, spills',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'POL, Drivers',
                        existingControls: 'PPE, cartridge masks',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 9,
                        source: 'Feild Water System',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Propylene glycol',
                        exposureRoute: 'Ingestion',
                        populationAffected: 'Aquatic life, public',
                        existingControls: 'Monitoring wells',
                        frequencyDuration: 'Continuous',
                        severity: 'Medium',
                        probability: 'Medium',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 10,
                        source: 'Warehouse',
                        environmentalMedium: 'Indoor Air',
                        healthThreat: 'Mold, dust',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Logistics workers',
                        existingControls: 'Ventilation',
                        frequencyDuration: 'Daily',
                        severity: 'Medium',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 11,
                        source: 'Cryogenics Shop',
                        environmentalMedium: 'Indoor Air',
                        healthThreat: 'Asphyxiation',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Cryo techs',
                        existingControls: 'Monitoring',
                        frequencyDuration: 'Daily',
                        severity: 'Critical',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 12,
                        source: 'Histoic Landfill',
                        environmentalMedium: 'Groundwater',
                        healthThreat: 'Leachate (VOCs, metals)',
                        exposureRoute: 'Ingestion',
                        populationAffected: 'Community well users',
                        existingControls: 'Monitoring wells',
                        frequencyDuration: 'Continuous',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 13,
                        source: 'Battery Storage',
                        environmentalMedium: 'Air/Surface',
                        healthThreat: 'Acid mist, Pb dust',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Civil Engineers',
                        existingControls: 'Containment',
                        frequencyDuration: 'Occasional',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 14,
                        source: 'Satellite Comms Dish',
                        environmentalMedium: 'Radiation',
                        healthThreat: 'RF hazard',
                        exposureRoute: 'External',
                        populationAffected: 'Comm technicians',
                        existingControls: 'Signage',
                        frequencyDuration: '24/7',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 15,
                        source: 'Pest Control',
                        environmentalMedium: 'Auditory',
                        healthThreat: 'Pesticide residues',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Shoppers, workers',
                        existingControls: 'Repellent, Bti spray',
                        frequencyDuration: 'Seasonal',
                        severity: 'Medium',
                        probability: 'Medium',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 16,
                        source: 'Gym Sauna',
                        environmentalMedium: 'Air',
                        healthThreat: 'Mold spores, heat stress',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Athletes',
                        existingControls: 'Ventilation',
                        frequencyDuration: 'Daily',
                        severity: 'Medium',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 17,
                        source: 'Paint Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Toluene, xylene',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Painters',
                        existingControls: 'LEV, PPE, IH surveys',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 18,
                        source: 'Chemical Lab',
                        environmentalMedium: 'Air',
                        healthThreat: 'Corrosives, toxics',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Lab staff',
                        existingControls: 'Fume hoods, PPE',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 19,
                        source: 'Mechanical Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Solvent vapors',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Maintainers',
                        existingControls: 'LEV, PPE',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 20,
                        source: 'Gate Area',
                        environmentalMedium: 'Air',
                        healthThreat: 'CO, particulates',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Commuters, gate guards',
                        existingControls: 'None',
                        frequencyDuration: '24/7',
                        severity: 'Medium',
                        probability: 'High',
                        risk: 'High'
                    },
                    {
                        hazardId: 21,
                        source: 'Feild Training Area',
                        environmentalMedium: 'Soil',
                        healthThreat: 'Valley fever (fungal spores)',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Trainees',
                        existingControls: 'PPE, training',
                        frequencyDuration: 'Seasonal',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 22,
                        source: 'Medical X ray',
                        environmentalMedium: 'Radiation',
                        healthThreat: 'Ionizing radiation',
                        exposureRoute: 'External',
                        populationAffected: 'Staff, patients',
                        existingControls: 'Shielding, badges',
                        frequencyDuration: 'Daily',
                        severity: 'High',
                        probability: 'Low',
                        risk: 'Medium'
                    },
                    {
                        hazardId: 23,
                        source: 'HazMat Storage Area',
                        environmentalMedium: 'Soil/Surfaces',
                        healthThreat: 'Drip leaks',
                        exposureRoute: 'Dermal',
                        populationAffected: 'CE, HAZWASTE',
                        existingControls: 'Secondary containment',
                        frequencyDuration: 'Continuous',
                        severity: 'High',
                        probability: 'Medium',
                        risk: 'High'
                    },
                    {
                        hazardId: 24,
                        source: 'Municipal Water Supply',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Pathogens, nutrients',
                        exposureRoute: 'Ingestion, Dermal',
                        populationAffected: 'Downstream community',
                        existingControls: 'Chlorination, signage',
                        frequencyDuration: 'Continuous',
                        severity: 'Critical (II)',
                        probability: 'Seldom (D)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 25,
                        source: "'arthropod Vectors",
                        environmentalMedium: 'Air/Biological',
                        healthThreat: 'Vector-borne disease',
                        exposureRoute: 'Insect bites',
                        populationAffected: 'Outdoor personnel',
                        existingControls: 'Repellent, Bti spray',
                        frequencyDuration: 'Seasonal',
                        severity: 'Medium',
                        probability: 'Medium',
                        risk: 'Medium'
                    }
                ];

                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #dc3545; color: white;">
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">ID</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Source</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Medium</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Threat</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Route</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Population</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Controls</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Frequency</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Severity</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Probability</th>
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${referenceData.map((referenceRow, index) => {
                                // Find matching student data for this reference row
                                const studentRow = this.hazardRows.find(student => 
                                    student.source && student.source.toLowerCase() === referenceRow.source.toLowerCase()
                                );
                                
                                if (!studentRow) {
                                    // Show empty row if student hasn't filled this hazard
                                    return `
                                        <tr style="background: #fff8f8;">
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${referenceRow.hazardId}</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fff3cd;">Not filled</td>
                                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold; background: #fff3cd;">Not filled</td>
                                        </tr>
                                    `;
                                }

                                // Compare each field and color code
                                const fields = ['source', 'environmentalMedium', 'healthThreat', 'exposureRoute', 'populationAffected', 'existingControls', 'frequencyDuration', 'severity', 'probability', 'risk'];
                                
                                return `
                                    <tr style="background: #fff8f8;">
                                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${referenceRow.hazardId}</td>
                                        ${fields.map(field => {
                                            const studentValue = studentRow[field] || '';
                                            const referenceValue = referenceRow[field] || '';
                                            const studentNormalized = (studentValue || '').toLowerCase();
                                            const referenceNormalized = (referenceValue || '').toLowerCase();
                                            const isCorrect = studentNormalized && studentNormalized === referenceNormalized;
                                            const backgroundColor = isCorrect ? '#d4edda' : '#fbe9eb';
                                            
                                            if (isCorrect) {
                                                return `<td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: ${backgroundColor}; color: #155724; font-weight: ${field === 'risk' ? 'bold' : 'normal'};">${studentValue || 'Not filled'}</td>`;
                                            }
                                            
                                            const enteredDisplay = studentValue && studentValue.trim() ? studentValue : 'Not filled';
                                            const correctDisplay = referenceValue && referenceValue.trim() ? referenceValue : 'N/A';
                                            
                                            return `
                                                <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; background: ${backgroundColor}; font-weight: ${field === 'risk' ? 'bold' : 'normal'};">
                                                    <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                                                        <span style="color: #721c24; font-weight: 600;">Entered: ${enteredDisplay}</span>
                                                        <span style="color: #155724; font-weight: 600;">Correct: ${correctDisplay}</span>
                                                    </div>
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            clearForm() {
                this.hazardRows = [];
                this.addInitialRow();
                this.clearFormComparisonHighlights();
            }


            showRiskLevelOrder() {
                // Bring risk matrix to front if it's open
                const riskMatrix = document.getElementById('riskMatrixViewer');
                if (riskMatrix) {
                    riskMatrix.style.zIndex = '10001';
                }
                
                // Create modal to show CSM spreadsheet for reordering
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                    padding-top: 120px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    max-width: 95%;
                    max-height: 90%;
                    overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin: 0; color: #2c3e50;">Risk Level Order - Drag to Reorder</h2>
                        <button id="submitRiskOrder" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Submit</button>
                    </div>
                    <div id="reorderableTable" style="overflow-x: auto;">
                        ${this.generateReorderableTable()}
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Setup drag and drop functionality
                this.setupDragAndDrop();
                
                // Submit handler
                document.getElementById('submitRiskOrder').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    // Restore risk matrix z-index before showing comparison
                    const riskMatrix = document.getElementById('riskMatrixViewer');
                    if (riskMatrix) {
                        riskMatrix.style.zIndex = '10000';
                    }
                    this.showSideBySideComparison();
                });
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }
            
            generateReorderableTable() {
                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 5%;">Order</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 12%;">Source</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 10%;">Environmental Medium</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 10%;">Health Threat</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 10%;">Exposure Route</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 10%;">Population Affected</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 10%;">Existing Controls</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 10%;">Frequency/Duration</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 8%;">Severity</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 8%;">Probability</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center; width: 8%;">Risk</th>
                            </tr>
                        </thead>
                        <tbody id="reorderableTableBody">
                            ${this.hazardRows.map((row, index) => `
                                <tr draggable="true" data-index="${index}" style="cursor: move; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${index + 1}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.source || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.environmentalMedium || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.healthThreat || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.exposureRoute || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.populationAffected || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.existingControls || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.frequencyDuration || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.severity || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.probability || 'Not Set'}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.risk || 'Not Set'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            setupDragAndDrop() {
                const tbody = document.getElementById('reorderableTableBody');
                let draggedElement = null;
                
                // Add drag event listeners to all rows
                tbody.addEventListener('dragstart', (e) => {
                    draggedElement = e.target;
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                tbody.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '';
                    draggedElement = null;
                });
                
                tbody.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                tbody.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    if (draggedElement && e.target.tagName === 'TD') {
                        const targetRow = e.target.closest('tr');
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(targetRow.dataset.index);
                        
                        if (draggedIndex !== targetIndex) {
                            // Reorder the hazardRows array
                            const draggedRow = this.hazardRows.splice(draggedIndex, 1)[0];
                            this.hazardRows.splice(targetIndex, 0, draggedRow);
                            
                            // Update the table display
                            this.updateReorderableTable();
                            
                            // Update the main CSM form
                            this.renderRows();
                        }
                    }
                });
            }
            
            updateReorderableTable() {
                const tbody = document.getElementById('reorderableTableBody');
                tbody.innerHTML = this.hazardRows.map((row, index) => `
                    <tr draggable="true" data-index="${index}" style="cursor: move; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${index + 1}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.source || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.environmentalMedium || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.healthThreat || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.exposureRoute || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.populationAffected || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.existingControls || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.frequencyDuration || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.severity || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${row.probability || 'Not Set'}</td>
                        <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.risk || 'Not Set'}</td>
                    </tr>
                `).join('');
                
                // Re-setup drag and drop for the new rows
                this.setupDragAndDrop();
            }

            showRiskMatrix() {
                // Check if matrix is already open
                if (document.getElementById('riskMatrixViewer')) {
                    return;
                }
                
                // Create draggable matrix viewer
                const matrixViewer = document.createElement('div');
                matrixViewer.id = 'riskMatrixViewer';
                
                // Position matrix so its bottom touches the top of CSM spreadsheet
                const imageHeight = 400; // Approximate image height
                const imageWidth = 500; // Approximate image width
                const padding = 20; // padding from right edge
                
                // Find CSM spreadsheet element to position relative to it
                const csmWrapper = document.querySelector('.csm-form-table-wrapper');
                let topPosition = 50; // fallback
                let rightPosition = padding;
                
                if (csmWrapper) {
                    const csmRect = csmWrapper.getBoundingClientRect();
                    // Position so bottom of matrix is close to top of CSM spreadsheet
                    topPosition = csmRect.top - imageHeight + 140; // Add 140px to move it down
                    rightPosition = padding;
                    
                    // Ensure it doesn't go above the viewport
                    if (topPosition < 10) {
                        topPosition = 10;
                    }
                } else {
                    // Fallback if CSM element not found
                    topPosition = window.innerHeight - imageHeight - 150;
                }
                
                matrixViewer.style.cssText = `
                    position: fixed;
                    top: ${topPosition}px;
                    right: ${rightPosition}px;
                    z-index: 10000;
                    cursor: move;
                    user-select: none;
                `;
                
                matrixViewer.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <img src="src/assets/Risk-Assessment-Matrix.png" alt="Risk Assessment Matrix" style="max-width: 95vw; max-height: 95vh; display: block;">
                        <button id="closeRiskMatrix" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">√ó</button>
                    </div>
                `;
                
                document.body.appendChild(matrixViewer);
                
                // Make it draggable
                this.makeDraggable(matrixViewer);
                
                // Close button handler
                document.getElementById('closeRiskMatrix').addEventListener('click', () => {
                    document.body.removeChild(matrixViewer);
                });
            }
            
            makeDraggable(element) {
                let isDragging = false;
                let startX, startY, initialX, initialY;
                
                const dragStart = (e) => {
                    if (e.target.tagName === 'BUTTON') return; // Don't drag when clicking buttons
                    
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // Get current position from transform or use 0,0
                    const transform = element.style.transform;
                    if (transform && transform !== 'none') {
                        const matches = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
                        if (matches) {
                            initialX = parseFloat(matches[1]);
                            initialY = parseFloat(matches[2]);
                        } else {
                            initialX = 0;
                            initialY = 0;
                        }
                    } else {
                        initialX = 0;
                        initialY = 0;
                    }
                    
                    element.style.cursor = 'grabbing';
                    e.preventDefault();
                };
                
                const dragEnd = () => {
                    isDragging = false;
                    element.style.cursor = 'move';
                };
                
                const drag = (e) => {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newX = initialX + deltaX;
                    const newY = initialY + deltaY;
                    
                    element.style.transform = `translate(${newX}px, ${newY}px)`;
                };
                
                element.addEventListener('mousedown', dragStart);
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('mousemove', drag);
            }
            
            hideRiskMatrix() {
                const matrixViewer = document.getElementById('riskMatrixViewer');
                if (matrixViewer) {
                    document.body.removeChild(matrixViewer);
                }
            }

            exportForm() {
                console.log('exportForm called, hazardRows length:', this.hazardRows.length);
                if (this.hazardRows.length === 0) {
                    alert('No data to export. Please add at least one hazard.');
                    return;
                }

                // Map source names from student answers to hazard names used in getDetailedHazardInfo
                const sourceNameMapping = {
                    'Jet engine testing pad': 'Engine Testing Pad1',
                    'Legacy burn pit': 'Legacy burn Pit',
                    'CATM Range': 'CATM Range',
                    'Base CATM Range': 'CATM Range',
                    'Historic Landfill': 'Histoic Landfill',
                    'Satellite comms dish': 'Satellite Comms Dish',
                    'Mechanical Shop': 'Mechanical Shop',
                    'Gate Area': 'Gate Area',
                    'Field Training Area': 'Feild Training Area',
                    'Medical X-ray': 'Medical X ray',
                    'Arthropod Vectors': 'arthropod Vectors'
                };

                // Get correct answers and compare with student answers
                const exportData = this.hazardRows.map(row => {
                    const studentAnswer = {
                        hazardId: row.hazardId,
                        source: row.source || '',
                        environmentalMedium: row.environmentalMedium || '',
                        healthThreat: row.healthThreat || '',
                        exposureRoute: row.exposureRoute || '',
                        populationAffected: row.populationAffected || '',
                        existingControls: row.existingControls || '',
                        frequencyDuration: row.frequencyDuration || '',
                        severity: row.severity || '',
                        probability: row.probability || '',
                        risk: row.risk || ''
                    };

                    // Get correct answer by matching source name
                    let correctAnswer = null;
                    if (studentAnswer.source) {
                        const mappedName = sourceNameMapping[studentAnswer.source] || studentAnswer.source;
                        const props = { display_name: mappedName, hazard_type: mappedName, Name: mappedName };
                        correctAnswer = this.getDetailedHazardInfo(props);
                    }

                    // Compare answers
                    const comparison = {
                        source: this.compareField(studentAnswer.source, correctAnswer?.source),
                        environmentalMedium: this.compareField(studentAnswer.environmentalMedium, correctAnswer?.environmentalMedium),
                        healthThreat: this.compareField(studentAnswer.healthThreat, correctAnswer?.healthThreat),
                        exposureRoute: this.compareField(studentAnswer.exposureRoute, correctAnswer?.exposureRoute),
                        populationAffected: this.compareField(studentAnswer.populationAffected, correctAnswer?.populationAffected),
                        existingControls: this.compareField(studentAnswer.existingControls, correctAnswer?.existingControls),
                        frequencyDuration: this.compareField(studentAnswer.frequencyDuration, correctAnswer?.freqDuration),
                        severity: this.compareField(studentAnswer.severity, correctAnswer?.severity),
                        probability: this.compareField(studentAnswer.probability, correctAnswer?.probability),
                        risk: this.compareField(studentAnswer.risk, correctAnswer?.risk)
                    };

                    return {
                        studentAnswer,
                        correctAnswer,
                        comparison
                    };
                });

                // Generate printable HTML
                console.log('Generating export HTML with', exportData.length, 'items');
                this.generateExportHTML(exportData);
            }

            compareField(studentValue, correctValue) {
                if (!studentValue && !correctValue) return { isCorrect: true, student: '', correct: '' };
                if (!studentValue) return { isCorrect: false, student: '', correct: correctValue || '' };
                if (!correctValue) return { isCorrect: false, student: studentValue, correct: '' };
                
                const normalizedStudent = this.normalizeValue(studentValue);
                const normalizedCorrect = this.normalizeValue(correctValue);
                
                return {
                    isCorrect: normalizedStudent === normalizedCorrect,
                    student: studentValue,
                    correct: correctValue
                };
            }

            generateExportHTML(exportData) {
                const date = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CSM Form Export - ${date}</title>
    <style>
        @page {
            size: letter landscape;
            margin: 0.3in;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 8pt;
            line-height: 1.2;
            margin: 0;
            padding: 0;
            color: #000;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .header h1 {
            margin: 0;
            font-size: 18pt;
            font-weight: bold;
        }
        .header h2 {
            margin: 5px 0;
            font-size: 14pt;
            font-weight: normal;
        }
        .header p {
            margin: 5px 0;
            font-size: 10pt;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            page-break-inside: avoid;
            table-layout: fixed;
            font-size: 8pt;
            background-color: #ffffff !important;
            border: 2px solid #000 !important;
        }
        tbody, thead {
            background-color: #ffffff !important;
        }
        thead tr {
            background-color: #f5f5f5 !important;
            border-bottom: 2px solid #000 !important;
        }
        tbody tr {
            background-color: #ffffff !important;
            border-bottom: 1px solid #ccc !important;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9 !important;
        }
        th {
            background-color: #f5f5f5 !important;
            color: #000 !important;
            padding: 4px 3px;
            text-align: center;
            font-size: 8pt;
            border: 1px solid #333 !important;
            white-space: normal;
            word-wrap: break-word;
            font-weight: bold;
            border-top: 2px solid #000 !important;
            border-left: 1px solid #333 !important;
            border-right: 1px solid #333 !important;
            line-height: 1.2;
        }
        th:first-child {
            border-left: 2px solid #000 !important;
        }
        th:last-child {
            border-right: 2px solid #000 !important;
        }
        td {
            background-color: inherit !important;
            color: #000 !important;
            padding: 3px;
            border: 1px solid #ccc !important;
            font-size: 8pt;
            vertical-align: middle;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            border-left: 1px solid #ccc !important;
            border-right: 1px solid #ccc !important;
            line-height: 1.2;
        }
        td:first-child {
            border-left: 2px solid #000 !important;
        }
        td:last-child {
            border-right: 2px solid #000 !important;
        }
        tbody tr:last-child td {
            border-bottom: 2px solid #000 !important;
        }
        .hazard-id {
            font-weight: bold;
            text-align: center;
            width: 4%;
        }
        .correct {
            background-color: #ffffff !important;
            color: #000 !important;
        }
        .incorrect {
            background-color: #ffffff !important;
            color: #000 !important;
        }
        .empty {
            background-color: #ffffff !important;
            color: #000 !important;
        }
        .student-answer {
            font-weight: bold;
        }
        .correct-answer {
            font-style: italic;
            font-size: 7pt;
            color: #666;
            margin-top: 2px;
        }
        .summary {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #000;
            background-color: #ffffff !important;
        }
        .summary h3 {
            margin-top: 0;
            font-size: 12pt;
            color: #000 !important;
            background-color: transparent !important;
        }
        .summary p {
            background-color: #ffffff !important;
            color: #000 !important;
        }
        @media print {
            body {
                margin: 0;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body style="background-color: #ffffff !important; color: #000 !important; margin: 0 !important; padding: 0 !important;">
    <div class="header" style="text-align: center !important; margin: 0 0 15px 0 !important; padding: 10px 0 !important; border-bottom: 2px solid #000 !important; background-color: #ffffff !important; color: #000 !important; width: 100% !important; display: block !important; visibility: visible !important; opacity: 1 !important;">
        <h1 style="margin: 0 0 5px 0 !important; font-size: 18pt !important; font-weight: bold !important; color: #000 !important; background-color: #ffffff !important; display: block !important;">Contaminated Site Management (CSM) Hazard Assessment Form</h1>
        <h2 style="margin: 5px 0 !important; font-size: 14pt !important; font-weight: normal !important; color: #000 !important; background-color: #ffffff !important; display: block !important;">CSM Spreadsheet</h2>
        <p style="margin: 5px 0 0 0 !important; font-size: 10pt !important; color: #000 !important; background-color: #ffffff !important; display: block !important;">Export Date: ${date}</p>
    </div>
    <table style="background-color: #ffffff !important; border: 2px solid #000 !important; border-collapse: collapse !important;">
        <thead style="background-color: #f5f5f5 !important;">
            <tr style="background-color: #f5f5f5 !important; border-bottom: 2px solid #000 !important;">
                <th class="hazard-id" style="background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; border-left: 2px solid #000 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">ID</th>
                <th style="width: 10%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Source</th>
                <th style="width: 10%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Environmental Medium</th>
                <th style="width: 8%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Health Threat</th>
                <th style="width: 8%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Exposure Route</th>
                <th style="width: 10%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Population Affected</th>
                <th style="width: 10%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Existing Controls</th>
                <th style="width: 10%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Frequency/Duration</th>
                <th style="width: 6%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Severity</th>
                <th style="width: 6%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Probability</th>
                <th style="width: 14%; background-color: #f5f5f5 !important; color: #000 !important; border: 1px solid #333 !important; border-right: 2px solid #000 !important; padding: 4px 3px; font-weight: bold; font-size: 8pt; line-height: 1.2; text-align: center;">Risk</th>
            </tr>
        </thead>
        <tbody style="background-color: #ffffff !important;">`;

                let totalFields = 0;
                let correctFields = 0;

                exportData.forEach(item => {
                    const fields = ['source', 'environmentalMedium', 'healthThreat', 'exposureRoute', 
                                   'populationAffected', 'existingControls', 'frequencyDuration', 
                                   'severity', 'probability', 'risk'];
                    
                    // Alternate row colors for spreadsheet look
                    const rowIndex = exportData.indexOf(item);
                    const isLastRow = rowIndex === exportData.length - 1;
                    const rowBgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9f9f9';
                    const bottomBorder = isLastRow ? '2px solid #000' : '1px solid #ccc';
                    html += `<tr style="background-color: ${rowBgColor} !important; border-bottom: ${bottomBorder} !important;">`;
                    const idCellBottomBorder = isLastRow ? '2px solid #000' : '1px solid #ccc';
                    html += `<td class="hazard-id" style="background-color: ${rowBgColor} !important; color: #000 !important; border: 1px solid #ccc !important; border-left: 2px solid #000 !important; border-bottom: ${idCellBottomBorder} !important; font-weight: bold; text-align: center; padding: 3px; font-size: 8pt;">${item.studentAnswer.hazardId}</td>`;
                    
                    fields.forEach((field, fieldIndex) => {
                        const comp = item.comparison[field];
                        totalFields++;
                        if (comp.isCorrect) correctFields++;
                        
                        let cellClass = '';
                        let cellContent = '';
                        
                        if (!comp.student && !comp.correct) {
                            cellClass = 'empty';
                            cellContent = '<em>Empty</em>';
                        } else if (comp.isCorrect) {
                            cellClass = 'correct';
                            cellContent = '<span style="font-size: 8pt; color: #28a745;">‚úì</span> <span class=\"student-answer\">' + this.escapeHtml(comp.student) + '</span>';
                        } else {
                            cellClass = 'incorrect';
                            cellContent = '<span style="font-size: 8pt; color: #dc3545;">‚úó</span> <span class=\"student-answer\">' + this.escapeHtml(comp.student || '(empty)') + '</span>';
                            if (comp.correct) {
                                cellContent += '<br><span style="font-size: 8pt; color: #28a745;">‚úì</span> <span class=\"correct-answer\" style="font-size: 8pt;">' + this.escapeHtml(comp.correct) + '</span>';
                            }
                        }
                        
                        const cellBottomBorder = isLastRow ? '2px solid #000' : '1px solid #ccc';
                        const isLastCell = fieldIndex === fields.length - 1;
                        const cellRightBorder = isLastCell ? '2px solid #000' : '1px solid #ccc';
                        html += '<td class="' + cellClass + '" style="background-color: ' + rowBgColor + ' !important; color: #000 !important; border: 1px solid #ccc !important; border-bottom: ' + cellBottomBorder + ' !important; border-right: ' + cellRightBorder + ' !important; padding: 3px; font-size: 8pt; line-height: 1.2; text-align: center; vertical-align: middle;">' + cellContent + '</td>';
                    });
                    
                    html += `</tr>`;
                });

                html += `
        </tbody>
    </table>
    <div class="summary" style="background-color: #ffffff !important; color: #000 !important;">
        <h3 style="background-color: #ffffff !important; color: #000 !important;">Summary</h3>
        <p style="background-color: #ffffff !important; color: #000 !important;"><strong>Total Hazards:</strong> ${exportData.length}</p>
        <p style="background-color: #ffffff !important; color: #000 !important;"><strong>Total Fields:</strong> ${totalFields}</p>
        <p style="background-color: #ffffff !important; color: #000 !important;"><strong>Correct Answers:</strong> ${correctFields} (${totalFields > 0 ? Math.round(correctFields / totalFields * 100) : 0}%)</p>
        <p style="background-color: #ffffff !important; color: #000 !important;"><strong>Incorrect/Empty Answers:</strong> ${totalFields - correctFields} (${totalFields > 0 ? Math.round((totalFields - correctFields) / totalFields * 100) : 0}%)</p>
    </div>
`;
                html += '</' + 'body' + '>';
                html += '</' + 'html' + '>';

                // Create downloadable PDF using html3pdf with iframe rendering
                console.log('Creating downloadable PDF using iframe...');
                try {
                    // Check if html3pdf is available
                    if (typeof html3pdf === 'undefined') {
                        // Fallback: open new window for print-to-PDF
                        console.warn('html3pdf not available, using print dialog fallback');
                        const printWindow = window.open('', '_blank');
                        if (printWindow) {
                            printWindow.document.write(html);
                            printWindow.document.close();
                            printWindow.onload = () => {
                                setTimeout(() => {
                                    printWindow.print();
                                }, 250);
                            };
                        } else {
                            alert('Please allow popups and try again, or use the browser print function.');
                        }
                        return;
                    }
                    
                    // Create an iframe to render the full HTML document
                    // This ensures all styles and content are properly rendered
                    const iframe = document.createElement('iframe');
                    iframe.id = 'pdf-export-iframe';
                    iframe.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 1400px;
                        height: 900px;
                        border: none;
                        visibility: hidden;
                        z-index: -1;
                    `;
                    
                    document.body.appendChild(iframe);
                    
                    // Write the full HTML to the iframe
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(html);
                    iframeDoc.close();
                    
                    console.log('Iframe created, waiting for content to load...');
                    console.log('HTML preview (first 500 chars):', html.substring(0, 500));
                    
                    // Debug: Log the style block to verify it's correct
                    const styleMatch = html.match(/<style>([\s\S]*?)<\/style>/);
                    if (styleMatch) {
                        console.log('Style block found, checking for background colors...');
                        const styleContent = styleMatch[1];
                        if (styleContent.includes('background-color: #333') || styleContent.includes('background-color: #2c3e50')) {
                            console.error('WARNING: Found dark blue background in style block!');
                        } else {
                            console.log('Style block looks good - no dark blue backgrounds found');
                        }
                    }
                    
                    // Function to generate PDF once iframe is ready
                    const generatePDF = () => {
                        try {
                            const iframeBody = iframeDoc.body;
                            const iframeWindow = iframe.contentWindow;
                            
                            console.log('Iframe loaded');
                            console.log('Body content length:', iframeBody.innerHTML.length);
                            console.log('Body scroll dimensions:', iframeBody.scrollWidth, 'x', iframeBody.scrollHeight);
                            
                            // Check if header is present
                            const header = iframeBody.querySelector('.header');
                            if (header) {
                                console.log('Header found in iframe:', header.innerHTML.substring(0, 100));
                            } else {
                                console.warn('WARNING: Header not found in iframe body!');
                            }
                            
                            // Debug: Check computed styles of table elements
                            const table = iframeBody.querySelector('table');
                            if (table) {
                                const computedStyle = iframeWindow.getComputedStyle(table);
                                console.log('Table background:', computedStyle.backgroundColor);
                                
                                const th = table.querySelector('th');
                                if (th) {
                                    const thStyle = iframeWindow.getComputedStyle(th);
                                    console.log('TH background:', thStyle.backgroundColor, 'color:', thStyle.color);
                                }
                                
                                const summary = iframeBody.querySelector('.summary');
                                if (summary) {
                                    const summaryStyle = iframeWindow.getComputedStyle(summary);
                                    console.log('Summary background:', summaryStyle.backgroundColor);
                                }
                                
                                // Check for any elements with blue backgrounds
                                const allElements = iframeBody.querySelectorAll('*');
                                let foundBlue = false;
                                allElements.forEach(el => {
                                    const style = iframeWindow.getComputedStyle(el);
                                    const bg = style.backgroundColor;
                                    if (bg && (bg.includes('rgb(51, 51, 51)') || bg.includes('#333') || bg.includes('rgb(44, 62, 80)') || bg.includes('#2c3e50'))) {
                                        console.warn('Found blue/dark background on:', el.tagName, el.className, 'background:', bg);
                                        foundBlue = true;
                                    }
                                });
                                if (!foundBlue) {
                                    console.log('No blue backgrounds found in computed styles');
                                }
                            }
                            
                            // Wait a bit more for any dynamic content to render
                            setTimeout(() => {
                                try {
                                    const opt = {
                                        margin: [0.3, 0.3],
                                        filename: `CSM_Form_Export_${new Date().toISOString().split('T')[0]}.pdf`,
                                        image: { type: 'jpeg', quality: 0.98 },
                                        html2canvas: { 
                                            scale: 1.5,
                                            useCORS: true,
                                            logging: true,
                                            letterRendering: true,
                                            allowTaint: true,
                                            backgroundColor: '#ffffff',
                                            width: iframeBody.scrollWidth,
                                            height: iframeBody.scrollHeight,
                                            scrollX: 0,
                                            scrollY: 0
                                        },
                                        jsPDF: { 
                                            unit: 'in', 
                                            format: 'letter', 
                                            orientation: 'landscape'
                                        }
                                    };
                                    
                                    console.log('Starting PDF generation from iframe body...');
                                    
                                    // Debug option: Uncomment to open iframe in new window for inspection
                                    // const debugWindow = window.open('', '_blank');
                                    // if (debugWindow) {
                                    //     debugWindow.document.write(html);
                                    //     debugWindow.document.close();
                                    // }
                                    
                                    // Generate PDF from iframe's body element
                                    html3pdf().set(opt).from(iframeBody).save().then(() => {
                                        console.log('PDF download completed successfully');
                                        // Clean up
                                        setTimeout(() => {
                                            if (document.body.contains(iframe)) {
                                                document.body.removeChild(iframe);
                                            }
                                        }, 1000);
                                    }).catch((error) => {
                                        console.error('PDF generation error:', error);
                                        console.error('Error stack:', error.stack);
                                        
                                        // Clean up iframe
                                        if (document.body.contains(iframe)) {
                                            document.body.removeChild(iframe);
                                        }
                                        
                                        // Fallback to print dialog
                                        const printWindow = window.open('', '_blank');
                                        if (printWindow) {
                                            printWindow.document.write(html);
                                            printWindow.document.close();
                                            printWindow.onload = () => {
                                                setTimeout(() => printWindow.print(), 250);
                                            };
                                        } else {
                                            alert('PDF generation failed. Please allow popups to use print-to-PDF fallback.\n\nError: ' + error.message);
                                        }
                                    });
                                } catch (e) {
                                    console.error('Error in PDF generation:', e);
                                    if (document.body.contains(iframe)) {
                                        document.body.removeChild(iframe);
                                    }
                                    alert('Error: ' + e.message);
                                }
                            }, 500);
                        } catch (e) {
                            console.error('Error accessing iframe content:', e);
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                            }
                            alert('Error accessing iframe: ' + e.message);
                        }
                    };
                    
                    // Wait for iframe to load
                    if (iframeDoc.readyState === 'complete') {
                        generatePDF();
                    } else {
                        iframe.onload = generatePDF;
                        // Fallback timeout in case onload doesn't fire
                        setTimeout(() => {
                            if (iframeDoc.body && iframeDoc.body.innerHTML.length > 0) {
                                generatePDF();
                            } else {
                                console.error('Iframe did not load properly');
                                if (document.body.contains(iframe)) {
                                    document.body.removeChild(iframe);
                                }
                                alert('Failed to load content in iframe. Trying print dialog fallback...');
                                const printWindow = window.open('', '_blank');
                                if (printWindow) {
                                    printWindow.document.write(html);
                                    printWindow.document.close();
                                    printWindow.onload = () => {
                                        setTimeout(() => printWindow.print(), 250);
                                    };
                                }
                            }
                        }, 2000);
                    }
                    
                } catch (e) {
                    console.error('Error creating PDF:', e);
                    alert('Error: ' + e.message);
                }
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showSideBySideComparison(results = this.lastComparisonResults) {
                if (!results) {
                    results = this.compareWithReference(this.getReferenceCSMData());
                }
                // Hide risk matrix if it's open
                this.hideRiskMatrix();
                
                // Create modal for side-by-side comparison
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                    padding-top: 120px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 1rem;
                    border-radius: 8px;
                    width: 95vw;
                    max-height: 95%;
                    overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    font-size: 12px;
                `;
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin: 0; color: #2c3e50;">Your Submitted CSM Form</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="exportSubmittedForm" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: bold;">Export/Save</button>
                            <button id="closeComparison" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>
                    </div>
                    <div style="margin: 0.5rem 0;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #dc3545; text-align: center; font-size: 16px;">Your CSM Form</h3>
                            <div style="max-height: 80vh; overflow-y: auto; overflow-x: auto; border: 2px solid #dc3545; border-radius: 8px;">
                                ${this.generateStudentCSMTable(results)}
                            </div>
                        </div>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Export/Save button handler
                const exportButton = document.getElementById('exportSubmittedForm');
                if (exportButton) {
                    exportButton.addEventListener('click', () => {
                        console.log('Export/Save button clicked from modal');
                        this.exportForm();
                    });
                } else {
                    console.error('Export button not found!');
                }
                
                // Close modal handler
                document.getElementById('closeComparison').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }
            
            generateCorrectCSMTable() {
                // Reference CSM data ordered by risk level (highest to lowest) - All 25 hazards
                const referenceData = [
                    // EXTREMELY HIGH RISK (1 hazard)
                    {
                        hazardId: 1,
                        source: 'Jet engine testing pad',
                        environmentalMedium: 'Auditory',
                        healthThreat: 'Noise-Induced Hearing Loss',
                        exposureRoute: 'Auditory',
                        populationAffected: 'Flightline Maintainers',
                        existingControls: 'HPDs, duty limits',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Critical (II)',
                        probability: 'Frequent (A)',
                        risk: 'Extremely High'
                    },
                    // HIGH RISK (3 hazards)
                    {
                        hazardId: 2,
                        source: 'Aircraft fuel tanks',
                        environmentalMedium: 'Soil/Groundwater',
                        healthThreat: 'Benzene exposure',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'Firefighters, POL',
                        existingControls: 'Secondary containment',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Marginal (III)',
                        probability: 'Occasional (C)',
                        risk: 'High'
                    },
                    {
                        hazardId: 3,
                        source: 'Chemical Lab',
                        environmentalMedium: 'Surfaces',
                        healthThreat: 'Corrosives, toxics',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Lab staff',
                        existingControls: 'SOPs, eyewash',
                        frequencyDuration: 'Weekly',
                        severity: 'Critical (II)',
                        probability: 'Occasional (C)',
                        risk: 'High'
                    },
                    {
                        hazardId: 4,
                        source: 'HazMat Storage Area',
                        environmentalMedium: 'Soil/Surfaces',
                        healthThreat: 'Drip leaks',
                        exposureRoute: 'Dermal',
                        populationAffected: 'CE, HAZWASTE',
                        existingControls: 'Spill pallets',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Marginal (III)',
                        probability: 'Seldom (D)',
                        risk: 'High'
                    },
                    // MODERATE RISK (7 hazards)
                    {
                        hazardId: 5,
                        source: 'Paint Shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Toluene, xylene',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Painters',
                        existingControls: 'LEV, cartridge masks',
                        frequencyDuration: 'Weekly',
                        severity: 'Critical (II)',
                        probability: 'Likely (B)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 6,
                        source: 'Welding shop',
                        environmentalMedium: 'Air',
                        healthThreat: 'Manganese/Cr6+',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Fabricators',
                        existingControls: 'LEV, PPE, IH surveys',
                        frequencyDuration: 'Weekly',
                        severity: 'Critical (II)',
                        probability: 'Frequent (A)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 7,
                        source: 'Municipal Water Supply',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Pathogens, nutrients',
                        exposureRoute: 'Ingestion, Dermal',
                        populationAffected: 'Downstream community',
                        existingControls: 'Chlorination, signage',
                        frequencyDuration: 'Continuous',
                        severity: 'Critical (II)',
                        probability: 'Seldom (D)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 8,
                        source: 'Battery Storage',
                        environmentalMedium: 'Air/Surface',
                        healthThreat: 'Acid mist, Pb dust',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Civil Engineers',
                        existingControls: 'PPE, vent hoods',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Marginal (III)',
                        probability: 'Occasional (C)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 9,
                        source: 'Cryogenics Shop',
                        environmentalMedium: 'Indoor Air',
                        healthThreat: 'Asphyxiation',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Cryo techs',
                        existingControls: 'Monitors, ventilation',
                        frequencyDuration: 'Weekly tasks',
                        severity: 'Catastrophic (I)',
                        probability: 'Seldom (D)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 10,
                        source: 'Fuel truck refueling',
                        environmentalMedium: 'Air',
                        healthThreat: 'VOC vapor, spills',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'POL, Drivers',
                        existingControls: 'SOPs, spill kits',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Critical (II)',
                        probability: 'Likely (B)',
                        risk: 'Moderate'
                    },
                    {
                        hazardId: 11,
                        source: 'Satellite comms dish',
                        environmentalMedium: 'Radiation',
                        healthThreat: 'RF hazard',
                        exposureRoute: 'External',
                        populationAffected: 'Comm technicians',
                        existingControls: 'Time-distance-shielding',
                        frequencyDuration: 'Weekly',
                        severity: 'Marginal (III)',
                        probability: 'Seldom (D)',
                        risk: 'Moderate'
                    },
                    // LOW RISK (14 hazards)
                    {
                        hazardId: 12,
                        source: 'Pest Control',
                        environmentalMedium: 'Auditory',
                        healthThreat: 'Pesticide residues',
                        exposureRoute: 'Dermal, Inhalation',
                        populationAffected: 'Shoppers, workers',
                        existingControls: 'Labeling, limited app',
                        frequencyDuration: 'Weekly',
                        severity: 'Marginal (III)',
                        probability: 'Seldom (D)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 13,
                        source: 'Arthropod Vectors',
                        environmentalMedium: 'Air/Biological',
                        healthThreat: 'Vector-borne disease',
                        exposureRoute: 'Insect bites',
                        populationAffected: 'Outdoor personnel',
                        existingControls: 'Repellent, Bti spray',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Critical (II)',
                        probability: 'Occasional (C)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 14,
                        source: 'Gym Sauna',
                        environmentalMedium: 'Air',
                        healthThreat: 'Mold spores, heat stress',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Athletes',
                        existingControls: 'Time limits, cleaning',
                        frequencyDuration: 'Weekly',
                        severity: 'Negligible (IV)',
                        probability: 'Frequent (A)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 15,
                        source: 'Medical X-ray',
                        environmentalMedium: 'Radiation',
                        healthThreat: 'Ionizing radiation',
                        exposureRoute: 'External',
                        populationAffected: 'Staff, patients',
                        existingControls: 'Shielding, badges',
                        frequencyDuration: 'Weekly',
                        severity: 'Critical (II)',
                        probability: 'Unlikely (E)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 16,
                        source: 'Mechanical Shop',
                        environmentalMedium: 'Air/Surfaces',
                        healthThreat: 'Solvent vapors',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Maintainers',
                        existingControls: 'LEV, respirators',
                        frequencyDuration: 'Weekly',
                        severity: 'Marginal (III)',
                        probability: 'Occasional (C)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 17,
                        source: 'Historic Landfill',
                        environmentalMedium: 'Groundwater',
                        healthThreat: 'Leachate (VOCs, metals)',
                        exposureRoute: 'Ingestion',
                        populationAffected: 'Community well users',
                        existingControls: 'Monitoring wells',
                        frequencyDuration: 'Dry season',
                        severity: 'Critical (II)',
                        probability: 'Seldom (D)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 18,
                        source: 'Field Training Area',
                        environmentalMedium: 'Soil/Dust',
                        healthThreat: 'Valley fever (fungal spores)',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Trainees',
                        existingControls: 'Watering, timing',
                        frequencyDuration: 'Weekly',
                        severity: 'Critical (II)',
                        probability: 'Seldom (D)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 19,
                        source: 'Field Water System',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Propylene glycol',
                        exposureRoute: 'Ingestion',
                        populationAffected: 'Aquatic life, public',
                        existingControls: 'Stormwater BMPs',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Marginal (III)',
                        probability: 'Occasional (C)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 20,
                        source: 'CATM Range',
                        environmentalMedium: 'Soil',
                        healthThreat: 'Lead, noise',
                        exposureRoute: 'Inhalation, Ingestion',
                        populationAffected: 'Instructors, trainees',
                        existingControls: 'PPE, HEPA vacs',
                        frequencyDuration: 'Daily',
                        severity: 'Critical (II)',
                        probability: 'Frequent (A)',
                        risk: 'Extremely High'
                    },
                    {
                        hazardId: 21,
                        source: 'Forest Fire',
                        environmentalMedium: 'Air',
                        healthThreat: 'PM2.5',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'All base population',
                        existingControls: 'AQI alerts',
                        frequencyDuration: 'Annual',
                        severity: 'Critical (II)',
                        probability: 'Occasional (C)',
                        risk: 'High'
                    },
                    {
                        hazardId: 22,
                        source: 'Warehouse',
                        environmentalMedium: 'Indoor Air',
                        healthThreat: 'Mold, dust',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Logistics workers',
                        existingControls: 'Dehumidifiers, filters',
                        frequencyDuration: 'Variable',
                        severity: 'Marginal (III)',
                        probability: 'Occasional (C)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 23,
                        source: 'Legacy burn pit',
                        environmentalMedium: 'Soil/Air',
                        healthThreat: 'Dioxins/PM',
                        exposureRoute: 'Inhalation, Dermal',
                        populationAffected: 'Nearby Housing',
                        existingControls: 'Fence, ash cap',
                        frequencyDuration: 'Legacy source',
                        severity: 'Critical (II)',
                        probability: 'Likely (B)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 24,
                        source: 'Gate Area',
                        environmentalMedium: 'Air',
                        healthThreat: 'CO, particulates',
                        exposureRoute: 'Inhalation',
                        populationAffected: 'Commuters, gate guards',
                        existingControls: 'Vehicle standards',
                        frequencyDuration: 'Daily/8 hrs',
                        severity: 'Marginal (III)',
                        probability: 'Frequent (A)',
                        risk: 'Low'
                    },
                    {
                        hazardId: 25,
                        source: 'Municipal Water System',
                        environmentalMedium: 'Surface Water',
                        healthThreat: 'Pathogens, nutrients',
                        exposureRoute: 'Ingestion, Dermal',
                        populationAffected: 'Downstream community',
                        existingControls: 'Chlorination, signage',
                        frequencyDuration: 'Continuous',
                        severity: 'Critical (II)',
                        probability: 'Seldom (D)',
                        risk: 'Moderate'
                    }
                ];
                
                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 8%;">Order</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 12%;">Source</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 10%;">Environmental Medium</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 10%;">Health Threat</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 10%;">Exposure Route</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 10%;">Population Affected</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 10%;">Existing Controls</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 10%;">Frequency/Duration</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 8%;">Severity</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 8%;">Probability</th>
                                <th style="padding: 8px; border: 1px solid #1e7e34; text-align: center; width: 8%;">Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${referenceData.map((row, index) => `
                                <tr style="background: #f8fff8;">
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${index + 1}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.source}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.environmentalMedium}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.healthThreat}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.exposureRoute}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.populationAffected}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.existingControls}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.frequencyDuration}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.severity}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.probability}</td>
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${row.risk}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            generateStudentCSMTable(results = null) {
                if (!results && this.lastComparisonResults) {
                    results = this.lastComparisonResults;
                }

                const detailMap = new Map();
                if (results && Array.isArray(results.details)) {
                    results.details.forEach(detail => {
                        const rowIndex = typeof detail.row === 'number' ? detail.row - 1 : null;
                        if (rowIndex === null || rowIndex < 0) return;
                        const fieldMap = new Map();
                        if (Array.isArray(detail.fieldResults)) {
                            detail.fieldResults.forEach(fieldResult => {
                                fieldMap.set(fieldResult.field, fieldResult);
                            });
                        }
                        detailMap.set(rowIndex, {
                            status: detail.status,
                            message: detail.message,
                            fields: fieldMap
                        });
                    });
                }

                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #bd2130; text-align: center; width: 8%;">Order</th>
                                ${this.formFields.map(field => `<th style="padding: 8px; border: 1px solid #bd2130; text-align: center;">${this.formatFieldLabel(field)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${this.hazardRows.map((row, index) => {
                                const detail = detailMap.get(index);
                                return `
                                <tr style="background: ${index % 2 === 0 ? '#fff5f5' : 'white'};">
                                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${index + 1}</td>
                                        ${this.formFields.map(field => {
                                            const value = row[field] || '';
                                            if (!detail) {
                                                return `<td style=\"padding: 6px; border: 1px solid #dee2e6; text-align: center;\">${value || 'Not Set'}</td>`;
                                            }

                                            const fieldResult = detail.fields.get(field);
                                            if (fieldResult) {
                                                if (fieldResult.status === 'correct') {
                                                    return `<td style=\"padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #d4edda; color: #155724; font-weight: ${field === 'risk' ? 'bold' : 'normal'};\">${value || 'Not Set'}</td>`;
                                                }
                                                const entered = fieldResult.student && fieldResult.student.trim() ? fieldResult.student : 'Not Set';
                                                const correct = fieldResult.reference && fieldResult.reference.trim() ? fieldResult.reference : 'N/A';
                                                return `
                                                    <td style=\"padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fbe9eb; font-weight: ${field === 'risk' ? 'bold' : 'normal'};\">
                                                        <div style=\"display: flex; flex-direction: column; gap: 4px; align-items: center;\">
                                                            <span style=\"color: #721c24; font-weight: 600;\">Entered: ${entered}</span>
                                                            <span style=\"color: #155724; font-weight: 600;\">Correct: ${correct}</span>
                                                        </div>
                                                    </td>
                                                `;
                                            }

                                            const enteredDisplay = value && value.trim() ? value : 'Not Set';

                                            if (detail.status === 'correct') {
                                                return `<td style=\"padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #d4edda; color: #155724; font-weight: ${field === 'risk' ? 'bold' : 'normal'};\">${enteredDisplay}</td>`;
                                            }

                                            const correctDisplay = detail.status === 'missing'
                                                ? 'Value Required'
                                                : 'Reference Not Matched';

                                            return `
                                                <td style=\"padding: 6px; border: 1px solid #dee2e6; text-align: center; background: #fbe9eb; font-weight: ${field === 'risk' ? 'bold' : 'normal'};\">
                                                    <div style=\"display: flex; flex-direction: column; gap: 4px; align-items: center;\">
                                                        <span style=\"color: #721c24; font-weight: 600;\">Entered: ${enteredDisplay}</span>
                                                        <span style=\"color: #155724; font-weight: 600;\">Correct: ${correctDisplay}</span>
                                                    </div>
                                                </td>
                                            `;
                                        }).join('')}
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            checkCSM() {
                // Reference CSM data (correct answers)
                const referenceData = this.getReferenceCSMData();

                const results = this.compareWithReference(referenceData);
                this.applyFormComparison(results);
                this.displayCheckResults(results);
            }

            clearFormComparisonHighlights() {
                this.lastComparisonResults = null;
                this.formFields.forEach(field => {
                    this.hazardRows.forEach((_, index) => {
                        const element = document.querySelector(`[data-field="${field}"][data-index="${index}"]`);
                        if (element) {
                            element.style.background = '';
                            element.style.borderColor = '';
                            element.removeAttribute('data-correct-value');
                            element.removeAttribute('data-entered-value');
                            element.removeAttribute('title');
                        }
                    });
                });
            }

            applyFormComparison(results) {
                this.clearFormComparisonHighlights();
                this.lastComparisonResults = results || null;
                if (!results || !Array.isArray(results.details)) {
                    return;
                }

                results.details.forEach(detail => {
                    const rowIndex = typeof detail.row === 'number' ? detail.row - 1 : null;
                    if (rowIndex === null || rowIndex < 0) return;

                    const fieldStatus = {};
                    if (Array.isArray(detail.fieldResults)) {
                        detail.fieldResults.forEach(result => {
                            fieldStatus[result.field] = result;
                        });
                    }

                    this.formFields.forEach(field => {
                        const element = document.querySelector(`[data-field="${field}"][data-index="${rowIndex}"]`);
                        if (!element) return;

                        const status = fieldStatus[field];

                        if (!status) {
                            if (detail.status === 'correct') {
                                element.style.background = '#d4edda';
                                element.style.borderColor = '#28a745';
                                element.title = 'Correct';
                            } else if (detail.status === 'missing') {
                                element.style.background = '#f8d7da';
                                element.style.borderColor = '#dc3545';
                                element.title = 'Missing entry';
                            } else if (detail.status === 'incorrect' && field === 'source') {
                                element.style.background = '#f8d7da';
                                element.style.borderColor = '#dc3545';
                                element.title = detail.message || 'Incorrect entry';
                            } else if (detail.status === 'incorrect') {
                                element.style.background = '#f8d7da';
                                element.style.borderColor = '#dc3545';
                                element.title = 'Incorrect entry';
                            }
                            return;
                        }

                        if (status.status === 'correct') {
                            element.style.background = '#d4edda';
                            element.style.borderColor = '#28a745';
                            element.title = 'Correct';
                        } else {
                            element.style.background = '#f8d7da';
                            element.style.borderColor = '#dc3545';
                            const entered = status.student && status.student.trim() ? status.student : 'Not set';
                            const correct = status.reference && status.reference.trim() ? status.reference : 'N/A';
                            element.title = `Entered: ${entered}\nCorrect: ${correct}`;
                        }
                    });
                });
            }

            compareWithReference(referenceData) {
                const results = {
                    correct: 0,
                    incorrect: 0,
                    missing: 0,
                    total: 0,
                    details: []
                };

                const referenceIndex = new Map();
                referenceData.forEach(ref => {
                    const key = this.normalizeValue(ref.source);
                    if (!referenceIndex.has(key)) {
                        referenceIndex.set(key, []);
                    }
                    referenceIndex.get(key).push(ref);
                });

                const fields = [
                    'source',
                    'environmentalMedium', 'healthThreat', 'exposureRoute',
                    'populationAffected', 'existingControls', 'frequencyDuration',
                    'severity', 'probability', 'risk'
                ];
                const matchingFields = fields.filter(field => field !== 'risk');

                this.hazardRows.forEach((studentRow, index) => {
                    const normalizedSource = this.normalizeValue(studentRow.source);
                    if (!normalizedSource) {
                        results.missing++;
                        results.details.push({
                            row: index + 1,
                            status: 'missing',
                            message: 'No data entered'
                        });
                        return;
                    }

                    const candidates = referenceIndex.get(normalizedSource) || [];
                    let referenceRow = null;
                    if (candidates.length === 1) {
                        referenceRow = candidates[0];
                    } else if (candidates.length > 1) {
                        referenceRow = this.findBestReferenceMatch(studentRow, candidates, matchingFields);
                    }

                    if (!referenceRow) {
                        results.incorrect++;
                        results.details.push({
                            row: index + 1,
                            status: 'incorrect',
                            message: `Unknown source: ${studentRow.source}`
                        });
                        return;
                    }

                    let rowCorrect = 0;
                    const rowTotal = fields.length;
                    const fieldResults = [];

                    fields.forEach(field => {
                        const studentValue = studentRow[field] || '';
                        const referenceValue = referenceRow[field] || '';
                        const studentNormalized = this.normalizeValue(studentValue);
                        const referenceNormalized = this.normalizeValue(referenceValue);
                        const isCorrect = studentNormalized !== '' && studentNormalized === referenceNormalized;
                        
                        if (isCorrect) {
                            rowCorrect++;
                            fieldResults.push({ field, status: 'correct', value: studentValue });
                        } else {
                            fieldResults.push({ 
                                field, 
                                status: 'incorrect', 
                                student: studentValue, 
                                reference: referenceValue 
                            });
                        }
                    });

                    if (rowCorrect === rowTotal) {
                        results.correct++;
                        results.details.push({
                            row: index + 1,
                            status: 'correct',
                            message: 'All fields correct',
                            source: studentRow.source
                        });
                    } else {
                        results.incorrect++;
                        results.details.push({
                            row: index + 1,
                            status: 'partial',
                            message: `${rowCorrect}/${rowTotal} fields correct`,
                            source: studentRow.source,
                            fieldResults: fieldResults
                        });
                    }

                    results.total++;
                });

                return results;
            }

            findBestReferenceMatch(studentRow, candidates, fields) {
                let best = candidates[0];
                let bestScore = this.calculateMatchScore(studentRow, best, fields);

                for (let i = 1; i < candidates.length; i++) {
                    const candidate = candidates[i];
                    const candidateScore = this.calculateMatchScore(studentRow, candidate, fields);
                    if (candidateScore > bestScore) {
                        best = candidate;
                        bestScore = candidateScore;
                    }
                }

                return best;
            }

            calculateMatchScore(studentRow, referenceRow, fields) {
                let score = 0;
                fields.forEach(field => {
                    const studentNormalized = this.normalizeValue(studentRow[field] || '');
                    const referenceNormalized = this.normalizeValue(referenceRow[field] || '');
                    if (studentNormalized !== '' && studentNormalized === referenceNormalized) {
                        score++;
                    }
                });
                return score;
            }

            displayCheckResults(results) {
                // Create modal with results
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    max-width: 1800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;

                const score = results.total > 0 ? Math.round((results.correct / results.total) * 100) : 0;
                const scoreColor = score >= 80 ? '#28a745' : score >= 60 ? '#ffc107' : '#dc3545';

                content.innerHTML = `
                    <h2 style="margin-top: 0; color: #333;">CSM Check Results</h2>
                    <div style="text-align: center; margin: 1rem 0;">
                        <div style="font-size: 2rem; font-weight: bold; color: ${scoreColor};">${score}%</div>
                        <div style="color: #666;">Overall Score</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                        <div style="text-align: center; padding: 1rem; background: #d4edda; border-radius: 4px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">${results.correct}</div>
                            <div style="color: #155724;">Correct</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fff3cd; border-radius: 4px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #856404;">${results.incorrect}</div>
                            <div style="color: #856404;">Incorrect</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f8d7da; border-radius: 4px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #721c24;">${results.missing}</div>
                            <div style="color: #721c24;">Missing</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 1rem 0;">
                        <div>
                            <h3 style="margin: 0 0 1rem 0; color: #28a745; text-align: center;">Correct CSM Form</h3>
                            <div style="max-height: 400px; overflow-y: auto; border: 2px solid #28a745; border-radius: 8px;">
                                ${this.generateCorrectCSMTable()}
                            </div>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 1rem 0; color: #dc3545; text-align: center;">Your CSM Form</h3>
                            <div style="max-height: 400px; overflow-y: auto; border: 2px solid #dc3545; border-radius: 8px;">
                                ${this.generateStudentCSMTable(results)}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button onclick="this.closest('.modal').remove()" style="
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 1rem;
                        ">Close</button>
                    </div>
                `;

                modal.className = 'modal';
                modal.appendChild(content);
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            generateCSV() {
                const headers = [
                    'Hazard ID', 'Source', 'Environmental Medium', 'Health Threat',
                    'Exposure Route', 'Population Affected', 'Existing Controls',
                    'Frequency/Duration', 'Severity', 'Probability', 'Risk'
                ];

                const rows = this.hazardRows.map(row => [
                    row.hazardId, row.source, row.environmentalMedium, row.healthThreat,
                    row.exposureRoute, row.populationAffected, row.existingControls,
                    row.frequencyDuration, row.severity, row.probability, row.risk
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(field => `"${field}"`).join(','))
                    .join('\n');

                return csvContent;
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const app = new OEHSAHazardMap();
            app.init();
            
            // Initialize CSM Form Manager
            window.csmFormManager = new CSMFormManager();
            
            // Add keyboard event listeners for arrow key navigation
            document.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    app.mapManager.navigateToHazard(-1);
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    app.mapManager.navigateToHazard(1);
                }
            });
            
            // Add global functions for debugging
            window.hazardMap = app;
            window.resetProximityCheck = () => {
                if (window.hazardMap) {
                    window.hazardMap.resetProximityCheck();
                }
            };
            
            // Debug functions
            window.__listAllPins = () => {
                console.log('[DEBUG] Listing all hazard pins:');
                app.viewer.entities.values.forEach(entity => {
                    if (entity.id && entity.id.startsWith('hazard-pin-')) {
                        const pos = entity.position.getValue(Cesium.JulianDate.now());
                        const cartographic = Cesium.Cartographic.fromCartesian(pos);
                        console.log(`  ${entity.id}: ${Cesium.Math.toDegrees(cartographic.latitude).toFixed(6)}¬∞N, ${Cesium.Math.toDegrees(cartographic.longitude).toFixed(6)}¬∞W, height: ${cartographic.height.toFixed(2)}m`);
                    }
                });
            };
            
            window.__testCoordinateConversion = () => {
                console.log('[DEBUG] Testing coordinate conversion:');
                const testCoords = [-12465909.864140745, 5030584.463040721];
                const converted = app.convertWebMercatorToWGS84(testCoords[0], testCoords[1]);
                console.log(`  Original (EPSG:3857): [${testCoords[0]}, ${testCoords[1]}]`);
                console.log(`  Converted (WGS84): [${converted[0].toFixed(6)}, ${converted[1].toFixed(6)}]`);
            };
            
            window.__debugClickHandlers = () => {
                console.log('[DEBUG] Checking click handlers on all pins:');
                app.viewer.entities.values.forEach(entity => {
                    if (entity.id && entity.id.startsWith('hazard-pin-')) {
                        console.log(`  ${entity.id}: clickHandler = ${entity.clickHandler ? 'ATTACHED' : 'MISSING'}`);
                        if (entity.clickHandler) {
                            console.log(`    Handler function: ${typeof entity.clickHandler}`);
                        }
                    }
                });
            };
            
            window.__testPinClick = () => {
                console.log('[DEBUG] Testing pin click manually...');
                const pins = app.viewer.entities.values.filter(entity => 
                    entity.id && entity.id.startsWith('hazard-pin-')
                );
                if (pins.length > 0) {
                    const firstPin = pins[0];
                    console.log(`Testing click on: ${firstPin.id}`);
                    if (firstPin.clickHandler) {
                        firstPin.clickHandler(firstPin);
                    } else {
                        console.log('No click handler attached to this pin!');
                    }
                } else {
                    console.log('No pins found!');
                }
            };

            window.__debugNavigation = () => {
                console.log('[DEBUG] Navigation State:');
                console.log('- Current hazard index:', app.currentHazardIndex);
                console.log('- Hazard data length:', app.hazardData ? app.hazardData.length : 'undefined');
                console.log('- Current hazard entity:', app.currentHazardEntity);
                if (app.hazardData && app.hazardData.length > 0) {
                    console.log('- Current hazard data:', app.hazardData[app.currentHazardIndex]);
                    console.log('- All hazard IDs:', app.hazardData.map(h => h.properties.hazard_id));
                }
                console.log('- All pin entities:', app.viewer.entities.values.filter(e => e.id && e.id.startsWith('hazard-pin-')).map(e => e.id));
            };

            window.__testNavigation = (direction) => {
                console.log(`[DEBUG] Testing navigation with direction: ${direction}`);
                app.navigateToHazard(direction);
            };
        });
    </script>
</body>
</html>
